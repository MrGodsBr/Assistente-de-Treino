<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fitness-Pro 2.0</title>
  <meta name="theme-color" content="#16a34a">
  <meta name="description" content="Fitness-Pro 2.0 - Assistente de nutrição e fitness">

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    #calorieProgress, #waterProgress, #weightProgress { transition: width 0.3s ease-in-out; }
    .modal-transition { transition: opacity 0.3s, transform 0.3s; }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .meal-section { border-top: 1px solid #e5e7eb; padding-top: 1rem; }
    .meal-section:first-child { border-top: none; padding-top: 0; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex flex-col items-center justify-start p-4 py-8">

  <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
    <div class="spinner rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600"></div>
    <p class="text-xl font-semibold text-green-700 mt-4">Conectando ao app...</p>
  </div>
  
  <div id="fullRegistrationModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="fullRegistrationModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <h3 class="text-2xl font-bold text-gray-800 text-center mb-4" id="regModalTitle">Crie sua Conta</h3>
    <p id="regError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

    <div class="space-y-4">
      <div class="flex flex-col items-center">
        <img id="regProfileImage" src="https://placehold.co/96x96/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-24 h-24 rounded-full object-cover shadow-lg mb-2 cursor-pointer" onclick="document.getElementById('regProfilePicInput').click()">
        <button type="button" onclick="document.getElementById('regProfilePicInput').click()" class="text-sm text-blue-600 hover:underline">Selecionar Foto</button>
        <input type="file" id="regProfilePicInput" class="hidden" accept="image/*">
      </div>

      <div>
        <label for="regUserNameInput" class="block text-sm font-medium text-gray-700">Nome de Usuário *</label>
        <input type="text" id="regUserNameInput" placeholder="Seu nome" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      
      <div id="registrationFields">
          <div>
            <label for="regEmailInput" class="block text-sm font-medium text-gray-700">Email *</label>
            <input type="email" id="regEmailInput" placeholder="seu.email@exemplo.com" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <div>
            <label for="regPasswordInput" class="block text-sm font-medium text-gray-700">Senha * (Mín. 6 caracteres)</label>
            <div class="relative mt-1">
              <input type="password" id="regPasswordInput" placeholder="Sua senha" class="w-full p-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
              <button type="button" onclick="togglePasswordVisibility('regPasswordInput')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                <svg id="regPasswordInput_eye" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: block;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7.25M12 5c4.478 0 8.268 2.943 9.543 7.25M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <svg id="regPasswordInput_eye_open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 19c-4.478 0-8.268-2.943-9.543-7.25C3.732 7.943 7.522 5 12 5s8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25z" />
                </svg>
              </button>
            </div>
          </div>
      </div>

      <div>
        <label for="regPhoneInput" class="block text-sm font-medium text-gray-700">Telefone (opcional)</label>
        <input type="tel" id="regPhoneInput" placeholder="(99) 99999-9999" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>

      <button id="registerAndProfileButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
        Criar Conta e Perfil
      </button>
      <button id="showLoginButton" class="w-full text-sm text-gray-600 font-medium py-2 mt-4 hover:text-gray-900">
        Já tenho conta. Fazer Login
      </button>
    </div>
  </div>

  <div id="loginModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="loginModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">Fazer Login</h3>
    <p id="loginError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

    <div class="space-y-4">
      <div>
        <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="loginEmail" placeholder="seu.email@exemplo.com" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Senha</label>
        <div class="relative mt-1">
          <input type="password" id="loginPassword" placeholder="Sua senha" class="w-full p-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          <button type="button" onclick="togglePasswordVisibility('loginPassword')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
            <svg id="loginPassword_eye" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: block;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7.25M12 5c4.478 0 8.268 2.943 9.543 7.25M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <svg id="loginPassword_eye_open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 19c-4.478 0-8.268-2.943-9.543-7.25C3.732 7.943 7.522 5 12 5s8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25z" />
            </svg>
          </button>
        </div>
      </div>
      <button id="loginSubmitButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
        Entrar
      </button>
      <button id="showRegistrationButton" class="w-full text-sm text-gray-600 font-medium py-2 mt-4 hover:text-gray-900">
        Não tenho conta. Criar Perfil
      </button>
    </div>
  </div>

  <div id="warningModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="warningModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
        <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mt-4">Meta Atingida!</h3>
      <p class="text-base text-gray-600 mt-2">Você ultrapassou sua meta de calorias do dia.</p>
      <p id="modalGoalText" class="text-sm text-gray-500 mt-1"></p>
      <button id="closeWarningModalButton" class="mt-6 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
        Entendi
      </button>
    </div>
  </div>

  <div id="mainApp" class="bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-xl space-y-6 hidden">

    <header class="flex justify-between items-center border-b pb-4">
      <h1 class="text-3xl font-bold text-green-600">Fitness-Pro 2.0</h1>
      <button id="shareAppButton" class="text-blue-600 p-2 rounded-full hover:bg-gray-100 transition-colors" title="Compartilhar o App">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.42" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
      </button>
    </header>

    <div id="userProfileDisplay" class="flex items-center space-x-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
      <img id="profileImageDisplay" src="https://placehold.co/64x64/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-16 h-16 rounded-full object-cover shadow-md">
      <div class="flex-grow">
        <span id="userNameDisplay" class="block text-xl font-semibold text-gray-800">Usuário</span>
        <button id="authControlButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors mt-1">
          Fazer Login / Criar Conta
        </button>
      </div>
      <button id="editProfileButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">Editar</button>
    </div>
    
    <details id="goalsDetails" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
      <summary class="text-xl font-semibold text-gray-700 cursor-pointer list-none">
        <div class="flex justify-between items-center text-green-600">
          <span>Minhas Metas</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </div>
      </summary>
      <div id="profileForm" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div>
          <label for="weight" class="block text-sm font-medium text-gray-700">Peso Atual (kg)</label>
          <input type="number" id="weight" placeholder="70" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="targetWeight" class="block text-sm font-medium text-gray-700">Meta Peso (kg)</label>
          <input type="number" id="targetWeight" placeholder="75" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="height" class="block text-sm font-medium text-gray-700">Altura (cm)</label>
          <input type="number" id="height" placeholder="175" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="age" class="block text-sm font-medium text-gray-700">Idade</label>
          <input type="number" id="age" placeholder="25" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="gender" class="block text-sm font-medium text-gray-700">Gênero</label>
          <select id="gender" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="male">Masculino</option>
            <option value="female">Feminino</option>
          </select>
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="activity" class="block text-sm font-medium text-gray-700">Nível de Atividade</label>
          <select id="activity" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="1.2">Sedentário (pouco ou nenhum)</option>
            <option value="1.375">Leve (1-3 dias/semana)</option>
            <option value="1.55" selected>Moderado (3-5 dias/semana)</option>
            <option value="1.725">Ativo (6-7 dias/semana)</option>
            <option value="1.9">Muito Ativo (trabalho físico + treino)</option>
          </select>
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="goalType" class="block text-sm font-medium text-gray-700">Meu Objetivo</label>
          <select id="goalType" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="ganhar">Ganhar Massa (Bulking)</option>
            <option value="manter">Manter Peso (Manutenção)</option>
            <option value="perder">Perder Peso (Cutting)</option>
          </select>
        </div>
        <button id="calculateButton" class="col-span-2 sm:col-span-3 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
          Calcular e Salvar Meta
        </button>
      </div>
      <p id="goalText" class="text-center text-lg font-semibold text-green-700 mt-4 hidden"></p>
    </details>
    <div id="addFoodSection">
      <h2 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Alimento</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-start">
        <div class="relative sm:col-span-3">
          <label for="foodSearch" class="block text-sm font-medium text-gray-700 mb-1">1. Pesquisar Alimento</label>
          <input
            type="text"
            id="foodSearch"
            placeholder="Digite o nome do alimento..."
            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
            autocomplete="off"
          >
          <div id="searchDropdown" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-56 overflow-y-auto"></div>
        </div>

        <div class="sm:col-span-2">
          <label for="mealTimeSelect" class="block text-sm font-medium text-gray-700 mb-1">2. Escolher Refeição</label>
          <select id="mealTimeSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
            <option value="cafe_da_manha">Café da Manhã</option>
            <option value="almoco">Almoço</option>
            <option value="lanche">Lanche</option>
            <option value="jantar">Jantar</option>
          </select>
        </div>

        <div class="sm:col-span-1">
          <label for="foodQuantity" class="block text-sm font-medium text-gray-700 mb-1">3. Qtd.</label>
          <input
            type="number"
            id="foodQuantity"
            placeholder="Qtd."
            min="0"
            step="0.1"
            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
          >
        </div>

        <div id="mealSuggestion" class="text-sm text-gray-600 mt-1 sm:col-span-3 px-1"></div>

        <button id="addFoodButton" class="sm:col-span-3 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-3">
          Adicionar Alimento
        </button>
        <button id="shareButton" class="sm:col-span-3 w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors mt-3">
          Compartilhar Resumo no WhatsApp
        </button>
      </div>
    </div>
    <div class="border-t border-gray-200 pt-4">
        <label for="dateSelector" class="block text-lg font-semibold text-gray-700 mb-2">Histórico:</label>
        <input type="date" id="dateSelector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
        <p id="dateStatus" class="text-sm text-gray-500 mt-1 text-center"></p>
    </div>
    <div id="hydrationTracker" class="border-t border-gray-200 pt-4 pb-4">
        <h2 class="text-xl font-semibold text-blue-600 mb-3">💧 Adicionar Hidratação</h2>
        <div class="flex items-end space-x-3 mb-4">
            <div class="flex-grow">
                <label for="waterQuantityInput" class="block text-sm font-medium text-gray-700">Qtd. de Água (ml)</label>
                <input
                    type="number"
                    id="waterQuantityInput"
                    placeholder="250"
                    min="50"
                    step="50"
                    value="250"
                    class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
            <button id="addWaterButton" class="h-10 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                Adicionar
            </button>
        </div>
    </div>
    <div class="border-b border-gray-200 py-4">
      <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center justify-between space-x-2">
        <span>Refeições do Dia:</span>
        <span id="goalTag" class="text-xs font-medium text-blue-700 bg-blue-100 py-0.5 px-2 rounded-full flex-shrink-0 hidden"></span>
      </h3>
      <div id="foodList" class="overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-4 bg-gray-50 min-h-48">
        <p id="emptyListText" class="text-gray-400 text-center mt-4">Nenhum alimento adicionado ainda.</p>
        <div id="water_container" class="mb-2 meal-section"> 
            <h4 class="font-semibold text-gray-700 mb-2 text-lg">💧 Registros de Água</h4>
            <div class="space-y-2" id="list-water"></div>
        </div>
        <div id="cafe_da_manha_container"></div>
        <div id="almoco_container"></div>
        <div id="lanche_container"></div>
        <div id="jantar_container"></div>
      </div>
      <p class="text-xs text-gray-500 mt-2">⚠️ indica alimentos que podem aumentar a gordura visceral.</p>
    </div>
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800 text-center">Resumo do Dia</h2>
      
      <div id="weightProgressSection">
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-indigo-600">Meta de Peso</span>
          <span id="weightGoalText" class="text-sm font-semibold text-indigo-600">0 kg / 0 kg</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="weightProgress" class="bg-indigo-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-blue-600">Água</span>
          <span id="waterGoalText" class="text-sm font-semibold text-blue-600">Consumo: 0 ml / Meta: 0 ml</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="waterProgress" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <div>
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-orange-600">Calorias</span>
          <span id="totalCalsGoalText" class="text-sm font-semibold text-orange-600">0 / 0 kcal</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="calorieProgress" class="bg-orange-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 text-center">
        <div>
          <p class="text-base font-medium text-emerald-600 mb-1">Proteínas</p>
          <p id="totalProteins" class="text-3xl font-bold text-emerald-600">0 g</p>
        </div>
        <div>
          <p class="text-base font-medium text-blue-600 mb-1">Carboidratos</p>
          <p id="totalCarbs" class="text-3xl font-bold text-blue-600">0 g</p>
        </div>
      </div>
    </div>
    </div>

  <footer class="mt-8 text-sm text-gray-500">Desenvolvido por Thiago</footer>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC9WSxM9GA64fq9lkLhsTyvMbD1AlO1MM4",
      authDomain: "assistente-de-treino-668ce.firebaseapp.com",
      projectId: "assistente-de-treino-668ce",
      storageBucket: "assistente-de-treino-668ce.firebasestorage.app",
      messagingSenderId: "878456748339",
      appId: "1:878456748339:web:5b310b5e91a7b23d0ba646",
      measurementId: "G-FCQ5CQT1WY"
    };

    let firebaseApp, firebaseAuth, firebaseDb, userId = null;

    // Variáveis globais
    let calorieGoal = 0;
    let waterGoal = 0; 
    let currentWeight = 0; 
    let targetWeight = 0; 
    let selectedFoodKey = null;
    let dailyLog = {}; 
    let waterLog = 0; 
    const TODAY = new Date(); 
    TODAY.setHours(0, 0, 0, 0); 
    const todayDateString = TODAY.toISOString().split('T')[0]; 
    
    let currentDateString = todayDateString; 
    
    let goalExceededNotified = false;
    let profilePicBase64 = null;
    let isEditingProfile = false;
    let currentGoalType = 'ganhar';
    let unsubscribeListener = null; 

    const MEAL_KEYS = ['cafe_da_manha', 'almoco', 'lanche', 'jantar'];
    const mealDisplayNames = {
      cafe_da_manha: "☕ Café da Manhã",
      almoco: "🍽️ Almoço",
      lanche: "🍎 Lanche",
      jantar: "🍲 Jantar",
    };
    const ALL_LOG_KEYS = ['water', ...MEAL_KEYS];

    const goalDisplayNames = {
      ganhar: 'Ganho de Massa',
      manter: 'Manutenção',
      perder: 'Perda de Peso'
    };

    const mealSuggestions = {
      ganhar: {
        cafe_da_manha: "Ex: Ovos, Aveia, Banana, Whey Protein.",
        almoco: "Ex: Arroz, Peito de Frango, Feijão, Batata Doce.",
        lanche: "Ex: Pão Integral, Pasta de Amendoim, Iogurte Grego.",
        jantar: "Ex: Macarrão, Carne Moída, Salada com Azeite.",
      },
      perder: {
        cafe_da_manha: "Ex: Ovos, Morangos, Café Preto, Iogurte Natural.",
        almoco: "Ex: Salada, Tilápia, Brócolis, Pouco Arroz Integral.",
        lanche: "Ex: Maçã, Queijo Minas, Castanhas (pouco).",
        jantar: "Ex: Sopa de legumes, Peito de Frango, Alface.",
      },
      manter: {
        cafe_da_manha: "Refeição balanceada. Ex: Pão Integral, Ovos, Mamão.",
        almoco: "Equilibre prato. Ex: Arroz, Feijão, Bife, Salada.",
        lanche: "Ex: Uvas, Iogurte, Aveia.",
        jantar: "Refeição leve. Ex: Batata Doce, Frango, Brócolis.",
      }
    };

    // Banco de dados de alimentos
    const foodDatabase = {
      'banana': { name: 'Banana', protein: 1.1, carbs: 27, cals: 105, unit: 'unidade', visceralFat: false },
      'maca': { name: 'Maçã', protein: 0.3, carbs: 25, cals: 95, unit: 'unidade', visceralFat: false },
      'abacate': { name: 'Abacate', protein: 2, carbs: 9, cals: 160, unit: '100g', visceralFat: false },
      'mamao': { name: 'Mamão Formosa', protein: 0.5, carbs: 11, cals: 43, unit: '100g', visceralFat: false },
      'melancia': { name: 'Melancia', protein: 0.6, carbs: 8, cals: 30, unit: '100g', visceralFat: false },
      'uva': { name: 'Uva', protein: 0.7, carbs: 18, cals: 69, unit: '100g', visceralFat: false },
      'laranja': { name: 'Laranja', protein: 1, carbs: 12, cals: 47, unit: 'unidade', visceralFat: false },
      'morango': { name: 'Morango', protein: 0.7, carbs: 8, cals: 32, unit: '100g', visceralFat: false },
      'brocolis': { name: 'Brócolis (cozido)', protein: 2.4, carbs: 7, cals: 35, unit: '100g', visceralFat: false },
      'alface': { name: 'Alface Crespa', protein: 1.4, carbs: 2.9, cals: 15, unit: '100g', visceralFat: false },
      'tomate': { name: 'Tomate', protein: 0.9, carbs: 3.9, cals: 18, unit: '100g', visceralFat: false },
      'peito_frango': { name: 'Peito de Frango (grelhado)', protein: 31, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
      'ovo': { name: 'Ovo Cozido', protein: 6.3, carbs: 0.6, cals: 77, unit: 'unidade', visceralFat: false },
      'ovo_frito': { name: 'Ovo Frito (em óleo)', protein: 6.2, carbs: 0.6, cals: 95, unit: 'unidade', visceralFat: false },
      'ovos_mexidos': { name: 'Ovos Mexidos (c/ manteiga)', protein: 6.5, carbs: 1.5, cals: 105, unit: 'unidade', visceralFat: true },
      'arroz_branco': { name: 'Arroz Branco (cozido)', protein: 2.7, carbs: 28, cals: 130, unit: '100g', visceralFat: false },
      'arroz_integral': { name: 'Arroz Integral (cozido)', protein: 2.6, carbs: 23, cals: 111, unit: '100g', visceralFat: false },
      'batata_doce': { name: 'Batata Doce (cozida)', protein: 1.6, carbs: 20, cals: 86, unit: '100g', visceralFat: false },
      'feijao_preto': { name: 'Feijão Preto (cozido)', protein: 9, carbs: 24, cals: 131, unit: '100g', visceralFat: false },
      'whey_protein': { name: 'Whey Protein', protein: 24, carbs: 3, cals: 120, unit: 'scoop 30g', visceralFat: false },
      'aveia': { name: 'Aveia em Flocos', protein: 17, carbs: 66, cals: 389, unit: '100g', visceralFat: false },
      'cafe_preto': { name: 'Café Preto (sem açúcar)', protein: 0.1, carbs: 0, cals: 2, unit: 'xícara', visceralFat: false },
      'refrigerante': { name: 'Refrigerante (Cola)', protein: 0, carbs: 26, cals: 105, unit: 'lata 350ml', visceralFat: true },
      'chocolate_ao_leite': { name: 'Chocolate ao Leite', protein: 8, carbs: 59, cals: 535, unit: '100g', visceralFat: true },
      'pizza_mussarela': { name: 'Pizza Mussarela', protein: 11, carbs: 33, cals: 271, unit: '100g', visceralFat: true },
    };

    // Helpers Firebase
    function getDayRef(uid, date) {
      return firebaseDb.collection('users').doc(uid).collection('days').doc(date);
    }
    function getItemsRef(uid, date) {
      return getDayRef(uid, date).collection('items');
    }
    function getProfileDocRef() { 
      return firebaseDb.collection('users').doc(userId).collection('data').doc('profile'); 
    }
    function getMetasDocRef() { 
      return firebaseDb.collection('users').doc(userId).collection('data').doc('metas'); 
    }

    // Helpers de UI
    function showElement(el){ el.classList.remove('hidden'); }
    function hideElement(el){ el.classList.add('hidden'); }
    function showModal(modal, overlay){ 
      showElement(overlay); 
      showElement(modal); 
      requestAnimationFrame(()=>{ 
        modal.classList.remove('scale-90','opacity-0'); 
        modal.classList.add('scale-100','opacity-100');
      }); 
    }
    function hideModal(modal, overlay){ 
      modal.classList.remove('scale-100','opacity-100'); 
      modal.classList.add('scale-90','opacity-0'); 
      setTimeout(()=>{ 
        hideElement(modal); 
        hideElement(overlay); 
        clearRegError(); 
        clearLoginError();
      }, 250); 
    }
    
    function showRegError(message){ 
      const el=document.getElementById('regError'); 
      el.textContent=message; 
      showElement(el); 
    }
    function clearRegError(){ 
      const el=document.getElementById('regError'); 
      el.textContent=''; 
      hideElement(el); 
    }
    
    function showLoginError(message){ 
      const el=document.getElementById('loginError'); 
      el.textContent=message; 
      showElement(el); 
    }
    function clearLoginError(){ 
      const el=document.getElementById('loginError'); 
      el.textContent=''; 
      hideElement(el); 
    }

    function fileToBase64(file){ 
      return new Promise((resolve,reject)=>{ 
        const r=new FileReader(); 
        r.onload=()=>resolve(r.result); 
        r.onerror=e=>reject(e); 
        r.readAsDataURL(file); 
      }); 
    }

    function saveProfilePicLocally(){ 
      if(profilePicBase64){ 
        localStorage.setItem(`profilePic_${userId}`, profilePicBase64); 
        document.getElementById('profileImageDisplay').src=profilePicBase64; 
        document.getElementById('regProfileImage').src=profilePicBase64; 
      } 
    }

    function loadProfilePicLocally(){ 
      const pic=localStorage.getItem(`profilePic_${userId}`); 
      if(pic){ 
        profilePicBase64=pic; 
        document.getElementById('profileImageDisplay').src=pic; 
        document.getElementById('regProfileImage').src=pic; 
      } 
    }
    
    function togglePasswordVisibility(fieldId) {
        const input = document.getElementById(fieldId);
        const eye = document.getElementById(fieldId + '_eye');
        const eyeOpen = document.getElementById(fieldId + '_eye_open');

        if (input.type === 'password') {
            input.type = 'text';
            hideElement(eye);
            showElement(eyeOpen);
        } else {
            input.type = 'password';
            showElement(eye);
            hideElement(eyeOpen);
        }
    }

    // Continua na próxima parte devido ao limite de caracteres...
    // Inicialização do Firebase
    document.addEventListener('DOMContentLoaded', function() {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      firebaseAuth = firebase.auth();
      firebaseDb = firebase.firestore();

      // Listeners de autenticação
      firebaseAuth.onAuthStateChanged(user => {
        if (user) {
          userId = user.uid;
          loadUserData();
        } else {
          userId = null;
          showRegistrationModal(false);
        }
        setTimeout(() => {
          document.getElementById('loadingScreen').style.opacity = '0';
          setTimeout(() => hideElement(document.getElementById('loadingScreen')), 500);
          showElement(document.getElementById('mainApp'));
        }, 1000);
      });

      // Event listeners
      document.getElementById('registerAndProfileButton').addEventListener('click', handleRegistration);
      document.getElementById('loginSubmitButton').addEventListener('click', handleLogin);
      document.getElementById('showLoginButton').addEventListener('click', () => {
        hideModal(document.getElementById('fullRegistrationModal'), document.getElementById('fullRegistrationModalOverlay'));
        showModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
      });
      document.getElementById('showRegistrationButton').addEventListener('click', () => {
        hideModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
        showRegistrationModal(false);
      });
      document.getElementById('editProfileButton').addEventListener('click', () => showRegistrationModal(true));
      document.getElementById('calculateButton').addEventListener('click', calculateGoal);
      document.getElementById('addFoodButton').addEventListener('click', addFood);
      document.getElementById('addWaterButton').addEventListener('click', addWater);
      document.getElementById('shareButton').addEventListener('click', shareToWhatsApp);
      document.getElementById('shareAppButton').addEventListener('click', shareApp);
      document.getElementById('dateSelector').addEventListener('change', handleDateChange);
      document.getElementById('regProfilePicInput').addEventListener('change', handleProfilePicChange);
      document.getElementById('foodSearch').addEventListener('input', handleFoodSearch);
      document.getElementById('mealTimeSelect').addEventListener('change', updateMealSuggestion);
      document.getElementById('goalType').addEventListener('change', (e) => {
        currentGoalType = e.target.value;
        updateMealSuggestion();
      });
      document.getElementById('closeWarningModalButton').addEventListener('click', () => {
        hideModal(document.getElementById('warningModal'), document.getElementById('warningModalOverlay'));
      });
    });

    function showRegistrationModal(isEdit = false) {
        isEditingProfile = isEdit;
        const modal = document.getElementById('fullRegistrationModal');
        const overlay = document.getElementById('fullRegistrationModalOverlay');
        
        clearRegError();
        document.getElementById('regModalTitle').textContent = isEdit ? 'Editar Perfil' : 'Crie sua Conta';
        
        const regFields = document.getElementById('registrationFields');
        const saveButton = document.getElementById('registerAndProfileButton');
        const showLogin = document.getElementById('showLoginButton');
        
        if (isEdit) {
            hideElement(regFields);
            hideElement(showLogin);
            saveButton.textContent = 'Salvar Alterações';
            // Carregar dados atuais
            document.getElementById('regUserNameInput').value = document.getElementById('userNameDisplay').textContent;
        } else {
            showElement(regFields);
            showElement(showLogin);
            saveButton.textContent = 'Criar Conta e Perfil';
            // Limpar campos
            document.getElementById('regUserNameInput').value = '';
            document.getElementById('regEmailInput').value = '';
            document.getElementById('regPasswordInput').value = '';
            document.getElementById('regPhoneInput').value = '';
        }
        
        showModal(modal, overlay);
    }

    async function handleRegistration() {
        const userName = document.getElementById('regUserNameInput').value.trim();
        
        if (!userName) {
            showRegError('Por favor, preencha o nome de usuário.');
            return;
        }

        if (isEditingProfile) {
            // Atualizar perfil existente
            try {
                await getProfileDocRef().set({
                    userName: userName,
                    phone: document.getElementById('regPhoneInput').value.trim()
                }, { merge: true });
                
                document.getElementById('userNameDisplay').textContent = userName;
                saveProfilePicLocally();
                hideModal(document.getElementById('fullRegistrationModal'), document.getElementById('fullRegistrationModalOverlay'));
                alert('Perfil atualizado com sucesso!');
            } catch (error) {
                showRegError('Erro ao atualizar perfil: ' + error.message);
            }
        } else {
            // Criar nova conta
            const email = document.getElementById('regEmailInput').value.trim();
            const password = document.getElementById('regPasswordInput').value;
            
            if (!email || !password) {
                showRegError('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            if (password.length < 6) {
                showRegError('A senha deve ter no mínimo 6 caracteres.');
                return;
            }

            try {
                const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                userId = userCredential.user.uid;
                
                await getProfileDocRef().set({
                    userName: userName,
                    email: email,
                    phone: document.getElementById('regPhoneInput').value.trim(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('userNameDisplay').textContent = userName;
                saveProfilePicLocally();
                hideModal(document.getElementById('fullRegistrationModal'), document.getElementById('fullRegistrationModalOverlay'));
                loadUserData();
            } catch (error) {
                showRegError('Erro ao criar conta: ' + error.message);
            }
        }
    }

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            showLoginError('Por favor, preencha todos os campos.');
            return;
        }

        try {
            await firebaseAuth.signInWithEmailAndPassword(email, password);
            hideModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
        } catch (error) {
            showLoginError('Erro ao fazer login: ' + error.message);
        }
    }

    async function handleProfilePicChange(e) {
        const file = e.target.files[0];
        if (file) {
            try {
                profilePicBase64 = await fileToBase64(file);
                document.getElementById('regProfileImage').src = profilePicBase64;
            } catch (error) {
                alert('Erro ao carregar imagem: ' + error.message);
            }
        }
    }

    async function loadUserData() {
        try {
            const profileDoc = await getProfileDocRef().get();
            if (profileDoc.exists) {
                const data = profileDoc.data();
                document.getElementById('userNameDisplay').textContent = data.userName || 'Usuário';
            }
            
            const metasDoc = await getMetasDocRef().get();
            if (metasDoc.exists) {
                const data = metasDoc.data();
                calorieGoal = data.calorieGoal || 0;
                waterGoal = data.waterGoal || 0;
                currentWeight = data.currentWeight || 0;
                targetWeight = data.targetWeight || 0;
                currentGoalType = data.goalType || 'ganhar';
                
                document.getElementById('weight').value = currentWeight;
                document.getElementById('targetWeight').value = targetWeight;
                document.getElementById('height').value = data.height || '';
                document.getElementById('age').value = data.age || '';
                document.getElementById('gender').value = data.gender || 'male';
                document.getElementById('activity').value = data.activity || '1.55';
                document.getElementById('goalType').value = currentGoalType;
                
                if (calorieGoal > 0) {
                    document.getElementById('goalText').textContent = `Meta: ${calorieGoal} kcal/dia (${goalDisplayNames[currentGoalType]})`;
                    showElement(document.getElementById('goalText'));
                    document.getElementById('goalTag').textContent = goalDisplayNames[currentGoalType];
                    showElement(document.getElementById('goalTag'));
                }
            }
            
            loadProfilePicLocally();
            document.getElementById('dateSelector').value = todayDateString;
            loadDailyLog();
            updateAuthButton();
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
        }
    }

    function updateAuthButton() {
        const btn = document.getElementById('authControlButton');
        if (userId) {
            btn.textContent = 'Sair';
            btn.onclick = () => firebaseAuth.signOut();
        } else {
            btn.textContent = 'Fazer Login / Criar Conta';
            btn.onclick = () => showRegistrationModal(false);
        }
    }

    async function calculateGoal() {
        const weight = parseFloat(document.getElementById('weight').value);
        const targetW = parseFloat(document.getElementById('targetWeight').value);
        const height = parseFloat(document.getElementById('height').value);
        const age = parseFloat(document.getElementById('age').value);
        const gender = document.getElementById('gender').value;
        const activity = parseFloat(document.getElementById('activity').value);
        const goalType = document.getElementById('goalType').value;

        if (!weight || !targetW || !height || !age) {
            alert('Por favor, preencha todos os campos de metas.');
            return;
        }

        // Fórmula de Harris-Benedict
        let bmr;
        if (gender === 'male') {
            bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
        } else {
            bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
        }

        let tdee = bmr * activity;

        // Ajustar baseado no objetivo
        if (goalType === 'ganhar') {
            calorieGoal = Math.round(tdee + 300);
        } else if (goalType === 'perder') {
            calorieGoal = Math.round(tdee - 500);
        } else {
            calorieGoal = Math.round(tdee);
        }

        currentWeight = weight;
        targetWeight = targetW;
        currentGoalType = goalType;
        waterGoal = Math.round(weight * 35); // 35ml por kg

        try {
            await getMetasDocRef().set({
                calorieGoal: calorieGoal,
                waterGoal: waterGoal,
                currentWeight: currentWeight,
                targetWeight: targetWeight,
                height: height,
                age: age,
                gender: gender,
                activity: activity,
                goalType: goalType,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('goalText').textContent = `Meta: ${calorieGoal} kcal/dia (${goalDisplayNames[currentGoalType]})`;
            showElement(document.getElementById('goalText'));
            document.getElementById('goalTag').textContent = goalDisplayNames[currentGoalType];
            showElement(document.getElementById('goalTag'));
            
            updateProgress();
            updateMealSuggestion();
            alert('Metas calculadas e salvas com sucesso!');
        } catch (error) {
            alert('Erro ao salvar metas: ' + error.message);
        }
    }

    function handleFoodSearch(e) {
        const query = e.target.value.toLowerCase().trim();
        const dropdown = document.getElementById('searchDropdown');
        
        if (query.length === 0) {
            hideElement(dropdown);
            return;
        }

        const matches = Object.keys(foodDatabase).filter(key => 
            foodDatabase[key].name.toLowerCase().includes(query)
        );

        if (matches.length === 0) {
            dropdown.innerHTML = '<div class="p-3 text-gray-500">Nenhum alimento encontrado</div>';
            showElement(dropdown);
            return;
        }

        dropdown.innerHTML = matches.map(key => {
            const food = foodDatabase[key];
            return `<div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200" onclick="selectFood('${key}')">
                <div class="font-medium text-gray-800">${food.name}</div>
                <div class="text-xs text-gray-500">${food.cals} kcal • ${food.protein}g prot • ${food.carbs}g carb por ${food.unit}</div>
            </div>`;
        }).join('');
        
        showElement(dropdown);
    }

    function selectFood(key) {
        selectedFoodKey = key;
        const food = foodDatabase[key];
        document.getElementById('foodSearch').value = food.name;
        hideElement(document.getElementById('searchDropdown'));
        document.getElementById('foodQuantity').value = '1';
        document.getElementById('foodQuantity').focus();
    }

    function updateMealSuggestion() {
        const mealTime = document.getElementById('mealTimeSelect').value;
        const suggestion = mealSuggestions[currentGoalType][mealTime];
        document.getElementById('mealSuggestion').textContent = suggestion || '';
    }

    async function addFood() {
        if (!selectedFoodKey) {
            alert('Por favor, selecione um alimento primeiro.');
            return;
        }

        const quantity = parseFloat(document.getElementById('foodQuantity').value);
        if (!quantity || quantity <= 0) {
            alert('Por favor, insira uma quantidade válida.');
            return;
        }

        const mealTime = document.getElementById('mealTimeSelect').value;
        const food = foodDatabase[selectedFoodKey];

        const item = {
            foodKey: selectedFoodKey,
            name: food.name,
            protein: food.protein * quantity,
            carbs: food.carbs * quantity,
            cals: food.cals * quantity,
            quantity: quantity,
            unit: food.unit,
            mealTime: mealTime,
            visceralFat: food.visceralFat,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await getItemsRef(userId, currentDateString).add(item);
            
            // Limpar campos
            document.getElementById('foodSearch').value = '';
            document.getElementById('foodQuantity').value = '';
            selectedFoodKey = null;
            
            alert('Alimento adicionado com sucesso!');
        } catch (error) {
            alert('Erro ao adicionar alimento: ' + error.message);
        }
    }

    async function addWater() {
        const quantity = parseFloat(document.getElementById('waterQuantityInput').value);
        if (!quantity || quantity <= 0) {
            alert('Por favor, insira uma quantidade válida.');
            return;
        }

        const item = {
            mealTime: 'water',
            quantity: quantity,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await getItemsRef(userId, currentDateString).add(item);
            alert(`${quantity}ml de água adicionado!`);
        } catch (error) {
            alert('Erro ao adicionar água: ' + error.message);
        }
    }

    async function loadDailyLog() {
        if (!userId) return;

        // Cancelar listener anterior
        if (unsubscribeListener) {
            unsubscribeListener();
        }

        // Resetar dados
        dailyLog = { water: [], cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
        waterLog = 0;

        // Criar listener em tempo real
        unsubscribeListener = getItemsRef(userId, currentDateString).onSnapshot(snapshot => {
            dailyLog = { water: [], cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
            waterLog = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                data.id = doc.id;
                
                if (data.mealTime === 'water') {
                    waterLog += data.quantity;
                    dailyLog.water.push(data);
                } else if (MEAL_KEYS.includes(data.mealTime)) {
                    dailyLog[data.mealTime].push(data);
                }
            });

            renderFoodList();
            updateProgress();
            checkCalorieGoal();
        });

        updateDateStatus();
    }

    function renderFoodList() {
        const emptyText = document.getElementById('emptyListText');
        let hasItems = false;

        // Renderizar água
        const waterContainer = document.getElementById('list-water');
        if (dailyLog.water.length > 0) {
            hasItems = true;
            waterContainer.innerHTML = dailyLog.water.map(item => `
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                    <span class="text-gray-700">💧 ${item.quantity} ml</span>
                    <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-800 font-medium text-sm">
                        Excluir
                    </button>
                </div>
            `).join('');
        } else {
            waterContainer.innerHTML = '<p class="text-gray-400 text-sm">Nenhum registro de água</p>';
        }

        // Renderizar refeições
        MEAL_KEYS.forEach(mealKey => {
            const container = document.getElementById(`${mealKey}_container`);
            if (dailyLog[mealKey].length > 0) {
                hasItems = true;
                container.innerHTML = `
                    <h4 class="font-semibold text-gray-700 mb-2 text-lg">${mealDisplayNames[mealKey]}</h4>
                    <div class="space-y-2">
                        ${dailyLog[mealKey].map(item => `
                            <div class="flex justify-between items-start bg-white p-3 rounded-lg shadow-sm">
                                <div class="flex-grow">
                                    <div class="font-medium text-gray-800">
                                        ${item.name} ${item.visceralFat ? '⚠️' : ''}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${item.quantity} ${item.unit} • ${Math.round(item.cals)} kcal • 
                                        ${Math.round(item.protein)}g prot • ${Math.round(item.carbs)}g carb
                                    </div>
                                </div>
                                <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-800 font-medium text-sm ml-2">
                                    Excluir
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                showElement(container);
                container.classList.add('meal-section');
            } else {
                hideElement(container);
            }
        });

        if (hasItems) {
            hideElement(emptyText);
        } else {
            showElement(emptyText);
        }
    }

    async function deleteItem(itemId) {
        if (!confirm('Deseja realmente excluir este item?')) return;

        try {
            await getItemsRef(userId, currentDateString).doc(itemId).delete();
        } catch (error) {
            alert('Erro ao excluir item: ' + error.message);
        }
    }

    function updateProgress() {
        let totalCals = 0;
        let totalProtein = 0;
        let totalCarbs = 0;

        MEAL_KEYS.forEach(mealKey => {
            dailyLog[mealKey].forEach(item => {
                totalCals += item.cals;
                totalProtein += item.protein;
                totalCarbs += item.carbs;
            });
        });

        // Atualizar displays
        document.getElementById('totalProteins').textContent = `${Math.round(totalProtein)} g`;
        document.getElementById('totalCarbs').textContent = `${Math.round(totalCarbs)} g`;
        document.getElementById('totalCalsGoalText').textContent = `${Math.round(totalCals)} / ${calorieGoal} kcal`;
        document.getElementById('waterGoalText').textContent = `Consumo: ${waterLog} ml / Meta: ${waterGoal} ml`;
        document.getElementById('weightGoalText').textContent = `${currentWeight} kg / ${targetWeight} kg`;

        // Atualizar barras de progresso
        const caloriePercent = Math.min((totalCals / calorieGoal) * 100, 100);
        document.getElementById('calorieProgress').style.width = `${caloriePercent}%`;

        const waterPercent = Math.min((waterLog / waterGoal) * 100, 100);
        document.getElementById('waterProgress').style.width = `${waterPercent}%`;

        const weightDiff = Math.abs(targetWeight - currentWeight);
        const weightPercent = weightDiff === 0 ? 100 : Math.min(((Math.abs(targetWeight - currentWeight) / weightDiff) * 100), 100);
        document.getElementById('weightProgress').style.width = `${weightPercent}%`;
    }

    function checkCalorieGoal() {
        if (goalExceededNotified || calorieGoal === 0) return;

        let totalCals = 0;
        MEAL_KEYS.forEach(mealKey => {
            dailyLog[mealKey].forEach(item => {
                totalCals += item.cals;
            });
        });

        if (totalCals > calorieGoal) {
            goalExceededNotified = true;
            document.getElementById('modalGoalText').textContent = `Meta: ${calorieGoal} kcal | Consumido: ${Math.round(totalCals)} kcal`;
            showModal(document.getElementById('warningModal'), document.getElementById('warningModalOverlay'));
        }
    }

    function handleDateChange(e) {
        const newDate = e.target.value;
        if (newDate !== currentDateString) {
            currentDateString = newDate;
            goalExceededNotified = false;
            loadDailyLog();
        }
    }

    function updateDateStatus() {
        const selected = new Date(currentDateString + 'T00:00:00');
        const today = new Date(todayDateString + 'T00:00:00');
        const diff = (today - selected) / (1000 * 60 * 60 * 24);

        if (diff === 0) {
            document.getElementById('dateStatus').textContent = 'Hoje';
        } else if (diff === 1) {
            document.getElementById('dateStatus').textContent = 'Ontem';
        } else if (diff > 1) {
            document.getElementById('dateStatus').textContent = `${Math.round(diff)} dias atrás`;
        } else {
            document.getElementById('dateStatus').textContent = `${Math.abs(Math.round(diff))} dias no futuro`;
        }
    }

    function shareToWhatsApp() {
        let totalCals = 0;
        let totalProtein = 0;
        let totalCarbs = 0;

        MEAL_KEYS.forEach(mealKey => {
            dailyLog[mealKey].forEach(item => {
                totalCals += item.cals;
                totalProtein += item.protein;
                totalCarbs += item.carbs;
            });
        });

        const message = `🏋️ *Fitness-Pro 2.0* - Resumo do Dia\n\n` +
            `📊 *Totais:*\n` +
            `• Calorias: ${Math.round(totalCals)} / ${calorieGoal} kcal\n` +
            `• Proteínas: ${Math.round(totalProtein)}g\n` +
            `• Carboidratos: ${Math.round(totalCarbs)}g\n` +
            `• Água: ${waterLog} / ${waterGoal} ml\n\n` +
            `🎯 Objetivo: ${goalDisplayNames[currentGoalType]}\n` +
            `⚖️ Peso: ${currentWeight}kg → ${targetWeight}kg`;

        const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }

    function shareApp() {
        const message = `Conheça o Fitness-Pro 2.0! 💪\n\n` +
            `Um assistente completo de nutrição e fitness para alcançar seus objetivos.\n\n` +
            `Recursos:\n` +
            `✅ Cálculo de calorias e macros\n` +
            `✅ Controle de hidratação\n` +
            `✅ Histórico de refeições\n` +
            `✅ Sincronização em nuvem\n\n` +
            `Acesse agora: [ADICIONE SUA URL AQUI]`;

        if (navigator.share) {
            navigator.share({
                title: 'Fitness-Pro 2.0',
                text: message
            });
        } else {
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }
    }
  </script>
</body>
</html>
