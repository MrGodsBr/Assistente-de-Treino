<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fitness-Pro 2.0</title>
  <meta name="theme-color" content="#16a34a">
  <meta name="description" content="Fitness-Pro 2.0 - Assistente de nutrição e fitness">

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    #calorieProgress, #waterProgress, #weightProgress { transition: width 0.3s ease-in-out; }
    .modal-transition { transition: opacity 0.3s, transform 0.3s; }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    /* Estilos para a nova estrutura de lista */
    .meal-section { border-top: 1px solid #e5e7eb; padding-top: 1rem; }
    .meal-section:first-child { border-top: none; padding-top: 0; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex flex-col items-center justify-start p-4 py-8">

  <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
    <div class="spinner rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600"></div>
    <p class="text-xl font-semibold text-green-700 mt-4">Conectando ao app...</p>
  </div>
  
  <div id="fullRegistrationModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="fullRegistrationModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <h3 class="text-2xl font-bold text-gray-800 text-center mb-4" id="regModalTitle">Crie sua Conta</h3>
    <p id="regError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

    <div class="space-y-4">
      <div class="flex flex-col items-center">
        <img id="regProfileImage" src="https://placehold.co/96x96/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-24 h-24 rounded-full object-cover shadow-lg mb-2 cursor-pointer" onclick="document.getElementById('regProfilePicInput').click()">
        <button type="button" onclick="document.getElementById('regProfilePicInput').click()" class="text-sm text-blue-600 hover:underline">Selecionar Foto</button>
        <input type="file" id="regProfilePicInput" class="hidden" accept="image/*">
      </div>

      <div>
        <label for="regUserNameInput" class="block text-sm font-medium text-gray-700">Nome de Usuário *</label>
        <input type="text" id="regUserNameInput" placeholder="Seu nome" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      
      <div id="registrationFields">
          <div>
            <label for="regEmailInput" class="block text-sm font-medium text-gray-700">Email *</label>
            <input type="email" id="regEmailInput" placeholder="seu.email@exemplo.com" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <div>
            <label for="regPasswordInput" class="block text-sm font-medium text-gray-700">Senha * (Mín. 6 caracteres)</label>
            <div class="relative mt-1">
              <input type="password" id="regPasswordInput" placeholder="Sua senha" class="w-full p-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
              <button type="button" onclick="togglePasswordVisibility('regPasswordInput')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                <svg id="regPasswordInput_eye" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: block;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7.25M17.5 14.5c.89 0 1.611-.72 1.611-1.611s-.72-1.611-1.61-1.611-1.61.72-1.61 1.611.72 1.611 1.611 1.611zM12 5c4.478 0 8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25-4.478 0-8.268-2.943-9.543-7.25 1.275-4.307 5.065-7.25 9.543-7.25zm0 0a3 3 0 100 6 3 3 0 000-6z" />
                </svg>
                <svg id="regPasswordInput_eye_open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 19c-4.478 0-8.268-2.943-9.543-7.25C3.732 7.943 7.522 5 12 5s8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25z" />
                </svg>
              </button>
            </div>
          </div>
      </div>

      <div>
        <label for="regPhoneInput" class="block text-sm font-medium text-gray-700">Telefone (opcional)</label>
        <input type="tel" id="regPhoneInput" placeholder="(99) 99999-9999" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>

      <button id="registerAndProfileButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
        Criar Conta e Perfil
      </button>
      <button id="showLoginButton" class="w-full text-sm text-gray-600 font-medium py-2 mt-4 hover:text-gray-900">
        Já tenho conta. Fazer Login
      </button>
    </div>
  </div>

  <div id="loginModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="loginModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">Fazer Login</h3>
    <p id="loginError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

    <div class="space-y-4">
      <div>
        <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="loginEmail" placeholder="seu.email@exemplo.com" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Senha</label>
        <div class="relative mt-1">
          <input type="password" id="loginPassword" placeholder="Sua senha" class="w-full p-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          <button type="button" onclick="togglePasswordVisibility('loginPassword')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
            <svg id="loginPassword_eye" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: block;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7.25M17.5 14.5c.89 0 1.611-.72 1.611-1.611s-.72-1.611-1.61-1.611-1.61.72-1.61 1.611.72 1.611 1.611 1.611zM12 5c4.478 0 8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25-4.478 0-8.268-2.943-9.543-7.25 1.275-4.307 5.065-7.25 9.543-7.25zm0 0a3 3 0 100 6 3 3 0 000-6z" />
            </svg>
            <svg id="loginPassword_eye_open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 19c-4.478 0-8.268-2.943-9.543-7.25C3.732 7.943 7.522 5 12 5s8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25z" />
            </svg>
          </button>
        </div>
      </div>
      <button id="loginSubmitButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
        Entrar
      </button>
      <button id="showRegistrationButton" class="w-full text-sm text-gray-600 font-medium py-2 mt-4 hover:text-gray-900">
        Não tenho conta. Criar Perfil
      </button>
    </div>
  </div>


  <div id="warningModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="warningModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
        <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mt-4">Meta Atingida!</h3>
      <p class="text-base text-gray-600 mt-2">Você ultrapassou sua meta de calorias do dia.</p>
      <p id="modalGoalText" class="text-sm text-gray-500 mt-1"></p>
      <button id="closeWarningModalButton" class="mt-6 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
        Entendi
      </button>
    </div>
  </div>

  <div id="mainApp" class="bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-xl space-y-6 hidden">

    <header class="flex justify-between items-center border-b pb-4">
      <h1 class="text-3xl font-bold text-green-600">Fitness-Pro 2.0</h1>
      <button id="shareAppButton" class="text-blue-600 p-2 rounded-full hover:bg-gray-100 transition-colors" title="Compartilhar o App">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.42" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
      </button>
    </header>

    <div id="userProfileDisplay" class="flex items-center space-x-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
      <img id="profileImageDisplay" src="https://placehold.co/64x64/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-16 h-16 rounded-full object-cover shadow-md">
      <div class="flex-grow">
        <span id="userNameDisplay" class="block text-xl font-semibold text-gray-800">Visitante</span>
        <button id="authControlButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors mt-1">
          Fazer Login / Criar Conta
        </button>
      </div>
      <button id="editProfileButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">Editar</button>
    </div>
    
    <details id="goalsDetails" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
      <summary class="text-xl font-semibold text-gray-700 cursor-pointer list-none">
        <div class="flex justify-between items-center text-green-600">
          <span>Minhas Metas</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </div>
      </summary>
      <div id="profileForm" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div>
          <label for="weight" class="block text-sm font-medium text-gray-700">Peso Atual (kg)</label>
          <input type="number" id="weight" placeholder="70" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="targetWeight" class="block text-sm font-medium text-gray-700">Meta Peso (kg)</label>
          <input type="number" id="targetWeight" placeholder="75" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="height" class="block text-sm font-medium text-gray-700">Altura (cm)</label>
          <input type="number" id="height" placeholder="175" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="age" class="block text-sm font-medium text-gray-700">Idade</label>
          <input type="number" id="age" placeholder="25" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="gender" class="block text-sm font-medium text-gray-700">Gênero</label>
          <select id="gender" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="male">Masculino</option>
            <option value="female">Feminino</option>
          </select>
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="activity" class="block text-sm font-medium text-gray-700">Nível de Atividade</label>
          <select id="activity" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="1.2">Sedentário (pouco ou nenhum)</option>
            <option value="1.375">Leve (1-3 dias/semana)</option>
            <option value="1.55" selected>Moderado (3-5 dias/semana)</option>
            <option value="1.725">Ativo (6-7 dias/semana)</option>
            <option value="1.9">Muito Ativo (trabalho físico + treino)</option>
          </select>
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="goalType" class="block text-sm font-medium text-gray-700">Meu Objetivo</label>
          <select id="goalType" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="ganhar">Ganhar Massa (Bulking)</option>
            <option value="manter">Manter Peso (Manutenção)</option>
            <option value="perder">Perder Peso (Cutting)</option>
          </select>
        </div>
        <button id="calculateButton" class="col-span-2 sm:col-span-3 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
          Calcular e Salvar Meta
        </button>
      </div>
      <p id="goalText" class="text-center text-lg font-semibold text-green-700 mt-4 hidden"></p>
    </details>
    <div id="addFoodSection">
      <h2 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Alimento</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-start">
        <div class="relative sm:col-span-3">
          <label for="foodSearch" class="block text-sm font-medium text-gray-700 mb-1">1. Pesquisar Alimento</label>
          <input
            type="text"
            id="foodSearch"
            placeholder="Digite o nome do alimento..."
            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
            autocomplete="off"
          >
          <div id="searchDropdown" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-56 overflow-y-auto"></div>
        </div>

        <div class="sm:col-span-2">
          <label for="mealTimeSelect" class="block text-sm font-medium text-gray-700 mb-1">2. Escolher Refeição</label>
          <select id="mealTimeSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
            <option value="cafe_da_manha">Café da Manhã</option>
            <option value="almoco">Almoço</option>
            <option value="lanche">Lanche</option>
            <option value="jantar">Jantar</option>
          </select>
        </div>

        <div class="sm:col-span-1">
          <label for="foodQuantity" class="block text-sm font-medium text-gray-700 mb-1">3. Qtd.</label>
          <input
            type="number"
            id="foodQuantity"
            placeholder="Qtd."
            min="0"
            step="0.1"
            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
          >
        </div>

        <div id="mealSuggestion" class="text-sm text-gray-600 mt-1 sm:col-span-3 px-1"></div>

        <button id="addFoodButton" class="sm:col-span-3 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-3">
          Adicionar Alimento
        </button>
        <button id="shareButton" class="sm:col-span-3 w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors mt-3">
          Compartilhar Resumo no WhatsApp
        </button>
      </div>
    </div>
    <div class="border-t border-gray-200 pt-4">
        <label for="dateSelector" class="block text-lg font-semibold text-gray-700 mb-2">Histórico:</label>
        <input type="date" id="dateSelector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
        <p id="dateStatus" class="text-sm text-gray-500 mt-1 text-center"></p>
    </div>
    <div id="hydrationTracker" class="border-t border-gray-200 pt-4 pb-4">
        <h2 class="text-xl font-semibold text-blue-600 mb-3">💧 Adicionar Hidratação</h2>
        <div class="flex items-end space-x-3 mb-4">
            <div class="flex-grow">
                <label for="waterQuantityInput" class="block text-sm font-medium text-gray-700">Qtd. de Água (ml)</label>
                <input
                    type="number"
                    id="waterQuantityInput"
                    placeholder="250"
                    min="50"
                    step="50"
                    value="250"
                    class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
            <button id="addWaterButton" class="h-10 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                Adicionar
            </button>
        </div>
    </div>
    <div class="border-b border-gray-200 py-4">
      <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center justify-between space-x-2">
        <span>Refeições do Dia:</span>
        <span id="goalTag" class="text-xs font-medium text-blue-700 bg-blue-100 py-0.5 px-2 rounded-full flex-shrink-0 hidden"></span>
      </h3>
      <div id="foodList" class="overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-4 bg-gray-50 min-h-48">
        <p id="emptyListText" class="text-gray-400 text-center mt-4">Nenhum alimento adicionado ainda.</p>
        <div id="water_container" class="mb-2 meal-section"> 
            <h4 class="font-semibold text-gray-700 mb-2 text-lg">💧 Registros de Água</h4>
            <div class="space-y-2" id="list-water"></div>
        </div>
        <div id="cafe_da_manha_container"></div>
        <div id="almoco_container"></div>
        <div id="lanche_container"></div>
        <div id="jantar_container"></div>
      </div>
      <p class="text-xs text-gray-500 mt-2">⚠️ indica alimentos que podem aumentar a gordura visceral.</p>
    </div>
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800 text-center">Resumo do Dia</h2>
      
      <div id="weightProgressSection">
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-indigo-600">Meta de Peso</span>
          <span id="weightGoalText" class="text-sm font-semibold text-indigo-600">0 kg / 0 kg</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="weightProgress" class="bg-indigo-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-blue-600">Água</span>
          <span id="waterGoalText" class="text-sm font-semibold text-blue-600">Consumo: 0 ml / Meta: 0 ml</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="waterProgress" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <div>
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-orange-600">Calorias</span>
          <span id="totalCalsGoalText" class="text-sm font-semibold text-orange-600">0 / 0 kcal</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="calorieProgress" class="bg-orange-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 text-center">
        <div>
          <p class="text-base font-medium text-emerald-600 mb-1">Proteínas</p>
          <p id="totalProteins" class="text-3xl font-bold text-emerald-600">0 g</p>
        </div>
        <div>
          <p class="text-base font-medium text-blue-600 mb-1">Carboidratos</p>
          <p id="totalCarbs" class="text-3xl font-bold text-blue-600">0 g</p>
        </div>
      </div>
    </div>
    </div>

  <footer class="mt-8 text-sm text-gray-500">Desenvolvido por Thiago</footer>

  <script>
    // Firebase Config (SUBSITUA ESTE BLOCO PELAS SUAS CHAVES DO FIREBASE)
    const firebaseConfig = {
      apiKey: "AIzaSyC9WSxM9GA64fq9lkLhsTyvMbD1AlO1MM4",
      authDomain: "assistente-de-treino-668ce.firebaseapp.com",
      projectId: "assistente-de-treino-668ce",
      storageBucket: "assistente-de-treino-668ce.firebasestorage.app",
      messagingSenderId: "878456748339",
      appId: "1:878456748339:web:5b310b5e91a7b23d0ba646",
      measurementId: "G-FCQ5CQT1WY"
    };

    let firebaseApp, firebaseAuth, firebaseDb, userId = null;
    let authInitialized = false; // NOVA FLAG

    // /* --- MÓDULO: ESTADO E VARIÁVEIS GLOBAIS --- */
    let calorieGoal = 0;
    let waterGoal = 0; 
    let currentWeight = 0; 
    let targetWeight = 0; 
    let selectedFoodKey = null;
    let dailyLog = {}; 
    let waterLog = 0; 
    const TODAY = new Date(); 
    TODAY.setHours(0, 0, 0, 0); 
    const todayDateString = TODAY.toISOString().split('T')[0]; 
    
    let currentDateString = todayDateString; 
    
    let goalExceededNotified = false;
    let profilePicBase64 = null;
    let isEditingProfile = false;
    let currentGoalType = 'ganhar';
    let unsubscribeListener = null; 

    const MEAL_KEYS = ['cafe_da_manha', 'almoco', 'lanche', 'jantar'];
    const mealDisplayNames = {
      cafe_da_manha: "☕ Café da Manhã",
      almoco: "🍽️ Almoço",
      lanche: "🍎 Lanche",
      jantar: "🍲 Jantar",
    };
    const ALL_LOG_KEYS = ['water', ...MEAL_KEYS];

    const goalDisplayNames = {
      ganhar: 'Ganho de Massa',
      manter: 'Manutenção',
      perder: 'Perda de Peso'
    };

    const mealSuggestions = {
      ganhar: {
        cafe_da_manha: "Ex: Ovos, Aveia, Banana, Whey Protein.",
        almoco: "Ex: Arroz, Peito de Frango, Feijão, Batata Doce.",
        lanche: "Ex: Pão Integral, Pasta de Amendoim, Iogurte Grego.",
        jantar: "Ex: Macarrão, Carne Moída, Salada com Azeite.",
      },
      perder: {
        cafe_da_manha: "Ex: Ovos, Morangos, Café Preto, Iogurte Natural.",
        almoco: "Ex: Salada, Tilápia, Brócolis, Pouco Arroz Integral.",
        lanche: "Ex: Maçã, Queijo Minas, Castanhas (pouco).",
        jantar: "Ex: Sopa de legumes, Peito de Frango, Alface.",
      },
      manter: {
        cafe_da_manha: "Refeição balanceada. Ex: Pão Integral, Ovos, Mamão.",
        almoco: "Equilibre prato. Ex: Arroz, Feijão, Bife, Salada.",
        lanche: "Ex: Uvas, Iogurte, Aveia.",
        jantar: "Refeição leve. Ex: Batata Doce, Frango, Brócolis.",
      }
    };
    // /* --- FIM MÓDULO: ESTADO E VARIÁVEIS GLOBAIS --- */


    // /* --- MÓDULO: BANCO DE DADOS DE ALIMENTOS (foodDatabase) --- */
    const foodDatabase = {
      // --- FRUTAS (FRUITS) ---
      'banana': { name: 'Banana', protein: 1.1, carbs: 27, cals: 105, unit: 'unidade', visceralFat: false },
      'maca': { name: 'Maçã', protein: 0.3, carbs: 25, cals: 95, unit: 'unidade', visceralFat: false },
      'abacate': { name: 'Abacate', protein: 2, carbs: 9, cals: 160, unit: '100g', visceralFat: false },
      'mamao': { name: 'Mamão Formosa', protein: 0.5, carbs: 11, cals: 43, unit: '100g', visceralFat: false },
      'melancia': { name: 'Melancia', protein: 0.6, carbs: 8, cals: 30, unit: '100g', visceralFat: false },
      'uva': { name: 'Uva', protein: 0.7, carbs: 18, cals: 69, unit: '100g', visceralFat: false },
      'laranja': { name: 'Laranja', protein: 1, carbs: 12, cals: 47, unit: 'unidade', visceralFat: false },
      'morango': { name: 'Morango', protein: 0.7, carbs: 8, cals: 32, unit: '100g', visceralFat: false },
      'amora': { name: 'Amora', protein: 1.4, carbs: 9.6, cals: 43, unit: '100g', visceralFat: false },
      'framboesa': { name: 'Framboesa', protein: 1.2, carbs: 12, cals: 52, unit: '100g', visceralFat: false },
      'kiwi': { name: 'Kiwi', protein: 1.1, carbs: 15, cals: 61, unit: 'unidade', visceralFat: false },
      'abacaxi': { name: 'Abacaxi', protein: 0.5, carbs: 13, cals: 50, unit: '100g', visceralFat: false },
      'limao': { name: 'Limão (suco)', protein: 0.4, carbs: 9.3, cals: 29, unit: 'unidade', visceralFat: false },
      
      // --- VEGETAIS / LEGUMES (VEGETABLES) ---
      'brocolis': { name: 'Brócolis (cozido)', protein: 2.4, carbs: 7, cals: 35, unit: '100g', visceralFat: false },
      'alface': { name: 'Alface Crespa', protein: 1.4, carbs: 2.9, cals: 15, unit: '100g', visceralFat: false },
      'tomate': { name: 'Tomate', protein: 0.9, carbs: 3.9, cals: 18, unit: '100g', visceralFat: false },
      'cenoura': { name: 'Cenoura (crua)', protein: 0.9, carbs: 10, cals: 41, unit: '100g', visceralFat: false },
      'couve_flor': { name: 'Couve-Flor (cozida)', protein: 1.9, carbs: 5, cals: 25, unit: '100g', visceralFat: false },
      'abobrinha': { name: 'Abobrinha (cozida)', protein: 1.2, carbs: 3, cals: 17, unit: '100g', visceralFat: false },
      
      // --- PROTEÍNAS (PROTEINS) ---
      'peito_frango': { name: 'Peito de Frango (grelhado)', protein: 31, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
      'ovo': { name: 'Ovo Cozido', protein: 6.3, carbs: 0.6, cals: 77, unit: 'unidade', visceralFat: false },
      'ovo_frito': { name: 'Ovo Frito (em óleo)', protein: 6.2, carbs: 0.6, cals: 95, unit: 'unidade', visceralFat: false },
      'ovos_mexidos': { name: 'Ovos Mexidos (c/ manteiga)', protein: 6.5, carbs: 1.5, cals: 105, unit: 'unidade (1 ovo)', visceralFat: true },
      'ovo_mexido_oleo': { name: 'Ovo Mexido (c/ óleo)', protein: 6.5, carbs: 1.5, cals: 95, unit: 'unidade (1 ovo)', visceralFat: true }, 
      'carne_moida': { name: 'Carne Moída (patinho, cozida)', protein: 26, carbs: 0, cals: 180, unit: '100g', visceralFat: false },
      'bife_alcatra': { name: 'Bife (Alcatra, grelhado)', protein: 28, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
      'tilapia': { name: 'Tilápia (grelhada)', protein: 26, carbs: 0, cals: 128, unit: '100g', visceralFat: false },
      'salmao': { name: 'Salmão (grelhado)', protein: 20, carbs: 0, cals: 208, unit: '100g', visceralFat: false },
      'atum_lata': { name: 'Atum em Lata (em óleo)', protein: 29, carbs: 0, cals: 186, unit: '100g', visceralFat: false },
      
      // --- LÁCTEOS E SIMILARES (DAIRY) ---
      'leite_integral': { name: 'Leite Integral', protein: 3.2, carbs: 5, cals: 61, unit: '100ml', visceralFat: true },
      'leite_desnatado': { name: 'Leite Desnatado', protein: 3.4, carbs: 5, cals: 35, unit: '100ml', visceralFat: false },
      'queijo_mussarela': { name: 'Queijo Mussarela', protein: 22, carbs: 3.1, cals: 300, unit: '100g (fatia 30g)', visceralFat: true },
      'queijo_minas': { name: 'Queijo Minas Frescal', protein: 17, carbs: 3, cals: 264, unit: '100g', visceralFat: false },
      'queijo_cottage': { name: 'Queijo Cottage', protein: 11, carbs: 3, cals: 98, unit: '100g', visceralFat: false },
      'iogurte_grego': { name: 'Iogurte Grego (natural)', protein: 10, carbs: 3.6, cals: 59, unit: '100g', visceralFat: false },
      'iogurte_natural': { name: 'Iogurte Natural Desnatado', protein: 4.1, carbs: 7, cals: 57, unit: '100g', visceralFat: false },
      'iogurte_sabor': { name: 'Iogurte Desn. (Sabor)', protein: 3.5, carbs: 15, cals: 85, unit: '100g', visceralFat: true }, 

      // --- CARBOIDRATOS (CARBS) ---
      'arroz_branco': { name: 'Arroz Branco (cozido)', protein: 2.7, carbs: 28, cals: 130, unit: '100g', visceralFat: false },
      'arroz_integral': { name: 'Arroz Integral (cozido)', protein: 2.6, carbs: 23, cals: 111, unit: '100g', visceralFat: false },
      'batata_doce': { name: 'Batata Doce (cozida)', protein: 1.6, carbs: 20, cals: 86, unit: '100g', visceralFat: false },
      'batata_inglesa': { name: 'Batata Inglesa (cozida)', protein: 2, carbs: 20, cals: 87, unit: '100g', visceralFat: false },
      'mandioca': { name: 'Mandioca (Aipim cozido)', protein: 1.4, carbs: 30, cals: 139, unit: '100g', visceralFat: false }, 
      'feijao_preto': { name: 'Feijão Preto (cozido)', protein: 9, carbs: 24, cals: 131, unit: '100g', visceralFat: false },
      'feijao_carioca': { name: 'Feijão Carioca (cozido)', protein: 4.8, carbs: 14, cals: 76, unit: '100g', visceralFat: false },
      'lentilha': { name: 'Lentilha (cozida)', protein: 9, carbs: 20, cals: 116, unit: '100g', visceralFat: false },
      'grao_bico': { name: 'Grão de Bico (cozido)', protein: 9, carbs: 27, cals: 164, unit: '100g', visceralFat: false },
      'quinoa': { name: 'Quinoa (cozida)', protein: 4.1, carbs: 21, cals: 120, unit: '100g', visceralFat: false },
      'macarrao': { name: 'Macarrão (cozido)', protein: 5, carbs: 25, cals: 131, unit: '100g', visceralFat: false },
      'cuscuz': { name: 'Cuscuz (hidratado)', protein: 3.8, carbs: 23, cals: 112, unit: '100g', visceralFat: false },
      'tapioca': { name: 'Tapioca (goma)', protein: 0, carbs: 89, cals: 355, unit: '100g', visceralFat: false },
      'aveia': { name: 'Aveia em Flocos', protein: 17, carbs: 66, cals: 389, unit: '100g', visceralFat: false },

      // --- PANIFICAÇÃO / GORDURAS (BREADS / FATS) ---
      'pao_frances': { name: 'Pão Francês', protein: 7.5, carbs: 55, cals: 288, unit: '100g (unid 50g)', visceralFat: false },
      'pao_centeio': { name: 'Pão de Centeio', protein: 8, carbs: 48, cals: 259, unit: '100g (fatia 30g)', visceralFat: false },
      'pao_forma': { name: 'Pão de Forma (Branco)', protein: 2.5, carbs: 15, cals: 80, unit: 'fatia', visceralFat: true },
      'pao_integral': { name: 'Pão de Forma (Integral)', protein: 3, carbs: 12, cals: 70, unit: 'fatia', visceralFat: false },
      'pasta_amendoim': { name: 'Pasta de Amendoim (integral)', protein: 25, carbs: 20, cals: 588, unit: '100g (colher 15g)', visceralFat: false },
      'castanha_caju': { name: 'Castanha de Caju', protein: 18, carbs: 30, cals: 553, unit: '100g', visceralFat: false },
      'amendoim': { name: 'Amendoim', protein: 26, carbs: 16, cals: 567, unit: '100g', visceralFat: false },
      'azeite': { name: 'Azeite de Oliva', protein: 0, carbs: 0, cals: 119, unit: 'colher sopa', visceralFat: false },
      'manteiga': { name: 'Manteiga com sal', protein: 0.9, carbs: 0.1, cals: 717, unit: '100g (colher 5g)', visceralFat: true },
      'manteiga_amendoim_doce': { name: 'Manteiga de Amendoim (doce)', protein: 21, carbs: 30, cals: 600, unit: '100g (colher 15g)', visceralFat: true }, 

      // --- SUPLEMENTOS (SUPPLEMENTS) ---
      'whey_protein': { name: 'Whey Protein', protein: 24, carbs: 3, cals: 120, unit: 'scoop 30g', visceralFat: false },
      'creatina': { name: 'Creatina (pura)', protein: 0, carbs: 0, cals: 0, unit: 'scoop 3g', visceralFat: false },
      
      // --- BEBIDAS QUENTES / CAFÉS ---
      'cafe_preto': { name: 'Café Preto (sem açúcar)', protein: 0.1, carbs: 0, cals: 2, unit: 'xícara', visceralFat: false },
      'cafe_preto_acucar': { name: 'Café Preto (c/ açúcar)', protein: 0.2, carbs: 5, cals: 24, unit: 'xícara', visceralFat: false }, 
      'cafe_desnatado_acucar': { name: 'Café c/ Leite Desnatado + Açúcar', protein: 6.8, carbs: 20, cals: 126, unit: '200ml', visceralFat: false },
      'cafe_integral_acucar': { name: 'Café c/ Leite Integral + Açúcar', protein: 6.4, carbs: 20, cals: 154, unit: '200ml', visceralFat: true }, 
      
      // --- DADOS ADICIONAIS ---
      'salmao_cru': { name: 'Salmão (cru)', protein: 20.4, carbs: 0, cals: 208, unit: '100g', visceralFat: false },
      'leite_aveia': { name: 'Bebida de Aveia', protein: 1.0, carbs: 10.3, cals: 54, unit: '100ml', visceralFat: false },
      'ovos_cozidos_claras': { name: 'Claras de Ovo (cozidas)', protein: 10.9, carbs: 0.7, cals: 52, unit: '100g', visceralFat: false },
      'paorede': { name: 'Pão de Queijo', protein: 7, carbs: 25, cals: 150, unit: 'unidade média', visceralFat: true },
      
      // --- ITENS DE 'LIXO' / DOCES (JUNK / SWEETS) ---
      'batata_frita': { name: 'Batata Frita', protein: 3.4, carbs: 41, cals: 319, unit: '100g', visceralFat: true },
      'refrigerante': { name: 'Refrigerante (Cola)', protein: 0, carbs: 26, cals: 105, unit: 'lata 350ml', visceralFat: true },
      'chocolate_ao_leite': { name: 'Chocolate ao Leite', protein: 8, carbs: 59, cals: 535, unit: '100g (barra 25g)', visceralFat: true },
      'biscoito_recheado': { name: 'Biscoito Recheado (Chocolate)', protein: 5, carbs: 70, cals: 450, unit: '100g (unid 10g)', visceralFat: true },
      'pizza_mussarela': { name: 'Pizza Mussarela', protein: 11, carbs: 33, cals: 271, unit: '100g (1 fatia)', visceralFat: true },
      'mel': { name: 'Mel', protein: 0.3, carbs: 82, cals: 304, unit: '100g', visceralFat: true },
      'pudim': { name: 'Pudim de Leite', protein: 5, carbs: 30, cals: 200, unit: '100g (fatia)', visceralFat: true },
      'paçoca': { name: 'Paçoca (rolha)', protein: 5, carbs: 12, cals: 100, unit: 'unidade 20g', visceralFat: false },
    };
    // /* --- FIM MÓDULO: BANCO DE DADOS DE ALIMENTOS (foodDatabase) --- */


    // /* --- MÓDULO: HELPERS FIREBASE --- */
    function getDayRef(uid, date) {
      return firebaseDb.collection('users').doc(uid).collection('days').doc(date);
    }
    function getItemsRef(uid, date) {
      return getDayRef(uid, date).collection('items');
    }

    function getProfileDocRef() { return firebaseDb.collection('users').doc(userId).collection('data').doc('profile'); }
    function getMetasDocRef() { return firebaseDb.collection('users').doc(userId).collection('data').doc('metas'); }
    // /* --- FIM MÓDULO: HELPERS FIREBASE --- */


    // /* --- MÓDULO: HELPERS DE UI (MODAL, ELEMENTOS, ETC) --- */
    function showElement(el){ el.classList.remove('hidden'); }
    function hideElement(el){ el.classList.add('hidden'); }
    function showModal(modal, overlay){ showElement(overlay); showElement(modal); requestAnimationFrame(()=>{ modal.classList.remove('scale-90','opacity-0'); modal.classList.add('scale-100','opacity-100');}); }
    function hideModal(modal, overlay){ modal.classList.remove('scale-100','opacity-100'); modal.classList.add('scale-90','opacity-0'); setTimeout(()=>{ hideElement(modal); hideElement(overlay); clearRegError(); }, 250); }
    
    function showRegError(message){ const el=document.getElementById('regError'); el.textContent=message; showElement(el); }
    function clearRegError(){ const el=document.getElementById('regError'); el.textContent=''; hideElement(el); }
    
    function showLoginError(message){ const el=document.getElementById('loginError'); el.textContent=message; showElement(el); }
    function clearLoginError(){ const el=document.getElementById('loginError'); el.textContent=''; hideElement(el); }

    function fileToBase64(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=e=>reject(e); r.readAsDataURL(file); }); }
    function saveProfilePicLocally(){ if(profilePicBase64){ localStorage.setItem(`profilePic_${userId}`, profilePicBase64); document.getElementById('profileImageDisplay').src=profilePicBase64; document.getElementById('regProfileImage').src=profilePicBase64; } }
    function loadProfilePicLocally(){ const pic=localStorage.getItem(`profilePic_${userId}`); if(pic){ profilePicBase64=pic; document.getElementById('profileImageDisplay').src=pic; document.getElementById('regProfileImage').src=pic; } }
    
    function togglePasswordVisibility(fieldId) {
        const input = document.getElementById(fieldId);
        const eye = document.getElementById(fieldId + '_eye');
        const eyeOpen = document.getElementById(fieldId + '_eye_open');

        if (input.type === 'password') {
            input.type = 'text';
            hideElement(eye);
            showElement(eyeOpen);
        } else {
            input.type = 'password';
            showElement(eye);
            hideElement(eyeOpen);
        }
    }
    // /* --- FIM MÓDULO: HELPERS DE UI (MODAL, ELEMENTOS, ETC) --- */


    // /* --- MÓDULO: AUTENTICAÇÃO E PERFIL --- */
    
    function showRegistrationModal(isEdit = false) {
        isEditingProfile = isEdit;
        const modal = document.getElementById('fullRegistrationModal');
        const overlay = document.getElementById('fullRegistrationModalOverlay');
        
        clearRegError();
        document.getElementById('regModalTitle').textContent = isEdit ? 'Editar Perfil' : 'Crie sua Conta';
        
        const regFields = document.getElementById('registrationFields');
        const saveButton = document.getElementById('registerAndProfileButton');
        const showLogin = document.getElementById('showLoginButton');
        
        if (isEdit) {
            hideElement(regFields);
            hideElement(showLogin);
            saveButton.textContent = 'Salvar Alterações';
            document.getElementById('regUserNameInput').value = document.getElementById('userNameDisplay').textContent;
            document.getElementById('regPhoneInput').value = localStorage.getItem(`phone_${userId}`) || '';
        } else {
            showElement(regFields);
            showElement(showLogin);
            saveButton.textContent = 'Criar Conta e Perfil';
            document.getElementById('regUserNameInput').value = '';
            document.getElementById('regPhoneInput').value = '';
            document.getElementById('regEmailInput').value = '';
            document.getElementById('regPasswordInput').value = '';
            profilePicBase64 = null; // Limpa a foto para um novo registro
            document.getElementById('regProfileImage').src = 'https://placehold.co/96x96/E0F2F1/065F46?text=FP';
        }
        
        showModal(modal, overlay);
    }
    
    function showLoginModal() {
        clearLoginError();
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        showModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
    }
    
    async function handleFullRegistration() {
        clearRegError();
        const userName = document.getElementById('regUserNameInput').value.trim();
        const phone = document.getElementById('regPhoneInput').value.trim();
        
        if(!userName){ showRegError("Por favor, insira um nome de usuário."); return; }

        if (isEditingProfile) {
            try {
                await getProfileDocRef().set({ 
                    userName, 
                    phone: phone || null, 
                    userId 
                }, { merge: true });
                saveProfilePicLocally();
                localStorage.setItem(`phone_${userId}`, phone || '');
                document.getElementById('userNameDisplay').textContent = userName;
                hideModal(document.getElementById('fullRegistrationModal'), document.getElementById('fullRegistrationModalOverlay'));
            } catch (e) {
                showRegError("Erro ao salvar perfil. Verifique as regras do Firebase.");
                console.error("Erro ao salvar perfil:", e);
            }
            return;
        }

        // Registro de Nova Conta
        const email = document.getElementById('regEmailInput').value;
        const password = document.getElementById('regPasswordInput').value;
        
        if (!email || !password || password.length < 6) {
            showRegError("Email válido e senha (mín. 6 caracteres) são obrigatórios.");
            return;
        }

        try {
            const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
            const newUserId = userCredential.user.uid;
            
            await firebaseDb.collection('users').doc(newUserId).collection('data').doc('profile').set({
                userName,
                phone: phone || null,
                userId: newUserId,
                email: email
            });
            
            if (profilePicBase64) {
                localStorage.setItem(`profilePic_${newUserId}`, profilePicBase64);
            }
            
            // Define o marcador de que já houve login
            localStorage.setItem('hasEverLoggedIn', 'true');

            alert("Conta e perfil criados com sucesso!");
            hideModal(document.getElementById('fullRegistrationModal'), document.getElementById('fullRegistrationModalOverlay'));
            // Não precisa recarregar, o onAuthStateChanged fará a transição da UI

        } catch (e) {
            let errorMessage = "Erro ao criar conta. Tente um email/senha diferente.";
            if (e.code === 'auth/email-already-in-use') {
                errorMessage = "Este email já está em uso. Tente fazer Login.";
            } else if (e.code === 'auth/invalid-email') {
                errorMessage = "O formato do email é inválido.";
            } else if (e.code === 'auth/weak-password') {
                errorMessage = "Senha fraca. Use no mínimo 6 caracteres.";
            }
            showRegError(errorMessage);
            console.error("Erro no registro:", e);
        }
    }
    
    async function handleLogin() {
        clearLoginError();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
            showLoginError("Email e senha são obrigatórios.");
            return;
        }

        try {
            await firebaseAuth.signInWithEmailAndPassword(email, password);
            localStorage.setItem('hasEverLoggedIn', 'true');
            hideModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
            // Não precisa recarregar, o onAuthStateChanged fará a transição da UI

        } catch (e) {
            showLoginError("Login falhou. Verifique email e senha.");
            console.error("Erro no login:", e);
        }
    }
    
    async function handleLogout() {
        await firebaseAuth.signOut();
        // O onAuthStateChanged vai lidar com a UI após o logout
    }
    
    async function loadProfileAndMetas(){
      try{
        const pSnap = await getProfileDocRef().get();
        if(pSnap.exists){
          const d=pSnap.data();
          document.getElementById('userNameDisplay').textContent=d.userName||'Usuário';
          localStorage.setItem(`phone_${userId}`, d.phone || ''); 
          loadProfilePicLocally();
          
        } else {
             // Usuário logado mas sem perfil (erro ou primeiro login/registro)
             showRegistrationModal(false); 
             return; 
        }

        const mSnap = await getMetasDocRef().get();
        if(mSnap.exists){
          const d=mSnap.data();
          document.getElementById('weight').value=d.weight||'';
          document.getElementById('targetWeight').value=d.targetWeight||''; 
          document.getElementById('height').value=d.height||'';
          document.getElementById('age').value=d.age||'';
          document.getElementById('gender').value=d.gender||'male';
          document.getElementById('activity').value=d.activity||'1.55';
          document.getElementById('goalType').value=d.goalType||'ganhar';
          calorieGoal = parseFloat(d.calorieGoal)||0;
          waterGoal = parseFloat(d.waterGoal)||0; 
          currentGoalType = d.goalType||'ganhar';
          currentWeight = parseFloat(d.weight)||0; 
          targetWeight = parseFloat(d.targetWeight)||0; 
        }
        updateGoalDisplay();
        updateMealSuggestion();
      }catch(e){
        // Erro no Firestore, mas usuário está logado, mostra edição para forçar o salvamento
        showRegistrationModal(true); 
      }
    }
    
    // /* --- FIM MÓDULO: AUTENTICAÇÃO E PERFIL --- */


    // /* --- MÓDULO: LÓGICA DE METAS E CÁLCULO (MANTIDO) --- */
    // ... (Mantido o código de saveMetas, updateGoalDisplay, updateWeightProgress, updateMealSuggestion)
    // /* --- FIM MÓDULO: LÓGICA DE METAS E CÁLCULO (MANTIDO) --- */


    // /* --- MÓDULO: LÓGICA DE LOG DIÁRIO (MANTIDO) --- */
    // ... (Mantido o código de loadLogForDate, startDayListener, addWater, etc.)
    // /* --- FIM MÓDULO: LÓGICA DE LOG DIÁRIO (MANTIDO) --- */


    // /* --- MÓDULO: COMPARTILHAMENTO (MANTIDO) --- */
    // ... (Mantido o código de shareToWhatsApp, shareApp)
    // /* --- FIM MÓDULO: COMPARTILHAMENTO (MANTIDO) --- */


    // /* --- MÓDULO: INICIALIZAÇÃO E LISTENERS (Ajustado) --- */
    
    // NOVO: Função para lidar com o estado inicial e o timeout
    let authTimeout = null;
    let authListenerUnsubscribed = false;

    function startAuthListener() {
        // Assegura que o listener só rode uma vez
        if (authListenerUnsubscribed) return;

        // Tenta resolver o estado de autenticação (logado ou não)
        firebaseAuth.onAuthStateChanged(async (user) => {
            if (authListenerUnsubscribed) return;

            clearTimeout(authTimeout); // Cancela o timeout se o estado for resolvido rapidamente

            if (user) {
                // Caso 1: Usuário logado
                userId = user.uid;
                await loadProfileAndMetas(); // Carrega o perfil e as metas
                
                // Ativa a UI e carrega dados
                const dateSelector = document.getElementById('dateSelector');
                dateSelector.value = todayDateString;
                dateSelector.max = todayDateString; 
                loadLogForDate(todayDateString); 
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                // Atualiza botões
                document.getElementById('authControlButton').textContent = 'Fazer Logout';
                document.getElementById('authControlButton').onclick = handleLogout;
                document.getElementById('editProfileButton').onclick = () => showRegistrationModal(true); 

            } else {
                // Caso 2: Usuário não logado
                userId = null;
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Redireciona para o fluxo de Login/Registro
                const hasEverLoggedIn = localStorage.getItem('hasEverLoggedIn');
                if (hasEverLoggedIn) {
                    showLoginModal();
                } else {
                    showRegistrationModal(false); 
                }
                
                // Botões para usuário não logado
                document.getElementById('userNameDisplay').textContent = 'Visitante';
                document.getElementById('profileImageDisplay').src = 'https://placehold.co/64x64/E0F2F1/065F46?text=FP';
                document.getElementById('authControlButton').textContent = 'Fazer Login / Criar Conta';
                document.getElementById('authControlButton').onclick = showLoginModal;
                document.getElementById('editProfileButton').onclick = showLoginModal;

                // Desabilita funcionalidades
                document.getElementById('goalsDetails').classList.add('opacity-50');
                document.getElementById('addFoodSection').classList.add('opacity-50');
                document.getElementById('hydrationTracker').classList.add('opacity-50');
            }
        });

        // Configura um timeout de segurança (3 segundos)
        authTimeout = setTimeout(() => {
            if (firebaseAuth.currentUser === null) {
                // Se o timeout estourar e não houver usuário logado, assume falha e mostra o login
                authListenerUnsubscribed = true; 
                const l = document.getElementById('loadingScreen');
                l.innerHTML = `
                    <p class="text-red-600 font-semibold">Falha na Conexão</p>
                    <p class="text-gray-600 mt-2">O Firebase não respondeu a tempo. Recarregando...</p>
                    <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">Tentar Novamente</button>
                `;
                console.error("Timeout de inicialização do Firebase.");
                // Força um reload para tentar de novo, o que é mais seguro do que liberar uma UI não funcional
                setTimeout(() => location.reload(), 2000); 
            }
        }, 3000); // 3 segundos
    }

    async function initializeApp(){
      try{
        if (!firebaseApp) {
          firebaseApp = firebase.initializeApp(firebaseConfig);
          firebaseAuth = firebase.auth();
          firebaseDb = firebase.firestore();
        }

        try{
            await firebaseDb.enablePersistence({ synchronizeTabs: true });
        }catch(err){
            console.warn('Persistência não habilitada:', err?.code||err);
        }
        
        startAuthListener(); // Inicia o processo de autenticação e UI

      }catch(e){
        // Falha na inicialização do Firebase (chaves incorretas ou problema grave)
        const l=document.getElementById('loadingScreen');
        l.innerHTML = `
          <p class="text-red-600 font-semibold">Erro Fatal na Configuração</p>
          <p class="text-gray-600 mt-2">Verifique as chaves 'firebaseConfig'.</p>
          <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">Tentar Novamente</button>
        `;
        console.error("Erro fatal:", e);
      }
    }


    document.addEventListener('DOMContentLoaded', ()=>{
      initializeApp();
      
      // Funções expostas
      window.selectFood = selectFood;
      window.addWater = addWater; 
      window.addFoodToLog = addFoodToLog;
      window.removeFoodFromLog = removeFoodFromLog; 
      window.togglePasswordVisibility = togglePasswordVisibility; 

      // Listeners do App Principal
      document.getElementById('dateSelector').addEventListener('change', (e) => {
          if (userId) loadLogForDate(e.target.value);
      });
      document.getElementById('addWaterButton').addEventListener('click', userId ? addWater : showLoginModal);
      document.getElementById('calculateButton').addEventListener('click', userId ? saveMetas : showLoginModal);
      document.getElementById('goalType').addEventListener('change', updateMealSuggestion);
      document.getElementById('mealTimeSelect').addEventListener('change', updateMealSuggestion);
      document.getElementById('foodSearch').addEventListener('input', searchFood);
      document.getElementById('addFoodButton').addEventListener('click', userId ? addFoodToLog : showLoginModal);
      document.getElementById('shareButton').addEventListener('click', shareToWhatsApp);
      document.getElementById('shareAppButton').addEventListener('click', shareApp);
      document.getElementById('closeWarningModalButton').addEventListener('click', ()=>{
        hideModal(document.getElementById('warningModal'), document.getElementById('warningModalOverlay'));
      });
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#foodSearch') && !e.target.closest('#searchDropdown')){
          hideElement(document.getElementById('searchDropdown'));
        }
      });
      
      // Listeners do Novo Modal de Registro/Login
      document.getElementById('registerAndProfileButton').addEventListener('click', handleFullRegistration);
      document.getElementById('regProfilePicInput').addEventListener('change', async (e)=>{
        const file=e.target.files[0];
        if(file){ profilePicBase64=await fileToBase64(file); document.getElementById('regProfileImage').src=profilePicBase64; }
      });
      
      document.getElementById('showLoginButton').addEventListener('click', (e) => {
          e.preventDefault();
          hideModal(document.getElementById('fullRegistrationModal'), document.getElementById('fullRegistrationModalOverlay'));
          showLoginModal();
      });

      document.getElementById('loginSubmitButton').addEventListener('click', handleLogin);
      document.getElementById('showRegistrationButton').addEventListener('click', (e) => {
          e.preventDefault();
          hideModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
          showRegistrationModal(false);
      });
      
      document.getElementById('authControlButton').addEventListener('click', (e) => {
        // Redireciona para o fluxo correto de Login/Logout
        if (firebaseAuth.currentUser) {
            handleLogout();
        } else {
            showLoginModal();
        }
      });
    });
    // /* --- FIM MÓDULO: INICIALIZAÇÃO E LISTENERS --- */
  </script>
</body>
</html>
