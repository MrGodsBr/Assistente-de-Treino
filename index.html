<html lang="pt-BR">
<head>
Â  Â <meta charset="UTF-8">
Â  Â <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â <title>Assistente de Treino</title>
Â  Â <!-- Carrega o Tailwind CSS -->
Â  Â <script src="https://cdn.tailwindcss.com"></script>
Â  Â 
Â  Â <!-- Scripts do Firebase -->
Â  Â <script type="module">
Â  Â  Â  Â // ImportaÃ§Ãµes do Firebase
Â  Â  Â  Â import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â import {
Â  Â  Â  Â  Â  Â getAuth,
Â  Â  Â  Â  Â  Â signInAnonymously,
Â  Â  Â  Â  Â  Â onAuthStateChanged
Â  Â  Â  Â } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â import {
Â  Â  Â  Â  Â  Â getFirestore,
Â  Â  Â  Â  Â  Â doc,
Â  Â  Â  Â  Â  Â getDoc,
Â  Â  Â  Â  Â  Â setDoc,
Â  Â  Â  Â  Â  Â setLogLevel
Â  Â  Â  Â } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â  Â  Â  Â // VariÃ¡veis globais do Firebase
Â  Â  Â  Â let app, auth, db;
Â  Â  Â  Â let userId;
Â  Â  Â  Â let currentProfileData = {}; // Guarda os dados do perfil atual

Â  Â  Â  Â // --- INICIALIZAÃ‡ÃƒO DO FIREBASE ---
Â  Â  Â  Â async function initializeFirebase() {
Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â // A SUA CONFIGURAÃ‡ÃƒO PESSOAL DO FIREBASE
Â  Â  Â  Â  Â  Â  Â  Â const firebaseConfig = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â apiKey: "AIzaSyC9WSxM9GA64fq9lkLhsTyvMbD1AlO1MM4",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â authDomain: "assistente-de-treino-668ce.firebaseapp.com",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â projectId: "assistente-de-treino-668ce",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â storageBucket: "assistente-de-treino-668ce.firebasestorage.app",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â messagingSenderId: "878456748339",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â appId: "1:878456748339:web:5b310b5e91a7b23d0ba646"
Â  Â  Â  Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â  Â  Â  Â // Inicializa o Firebase
Â  Â  Â  Â  Â  Â  Â  Â app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  Â  Â auth = getAuth(app);
Â  Â  Â  Â  Â  Â  Â  Â db = getFirestore(app);
Â  Â  Â  Â  Â  Â  Â  Â setLogLevel('Debug'); // Ativa logs do Firestore no console

Â  Â  Â  Â  Â  Â  Â  Â // Monitora o estado de autenticaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // UsuÃ¡rio estÃ¡ logado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â userId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â window.userId = user.uid; // Disponibiliza globalmente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.log("UsuÃ¡rio autenticado, UID:", userId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Agora, verificamos se o perfil dele existe no banco de dados
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await checkUserProfile();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // UsuÃ¡rio nÃ£o estÃ¡ logado, vamos logÃ¡-lo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.log("Nenhum usuÃ¡rio logado, tentando login anÃ´nimo...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao tentar login anÃ´nimo:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('app-loading-text').textContent = "Erro ao conectar. Tente recarregar a pÃ¡gina.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro crÃ­tico ao inicializar o Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('app-loading-text').textContent = "Erro ao carregar o app. Verifique a configuraÃ§Ã£o.";
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â // --- VERIFICAÃ‡ÃƒO DE PERFIL DE USUÃRIO ---
Â  Â  Â  Â async function checkUserProfile() {
Â  Â  Â  Â  Â  Â if (!userId) return;

Â  Â  Â  Â  Â  Â const loadingOverlay = document.getElementById('app-loading');
Â  Â  Â  Â  Â  Â const mainAppContent = document.getElementById('main-app-content');
Â  Â  Â  Â  Â  Â const registrationModal = document.getElementById('registrationModal');
Â  Â  Â  Â  Â  Â const registrationOverlay = document.getElementById('registrationOverlay');

Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â // Define o caminho do documento do perfil (NOVO CAMINHO)
Â  Â  Â  Â  Â  Â  Â  Â const profileRef = doc(db, "users", userId, "profile", "data");
Â  Â  Â  Â  Â  Â  Â  Â const profileSnap = await getDoc(profileRef);

Â  Â  Â  Â  Â  Â  Â  Â if (profileSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // --- USUÃRIO EXISTENTE ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.log("Perfil encontrado, carregando app...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const profileData = profileSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Carrega a UI do perfil e os dados locais
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loadProfileUI(profileData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loadDataFromLocalStorage(); // Carrega metas e refeiÃ§Ãµes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Mostra o app e esconde o loading
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mainAppContent.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loadingOverlay.classList.add('hidden');

Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // --- NOVO USUÃRIO ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.log("Nenhum perfil encontrado, mostrando modal de cadastro.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Configura o modal para "Cadastro"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('registrationModalTitle').textContent = 'Crie seu Perfil';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('saveProfileButtonText').textContent = 'ComeÃ§ar a Usar';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('cancelEditButton').classList.add('hidden'); // Esconde "Cancelar" no cadastro
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Mostra o modal de cadastro e esconde o loading
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â registrationModal.classList.remove('hidden', 'scale-95', 'opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â registrationOverlay.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loadingOverlay.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao verificar perfil no Firestore:", error);
Â  Â  Â  Â  Â  Â  Â  Â // Se o erro for 'permission-denied', Ã© provÃ¡vel que as regras do Firestore nÃ£o estejam definidas
Â  Â  Â  Â  Â  Â  Â  Â if (error.code === 'permission-denied') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('app-loading-text').textContent = "Erro de permissÃ£o. Verifique as regras do Firestore.";
Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('app-loading-text').textContent = "Erro ao verificar seu perfil.";
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â // --- CARREGA DADOS DO PERFIL NA UI ---
Â  Â  Â  Â function loadProfileUI(profileData) {
Â  Â  Â  Â  Â  Â currentProfileData = profileData || {}; // Salva os dados atuais

Â  Â  Â  Â  Â  Â // 1. Atualiza a barra de display principal
Â  Â  Â  Â  Â  Â if (profileData && profileData.username) {
Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('displayUsername').textContent = profileData.username;
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('displayUsername').textContent = "UsuÃ¡rio AnÃ´nimo";
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // 2. Preenche os campos de ediÃ§Ã£o no modal (para quando "Editar" for clicado)
Â  Â  Â  Â  Â  Â document.getElementById('usernameInput').value = profileData.username || '';
Â  Â  Â  Â  Â  Â document.getElementById('phoneInput').value = profileData.phone || '';

Â  Â  Â  Â  Â  Â // 3. Carrega a foto de perfil (do localStorage)
Â  Â  Â  Â  Â  Â const profilePicData = localStorage.getItem(`treinoProfilePic_${userId}`);
Â  Â  Â  Â  Â  Â const picPreviewEl = document.getElementById('profilePicPreview');
Â  Â  Â  Â  Â  Â const picDisplayEl = document.getElementById('displayProfilePic');
Â  Â  Â  Â  Â  Â const defaultPic = "https://placehold.co/100x100/e2e8f0/718096?text=Foto";

Â  Â  Â  Â  Â  Â if (profilePicData) {
Â  Â  Â  Â  Â  Â  Â  Â picPreviewEl.src = profilePicData;
Â  Â  Â  Â  Â  Â  Â  Â picDisplayEl.src = profilePicData;
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â picPreviewEl.src = defaultPic;
Â  Â  Â  Â  Â  Â  Â  Â picDisplayEl.src = defaultPic;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // 4. Mostra o ID do usuÃ¡rio (mas mantÃ©m escondido por padrÃ£o)
Â  Â  Â  Â  Â  Â document.getElementById('displayUserId').textContent = `Seu ID: ${userId}`;
Â  Â  Â  Â  Â  Â document.getElementById('profile-display-section').classList.remove('hidden');
Â  Â  Â  Â }

Â  Â  Â  Â // --- MOSTRAR/LIMPAR ERROS DO MODAL DE CADASTRO ---
Â  Â  Â  Â function showRegistrationError(message) {
Â  Â  Â  Â  Â  Â const errorEl = document.getElementById('registrationError');
Â  Â  Â  Â  Â  Â errorEl.textContent = message;
Â  Â  Â  Â  Â  Â errorEl.classList.remove('hidden');
Â  Â  Â  Â }
Â  Â  Â  Â function clearRegistrationError() {
Â  Â  Â  Â  Â  Â const errorEl = document.getElementById('registrationError');
Â  Â  Â  Â  Â  Â errorEl.classList.add('hidden');
Â  Â  Â  Â }
Â  Â  Â  Â 
Â  Â  Â  Â // --- FUNÃ‡Ã•ES DE ABRIR/FECHAR MODAL DE EDIÃ‡ÃƒO (NOVAS) ---
Â  Â  Â  Â function openProfileEditor() {
Â  Â  Â  Â  Â  Â clearRegistrationError();
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // Configura o modal para "Editar"
Â  Â  Â  Â  Â  Â document.getElementById('registrationModalTitle').textContent = 'Editar Perfil';
Â  Â  Â  Â  Â  Â document.getElementById('saveProfileButtonText').textContent = 'Salvar AlteraÃ§Ãµes';
Â  Â  Â  Â  Â  Â document.getElementById('cancelEditButton').classList.remove('hidden'); // Mostra "Cancelar"
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // Garante que os campos estÃ£o preenchidos com os dados mais recentes
Â  Â  Â  Â  Â  Â loadProfileUI(currentProfileData);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // Mostra o modal
Â  Â  Â  Â  Â  Â document.getElementById('registrationModal').classList.remove('hidden', 'scale-95', 'opacity-0');
Â  Â  Â  Â  Â  Â document.getElementById('registrationOverlay').classList.remove('hidden');
Â  Â  Â  Â }

Â  Â  Â  Â function closeProfileEditor() {
Â  Â  Â  Â  Â  Â // Esconde o modal
Â  Â  Â  Â  Â  Â const registrationModal = document.getElementById('registrationModal');
Â  Â  Â  Â  Â  Â const registrationOverlay = document.getElementById('registrationOverlay');
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â registrationModal.classList.add('scale-95', 'opacity-0');
Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â registrationModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â registrationOverlay.classList.add('hidden');
Â  Â  Â  Â  Â  Â }, 150);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // Restaura a UI para os dados salvos (desfazendo mudanÃ§as nÃ£o salvas)
Â  Â  Â  Â  Â  Â loadProfileUI(currentProfileData);
Â  Â  Â  Â }


Â  Â  Â  Â // --- SALVA O PERFIL (FOTO E DADOS) ---
Â  Â  Â  Â async function handleSaveProfile() {
Â  Â  Â  Â  Â  Â clearRegistrationError();
Â  Â  Â  Â  Â  Â const username = document.getElementById('usernameInput').value;
Â  Â  Â  Â  Â  Â const phone = document.getElementById('phoneInput').value;

Â  Â  Â  Â  Â  Â if (!username) {
Â  Â  Â  Â  Â  Â  Â  Â showRegistrationError("Por favor, insira um nome de usuÃ¡rio.");
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â const saveButton = document.getElementById('saveProfileButton');
Â  Â  Â  Â  Â  Â const buttonText = saveButton.querySelector('span');
Â  Â  Â  Â  Â  Â const spinner = saveButton.querySelector('svg');

Â  Â  Â  Â  Â  Â // Ativa o loading
Â  Â  Â  Â  Â  Â buttonText.textContent = "Salvando...";
Â  Â  Â  Â  Â  Â spinner.classList.remove('hidden');
Â  Â  Â  Â  Â  Â saveButton.disabled = true;

Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â // 1. Prepara dados para salvar (mescla com dados existentes)
Â  Â  Â  Â  Â  Â  Â  Â const dataToSave = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ...currentProfileData, // MantÃ©m dados antigos (como 'createdAt')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â username: username,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â phone: phone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lastUpdatedAt: new Date() // Adiciona/atualiza data de modificaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â // Se for a primeira vez, adiciona data de criaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â if (!currentProfileData.createdAt) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dataToSave.createdAt = new Date();
Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â // 2. Salva os dados (nome, telefone) no Firestore (NOVO CAMINHO)
Â  Â  Â  Â  Â  Â  Â  Â const profileRef = doc(db, "users", userId, "profile", "data");
Â  Â  Â  Â  Â  Â  Â  Â await setDoc(profileRef, dataToSave, { merge: true });

Â  Â  Â  Â  Â  Â  Â  Â console.log("Perfil salvo no Firestore!");

Â  Â  Â  Â  Â  Â  Â  Â // 3. Atualiza a UI do perfil com os novos dados
Â  Â  Â  Â  Â  Â  Â  Â loadProfileUI(dataToSave);
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â // 4. Carrega os dados locais (refeiÃ§Ãµes, metas) se for a primeira vez
Â  Â  Â  Â  Â  Â  Â  Â if (!historyLog || Object.keys(historyLog).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadDataFromLocalStorage();
Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â // 5. Esconde o modal e mostra o app principal (caso estivesse escondido)
Â  Â  Â  Â  Â  Â  Â  Â closeProfileEditor(); // Reutiliza a funÃ§Ã£o de fechar
Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('main-app-content').classList.remove('hidden');

Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao salvar perfil no Firestore:", error);
Â  Â  Â  Â  Â  Â  Â  Â showRegistrationError(`Erro ao salvar: ${error.message}. Tente novamente.`);
Â  Â  Â  Â  Â  Â } finally {
Â  Â  Â  Â  Â  Â  Â  Â // Desativa o loading
Â  Â  Â  Â  Â  Â  Â  Â // (O texto do botÃ£o serÃ¡ corrigido na prÃ³xima vez que abrir o modal)
Â  Â  Â  Â  Â  Â  Â  Â spinner.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â saveButton.disabled = false;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â // --- MANIPULA A SELEÃ‡ÃƒO DA FOTO DE PERFIL ---
Â  Â  Â  Â function handleProfilePicChange(event) {
Â  Â  Â  Â  Â  Â clearRegistrationError();
Â  Â  Â  Â  Â  Â const file = event.target.files[0];
Â  Â  Â  Â  Â  Â if (!file) return;

Â  Â  Â  Â  Â  Â if (file.size > 5 * 1024 * 1024) {
Â  Â  Â  Â  Â  Â  Â  Â showRegistrationError("A imagem Ã© muito grande (limite de 5MB).");
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â const reader = new FileReader();
Â  Â  Â  Â  Â  Â reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â const dataURL = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(`treinoProfilePic_${userId}`, dataURL);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('profilePicPreview').src = dataURL;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Atualiza a foto principal imediatamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('displayProfilePic').src = dataURL;
Â  Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao salvar foto no localStorage (provavelmente cheio):", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showRegistrationError("NÃ£o foi possÃ­vel salvar sua foto. Armazenamento cheio?");
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â reader.readAsDataURL(file);
Â  Â  Â  Â }

Â  Â  Â  Â // --- REGISTRA OS HANDLERS DO FIREBASE GLOBALMENTE ---
Â  Â  Â  Â window.handleSaveProfile = handleSaveProfile;
Â  Â  Â  Â window.handleProfilePicChange = handleProfilePicChange;
Â  Â  Â  Â window.openProfileEditor = openProfileEditor;
Â  Â  Â  Â window.closeProfileEditor = closeProfileEditor;
Â  Â  Â  Â 
Â  Â  Â  Â document.addEventListener('DOMContentLoaded', initializeFirebase);
Â  Â  Â  Â 
Â  Â </script>
Â  Â 
Â  Â <style>
Â  Â  Â  Â /* Define a fonte Inter como padrÃ£o */
Â  Â  Â  Â @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
Â  Â  Â  Â body {
Â  Â  Â  Â  Â  Â font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â scroll-behavior: smooth;
Â  Â  Â  Â }
Â  Â  Â  Â /* Remove as setas do input number */
Â  Â  Â  Â input::-webkit-outer-spin-button,
Â  Â  Â  Â input::-webkit-inner-spin-button {
Â  Â  Â  Â  Â  Â -webkit-appearance: none;
Â  Â  Â  Â  Â  Â margin: 0;
Â  Â  Â  Â }
Â  Â  Â  Â input[type=number] {
Â  Â  Â  Â  Â  Â -moz-appearance: textfield;
Â  Â  Â  Â }
Â  Â  Â  Â /* Estilo para a barra de progresso */
Â  Â  Â  Â #calorieProgress {
Â  Â  Â  Â  Â  Â transition: width 0.3s ease-in-out;
Â  Â  Â  Â }
Â  Â  Â  Â /* Estilo para a lista de alimentos para evitar encolhimento */
Â  Â  Â  Â #foodList {
Â  Â  Â  Â  Â  Â min-height: 12rem; /* 192px */
Â  Â  Â  Â }
Â  Â  Â  Â /* Estilo para o spinner de carregamento */
Â  Â  Â  Â .spinner {
Â  Â  Â  Â  Â  Â border-top-color: transparent;
Â  Â  Â  Â  Â  Â animation: spin 1s linear infinite;
Â  Â  Â  Â }
Â  Â  Â  Â @keyframes spin {
Â  Â  Â  Â  Â  Â to {
Â  Â  Â  Â  Â  Â  Â  Â transform: rotate(360deg);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }
Â  Â </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex items-start justify-center p-4 py-8">

Â  Â <!-- 1. TELA DE LOADING INICIAL DO APP -->
Â  Â <div id="app-loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
Â  Â  Â  Â <div class="spinner w-12 h-12 border-4 border-blue-500 rounded-full"></div>
Â  Â  Â  Â <p id="app-loading-text" class="text-lg text-gray-700 font-medium mt-4">Conectando ao app...</p>
Â  Â </div>

Â  Â <!-- 2. MODAL DE CADASTRO/EDIÃ‡ÃƒO DE PERFIL -->
Â  Â <div id="registrationOverlay" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden transition-opacity"></div>
Â  Â <div id="registrationModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-md p-6 sm:p-8 rounded-2xl shadow-xl z-50 hidden transition-transform scale-95 opacity-0">
Â  Â  Â  Â <!-- TÃTULO DO MODAL (DINÃ‚MICO) -->
Â  Â  Â  Â <h2 id="registrationModalTitle" class="text-2xl font-bold text-center text-gray-800 mb-6">Crie seu Perfil</h2>
Â  Â  Â  Â 
Â  Â  Â  Â <!-- FormulÃ¡rio de Perfil -->
Â  Â  Â  Â <div class="space-y-4">
Â  Â  Â  Â  Â  Â <!-- SeÃ§Ã£o da Foto -->
Â  Â  Â  Â  Â  Â <div class="flex flex-col items-center space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â <img id="profilePicPreview" src="https://placehold.co/100x100/e2e8f0/718096?text=Foto" alt="Foto do Perfil" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â <label for="profilePicInput" class="cursor-pointer text-sm font-medium text-blue-600 hover:text-blue-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Selecionar Foto
Â  Â  Â  Â  Â  Â  Â  Â </label>
Â  Â  Â  Â  Â  Â  Â  Â <input type="file" id="profilePicInput" class="hidden" accept="image/*" onchange="handleProfilePicChange(event)">
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <!-- Campo de UsuÃ¡rio -->
Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â <label for="usernameInput" class="block text-sm font-medium text-gray-700">Nome de UsuÃ¡rio *</label>
Â  Â  Â  Â  Â  Â  Â  Â <input type="text" id="usernameInput" placeholder="Como quer ser chamado?" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â <!-- Campo de Telefone -->
Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â <label for="phoneInput" class="block text-sm font-medium text-gray-700">Telefone (Opcional)</label>
Â  Â  Â  Â  Â  Â  Â  Â <input type="tel" id="phoneInput" placeholder="(00) 00000-0000" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â <!-- Mensagem de Erro -->
Â  Â  Â  Â  Â  Â <p id="registrationError" class="text-sm text-center text-red-600 font-medium hidden"></p>

Â  Â  Â  Â  Â  Â <!-- BotÃ£o Salvar (DinÃ¢mico) -->
Â  Â  Â  Â  Â  Â <button id="saveProfileButton" onclick="handleSaveProfile()" class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-70">
Â  Â  Â  Â  Â  Â  Â  Â <svg class="spinner w-5 h-5 mr-3 border-2 border-white rounded-full hidden" role="status" aria-hidden="true"></svg>
Â  Â  Â  Â  Â  Â  Â  Â <span id="saveProfileButtonText">ComeÃ§ar a Usar</span>
Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <!-- BotÃ£o Cancelar (NOVO) -->
Â  Â  Â  Â  Â  Â <button id="cancelEditButton" onclick="closeProfileEditor()" type="button" class="w-full text-center text-sm font-medium text-gray-700 hover:text-gray-900 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â Cancelar
Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â </div>
Â  Â </div>


Â  Â <!-- 3. CONTEÃšDO PRINCIPAL DO APP -->
Â  Â <div id="main-app-content" class="bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-xl space-y-6 hidden">
Â  Â  Â  Â 
Â  Â  Â  Â <!-- TÃTULO PRINCIPAL (NOVA COR) -->
Â  Â  Â  Â <h1 class="text-3xl font-bold text-center text-green-600">
Â  Â  Â  Â  Â  Â Assistente de Treino
Â  Â  Â  Â </h1>

Â  Â  Â  Â <!-- SEÃ‡ÃƒO DE PERFIL DO USUÃRIO (ATUALIZADA) -->
Â  Â  Â  Â <div id="profile-display-section" class="hidden flex items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
Â  Â  Â  Â  Â  Â <img id="displayProfilePic" src="https://placehold.co/100x100/e2e8f0/718096?text=Foto" alt="Sua Foto" class="w-16 h-16 rounded-full object-cover border-2 border-blue-200">
Â  Â  Â  Â  Â  Â <div class="ml-4 flex-grow min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â <h2 id="displayUsername" class="text-xl font-bold text-gray-800 truncate">Carregando...</h2>
Â  Â  Â  Â  Â  Â  Â  Â <!-- ID OCULTO (hidden) CONFORME SOLICITADO -->
Â  Â  Â  Â  Â  Â  Â  Â <p id="displayUserId" class="text-xs text-gray-500 break-all hidden">Carregando ID...</p>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â <!-- BOTÃƒO EDITAR -->
Â  Â  Â  Â  Â  Â <button id="editProfileButton" onclick="openProfileEditor()" class="ml-4 flex-shrink-0 text-sm font-medium text-blue-600 hover:text-blue-700">
Â  Â  Â  Â  Â  Â  Â  Â Editar
Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â </div>


Â  Â  Â  Â <!-- SeÃ§Ã£o: Minhas Metas -->
Â  Â  Â  Â <details class="bg-gray-50 p-4 rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â <summary class="text-xl font-semibold text-gray-700 cursor-pointer list-none">
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span>Minhas Metas</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-sm font-normal text-blue-600">[Clique para expandir/fechar]</span>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â </summary>
Â  Â  Â  Â  Â  Â <div id="profileForm" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="weight" class="block text-sm font-medium text-gray-700">Peso (kg)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="number" id="weight" placeholder="70" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="height" class="block text-sm font-medium text-gray-700">Altura (cm)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="number" id="height" placeholder="175" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="age" class="block text-sm font-medium text-gray-700">Idade</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="number" id="age" placeholder="25" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="col-span-2 sm:col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="gender" class="block text-sm font-medium text-gray-700">GÃªnero</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <select id="gender" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="male">Masculino</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="female">Feminino</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="col-span-2 sm:col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="activity" class="block text-sm font-medium text-gray-700">NÃ­vel de Atividade</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <select id="activity" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="1.2">SedentÃ¡rio (pouco ou nenhum)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="1.375">Leve (1-3 dias/semana)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="1.55" selected>Moderado (3-5 dias/semana)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="1.725">Ativo (6-7 dias/semana)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="1.9">Muito Ativo (trabalho fÃ­sico + treino)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â <div class="col-span-2 sm:col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="goalType" class="block text-sm font-medium text-gray-700">Meu Objetivo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <select id="goalType" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="ganhar">Ganhar Massa (Bulking)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="manter">Manter Peso (ManutenÃ§Ã£o)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="perder">Perder Peso (Cutting)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â  Â  Â <button id="calculateButton" class="col-span-2 sm:col-span-3 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Calcular e Salvar Meta
Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <div class="mt-6 border-t border-gray-200 pt-4">
Â  Â  Â  Â  Â  Â  Â  Â <h4 class="text-sm font-semibold text-gray-600 mb-3 text-center">Backup de Dados Locais</h4>
Â  Â  Â  Â  Â  Â  Â  Â <div class="grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="exportButton" class="w-full bg-gray-600 text-white font-medium py-2 px-3 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Exportar Dados
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="importFile" class="w-full bg-gray-200 text-gray-800 font-medium py-2 px-3 rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors cursor-pointer text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Importar Dados
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="file" id="importFile" class="hidden" accept=".json,application/json">
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <p class="text-xs text-gray-500 mt-2 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Salve seu progresso em um arquivo.
Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <p id="goalText" class="text-center text-lg font-semibold text-green-700 mt-4 hidden"></p>
Â  Â  Â  Â </details>

Â  Â  Â  Â <!-- SeÃ§Ã£o: Adicionar Alimento -->
Â  Â  Â  Â <div id="addFoodSection" class="transition-opacity duration-300">
Â  Â  Â  Â  Â  Â <h2 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Alimento</h2>
Â  Â  Â  Â  Â  Â <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-start">
Â  Â  Â  Â  Â  Â  Â  Â <div class="relative sm:col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="foodSearch" class="block text-sm font-medium text-gray-700 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 1. Pesquisar Alimento
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â type="text"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="foodSearch"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Digite o nome do alimento..."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â autocomplete="off"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="searchDropdown" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-48 overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â  Â  Â <div class="sm:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="mealTimeSelect" class="block text-sm font-medium text-gray-700 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 2. Escolher RefeiÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <select id="mealTimeSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="cafe_da_manha">CafÃ© da ManhÃ£</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="almoco">AlmoÃ§o</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="lanche">Lanche</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="jantar">Jantar</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="ceia">Ceia</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â <div class="sm:col-span-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="foodQuantity" class="block text-sm font-medium text-gray-700 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 3. Qtd.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â type="number"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="foodQuantity"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Qtd."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â min="0"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â step="0.1"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â >
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â <div id="mealSuggestion" class="text-sm text-gray-600 mt-1 sm:col-span-3 px-1">
Â  Â  Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â  Â  Â <button id="addFoodButton" class="sm:col-span-3 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors mt-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Adicionar Alimento
Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â <button id="shareButton" class="sm:col-span-3 w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 transition-colors mt-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Compartilhar Resumo no WhatsApp
Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â </div>

Â  Â  Â  Â <!-- SeÃ§Ã£o: HistÃ³rico -->
Â  Â  Â  Â <div class="border-t border-b border-gray-200 py-4">
Â  Â  Â  Â  Â  Â <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  Â  Â <label for="historySelect" class="text-xl font-semibold text-gray-700">DiÃ¡rio</label>
Â  Â  Â  Â  Â  Â  Â  Â <button id="clearButton" class="text-sm text-red-500 hover:text-red-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Limpar dia selecionado
Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â <select id="historySelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â <p id="historyWarning" class="text-sm text-center text-orange-600 font-medium mt-2 hidden">
Â  Â  Â  Â  Â  Â  Â  Â Modo de visualizaÃ§Ã£o. Para adicionar itens, selecione "Hoje".
Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â </div>


Â  Â  Â  Â <!-- Lista de Alimentos Adicionados -->
Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â <h3 id="foodListTitle" class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â <span>Suas RefeiÃ§Ãµes (Hoje):</span>
Â  Â  Â  Â  Â  Â  Â  Â <span id="goalTag" class="hidden text-xs sm:text-sm font-medium text-blue-700 bg-blue-100 py-0.5 px-3 rounded-full"></span>
Â  Â  Â  Â  Â  Â </h3>
Â  Â  Â  Â  Â  Â <div id="foodList" class="overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-4 bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  Â <p id="emptyListText" class="text-gray-400 text-center mt-4">Nenhum alimento adicionado ainda.</p>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â </div>

Â  Â  Â  Â <!-- Divisor -->
Â  Â  Â  Â <hr class="border-t border-gray-200">

Â  Â  Â  Â <!-- Resumo -->
Â  Â  Â  Â <div class="space-y-4">
Â  Â  Â  Â  Â  Â <h2 class="text-xl font-semibold text-gray-800 text-center">Resumo do Dia</h2>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-center mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-base font-medium text-orange-600">Calorias</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span id="totalCalsGoalText" class="text-sm font-medium text-gray-600">0 / 0 kcal</span>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="calorieProgress" class="bg-orange-500 h-4 rounded-full" style="width: 0%"></div>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â <div class="grid grid-cols-2 gap-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-base font-medium text-emerald-600 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ProteÃ­nas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p id="totalProteins" class="text-3xl font-bold text-emerald-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 0 g
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-base font-medium text-blue-600 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Carboidratos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p id="totalCarbs" class="text-3xl font-bold text-blue-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 0 g
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â </div>

Â  Â </div>

Â  Â <!-- Modal de Aviso de Limite -->
Â  Â <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden transition-opacity"></div>
Â  Â <div id="warningModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden transition-transform scale-95 opacity-0">
Â  Â  Â  Â <div class="text-center">
Â  Â  Â  Â  Â  Â <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
Â  Â  Â  Â  Â  Â  Â  Â <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
Â  Â  Â  Â  Â  Â  Â  Â </svg>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â <h3 class="text-2xl font-bold text-gray-800 mt-4">Meta Atingida!</h3>
Â  Â  Â  Â  Â  Â <p class="text-base text-gray-600 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â VocÃª ultrapassou sua meta de calorias do dia.
Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â <p id="modalGoalText" class="text-sm text-gray-500 mt-1"></p>
Â  Â  Â  Â  Â  Â <button id="closeModalButton" class="mt-6 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â Entendi
Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â </div>
Â  Â </div>
Â  Â <!-- Fim do Modal -->

Â  Â <script>
Â  Â  Â  Â // "Banco de dados" de alimentos
Â  Â  Â  Â const foodDatabase = {
Â  Â  Â  Â  Â  Â 'banana': { name: 'Banana', protein: 1.1, carbs: 27, cals: 105, unit: 'unidade', visceralFat: false },
Â  Â  Â  Â  Â  Â 'maca': { name: 'MaÃ§Ã£', protein: 0.3, carbs: 25, cals: 95, unit: 'unidade', visceralFat: false },
Â  Â  Â  Â  Â  Â 'abacate': { name: 'Abacate', protein: 2, carbs: 9, cals: 160, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'mamao': { name: 'MamÃ£o Formosa', protein: 0.5, carbs: 11, cals: 43, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'melancia': { name: 'Melancia', protein: 0.6, carbs: 8, cals: 30, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'uva': { name: 'Uva', protein: 0.7, carbs: 18, cals: 69, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'laranja': { name: 'Laranja', protein: 1, carbs: 12, cals: 47, unit: 'unidade', visceralFat: false },
Â  Â  Â  Â  Â  Â 'morango': { name: 'Morango', protein: 0.7, carbs: 8, cals: 32, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'brocolis': { name: 'BrÃ³colis (cozido)', protein: 2.4, carbs: 7, cals: 35, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'alface': { name: 'Alface Crespa', protein: 1.4, carbs: 2.9, cals: 15, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'tomate': { name: 'Tomate', protein: 0.9, carbs: 3.9, cals: 18, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'cenoura': { name: 'Cenoura (crua)', protein: 0.9, carbs: 10, cals: 41, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'cebola': { name: 'Cebola', protein: 1.1, carbs: 9, cals: 40, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'couve_flor': { name: 'Couve-flor (cozida)', protein: 1.9, carbs: 5, cals: 25, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'peito_frango': { name: 'Peito de Frango (grelhado)', protein: 31, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'ovo': { name: 'Ovo Cozido', protein: 6.3, carbs: 0.6, cals: 77, unit: 'unidade', visceralFat: false },
Â  Â  Â  Â  Â  Â 'ovo_frito': { name: 'Ovo Frito (em Ã³leo)', protein: 6.2, carbs: 0.6, cals: 95, unit: 'unidade', visceralFat: false },
Â  Â  Â  Â  Â  Â 'ovos_mexidos': { name: 'Ovos Mexidos (c/ manteiga)', protein: 6.5, carbs: 1.5, cals: 105, unit: 'unidade (1 ovo)', visceralFat: true },
Â  Â  Â  Â  Â  Â 'whey_protein': { name: 'Whey Protein', protein: 24, carbs: 3, cals: 120, unit: 'scoop 30g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'carne_moida': { name: 'Carne MoÃ­da (patinho, cozida)', protein: 26, carbs: 0, cals: 180, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'bife_alcatra': { name: 'Bife (Alcatra, grelhado)', protein: 28, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'tilapia': { name: 'TilÃ¡pia (grelhada)', protein: 26, carbs: 0, cals: 128, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'salmao': { name: 'SalmÃ£o (grelhado)', protein: 20, carbs: 0, cals: 208, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'atum_lata': { name: 'Atum em Lata (em Ã³leo)', protein: 29, carbs: 0, cals: 186, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'tofu': { name: 'Tofu', protein: 8, carbs: 2.8, cals: 76, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'leite_integral': { name: 'Leite Integral', protein: 3.2, carbs: 5, cals: 61, unit: '100ml', visceralFat: true },
Â  Â  Â  Â  Â  Â 'leite_desnatado': { name: 'Leite Desnatado', protein: 3.4, carbs: 5, cals: 35, unit: '100ml', visceralFat: false },
Â  Â  Â  Â  Â  Â 'queijo_mussarela': { name: 'Queijo Mussarela', protein: 22, carbs: 3.1, cals: 300, unit: '100g (fatia 30g)', visceralFat: true },
Â  Â  Â  Â  Â  Â 'queijo_minas': { name: 'Queijo Minas Frescal', protein: 17, carbs: 3, cals: 264, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'iogurte_grego': { name: 'Iogurte Grego (natural)', protein: 10, carbs: 3.6, cals: 59, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'iogurte_natural': { name: 'Iogurte Natural Desnatado', protein: 4.1, carbs: 7, cals: 57, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'arroz_branco': { name: 'Arroz Branco (cozido)', protein: 2.7, carbs: 28, cals: 130, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'arroz_integral': { name: 'Arroz Integral (cozido)', protein: 2.6, carbs: 23, cals: 111, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'pao_forma': { name: 'PÃ£o de Forma (Branco)', protein: 2.5, carbs: 15, cals: 80, unit: 'fatia', visceralFat: true },
Â  Â  Â  Â  Â  Â 'pao_integral': { name: 'PÃ£o de Forma (Integral)', protein: 3, carbs: 12, cals: 70, unit: 'fatia', visceralFat: false },
Â  Â  Â  Â  Â  Â 'batata_doce': { name: 'Batata Doce (cozida)', protein: 1.6, carbs: 20, cals: 86, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'batata_inglesa': { name: 'Batata Inglesa (cozida)', protein: 2, carbs: 20, cals: 87, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'feijao_preto': { name: 'FeijÃ£o Preto (cozido)', protein: 9, carbs: 24, cals: 131, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'feijao_carioca': { name: 'FeijÃ£o Carioca (cozido)', protein: 4.8, carbs: 14, cals: 76, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'aveia': { name: 'Aveia em Flocos', protein: 17, carbs: 66, cals: 389, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'macarrao': { name: 'MacarrÃ£o (cozido)', protein: 5, carbs: 25, cals: 131, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'cuscuz': { name: 'Cuscuz (hidratado)', protein: 3.8, carbs: 23, cals: 112, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'tapioca': { name: 'Tapioca (goma)', protein: 0, carbs: 89, cals: 355, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'pasta_amendoim': { name: 'Pasta de Amendoim (integral)', protein: 25, carbs: 20, cals: 588, unit: '100g (colher 15g)', visceralFat: false },
Â  Â  Â  Â  Â  Â 'azeite': { name: 'Azeite de Oliva', protein: 0, carbs: 0, cals: 119, unit: 'colher sopa', visceralFat: false },
Â  Â  Â  Â  Â  Â 'castanha_caju': { name: 'Castanha de Caju', protein: 18, carbs: 30, cals: 553, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'amendoim': { name: 'Amendoim', protein: 26, carbs: 16, cals: 567, unit: '100g', visceralFat: false },
Â  Â  Â  Â  Â  Â 'manteiga': { name: 'Manteiga com sal', protein: 0.9, carbs: 0.1, cals: 717, unit: '100g (colher 5g)', visceralFat: true },
Â  Â  Â  Â  Â  Â 'refrigerante': { name: 'Refrigerante (Cola)', protein: 0, carbs: 26, cals: 105, unit: 'lata 350ml', visceralFat: true },
Â  Â  Â  Â  Â  Â 'chocolate_ao_leite': { name: 'Chocolate ao Leite', protein: 8, carbs: 59, cals: 535, unit: '100g (barra 25g)', visceralFat: true },
Â  Â  Â  Â  Â  Â 'biscoito_recheado': { name: 'Biscoito Recheado (Chocolate)', protein: 5, carbs: 70, cals: 450, unit: '100g (unid 10g)', visceralFat: true },
Â  Â  Â  Â  Â  Â 'pizza_mussarela': { name: 'Pizza Mussarela', protein: 11, carbs: 33, cals: 271, unit: '100g (1 fatia)', visceralFat: true },
Â  Â  Â  Â  Â  Â 'mel': { name: 'Mel', protein: 0.3, carbs: 82, cals: 304, unit: '100g', visceralFat: true },
Â  Â  Â  Â  Â  Â 'cafe_preto': { name: 'CafÃ© Preto (sem aÃ§Ãºcar)', protein: 0.1, carbs: 0, cals: 2, unit: 'xÃ­cara', visceralFat: false }
Â  Â  Â  Â };

Â  Â  Â  Â // --- VariÃ¡veis Globais de Estado ---
Â  Â  Â  Â // A variÃ¡vel 'userId' Ã© definida globalmente pelo script do Firebase
Â  Â  Â  Â let historyLog = {};
Â  Â  Â  Â let dailyLog = {};
Â  Â  Â  Â let calorieGoal = 0;
Â  Â  Â  Â let selectedFoodKey = null;
Â  Â  Â  Â const todayString = new Date().toISOString().split('T')[0];
Â  Â  Â  Â let selectedDate = todayString;
Â  Â  Â  Â let goalExceededNotified = false;

Â  Â  Â  Â const mealDisplayNames = {
Â  Â  Â  Â  Â  Â cafe_da_manha: "â˜• CafÃ© da ManhÃ£",
Â  Â  Â  Â  Â  Â almoco: "ğŸ½ï¸ AlmoÃ§o",
Â  Â  Â  Â  Â  Â lanche: "ğŸ Lanche",
Â  Â  Â  Â  Â  Â jantar: "ğŸ² Jantar",
Â  Â  Â  Â  Â  Â ceia: "ğŸŒ™ Ceia"
Â  Â  Â  Â };
Â  Â  Â  Â const goalDisplayNames = {
Â  Â  Â  Â  Â  Â ganhar: 'Ganho de Massa',
Â  Â  Â  Â  Â  Â manter: 'ManutenÃ§Ã£o',
Â  Â  Â  Â  Â  Â perder: 'Perda de Peso'
Â  Â  Â  Â };
Â  Â  Â  Â const mealSuggestions = {
Â  Â  Â  Â  Â  Â ganhar: {
Â  Â  Â  Â  Â  Â  Â  Â cafe_da_manha: "Ex: Ovos, Aveia, Banana, Whey Protein.",
Â  Â  Â  Â  Â  Â  Â  Â almoco: "Ex: Arroz, Peito de Frango, FeijÃ£o, Batata Doce.",
Â  Â  Â  Â  Â  Â  Â  Â lanche: "Ex: PÃ£o Integral, Pasta de Amendoim, Iogurte Grego.",
Â  Â  Â  Â  Â  Â  Â  Â jantar: "Ex: MacarrÃ£o, Carne MoÃ­da, Salada com Azeite.",
Â  Â  Â  Â  Â  Â  Â  Â ceia: "Ex: Abacate, Castanhas, Queijo Minas."
Â  Â  Â  Â  Â  Â },
Â  Â  Â  Â  Â  Â perder: {
Â  Â  Â  Â  Â  Â  Â  Â cafe_da_manha: "Ex: Ovos, Morangos, CafÃ© Preto, Iogurte Natural.",
Â  Â  Â  Â  Â  Â  Â  Â almoco: "Ex: Salada, TilÃ¡pia, BrÃ³colis, Pouco Arroz Integral.",
Â  Â  Â  Â  Â  Â  Â  Â lanche: "Ex: MaÃ§Ã£, Queijo Minas, Castanhas (pouco).",
Â  Â  Â  Â  Â  Â  Â  Â jantar: "Ex: Sopa de legumes, Peito de Frango, Alface.",
Â  Â  Â  Â  Â  Â  Â  Â ceia: "Ex: ChÃ¡, Tofu."
Â  Â  Â  Â  Â  Â },
Â  Â  Â  Â  Â  Â manter: {
Â  Â  Â  Â  Â  Â  Â  Â cafe_da_manha: "RefeiÃ§Ã£o balanceada. Ex: PÃ£o Integral, Ovos, MamÃ£o.",
Â  Â  Â  Â  Â  Â  Â  Â almoco: "Equilibre prato. Ex: Arroz, FeijÃ£o, Bife, Salada.",
Â  Â  Â  Â  Â  Â  Â  Â lanche: "Ex: Uvas, Iogurte, Aveia.",
Â  Â  Â  Â  Â  Â  Â  Â jantar: "RefeiÃ§Ã£o leve. Ex: Batata Doce, Frango, BrÃ³colis.",
Â  Â  Â  Â  Â  Â  Â  Â ceia: "Opcional. Ex: Leite Desnatado."
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â };

Â  Â  Â  Â // Seletores do DOM - Perfil
Â  Â  Â  Â const weightInput = document.getElementById('weight');
Â  Â  Â  Â const heightInput = document.getElementById('height');
Â  Â  Â  Â const ageInput = document.getElementById('age');
Â  Â  Â  Â const genderSelect = document.getElementById('gender');
Â  Â  Â  Â const activitySelect = document.getElementById('activity');
Â  Â  Â  Â const goalTypeSelect = document.getElementById('goalType');
Â  Â  Â  Â const calculateButton = document.getElementById('calculateButton');
Â  Â  Â  Â const goalText = document.getElementById('goalText');
Â  Â  Â  Â const exportButton = document.getElementById('exportButton');
Â  Â  Â  Â const importFile = document.getElementById('importFile');

Â  Â  Â  Â // Seletores do DOM - Log
Â  Â  Â  Â const addFoodSection = document.getElementById('addFoodSection');
Â  Â  Â  Â const foodSearchInput = document.getElementById('foodSearch');
Â  Â  Â  Â const searchDropdown = document.getElementById('searchDropdown');
Â  Â  Â  Â const mealTimeSelect = document.getElementById('mealTimeSelect');
Â  Â  Â  Â const foodQuantityInput = document.getElementById('foodQuantity');
Â  Â  Â  Â const mealSuggestion = document.getElementById('mealSuggestion');
Â  Â  Â  Â const addFoodButton = document.getElementById('addFoodButton');
Â  Â  Â  Â 
Â  Â  Â  Â // Seletores do DOM - HistÃ³rico
Â  Â  Â  Â const historySelect = document.getElementById('historySelect');
Â  Â  Â  Â const historyWarning = document.getElementById('historyWarning');
Â  Â  Â  Â const foodListTitle = document.getElementById('foodListTitle');
Â  Â  Â  Â const goalTag = document.getElementById('goalTag');

Â  Â  Â  Â // Seletores do DOM - Lista e Totais
Â  Â  Â  Â const foodListContainer = document.getElementById('foodList');
Â  Â  Â  Â const emptyListText = document.getElementById('emptyListText');
Â  Â  Â  Â const totalProteinsEl = document.getElementById('totalProteins');
Â  Â  Â  Â const totalCarbsEl = document.getElementById('totalCarbs');
Â  Â  Â  Â const totalCalsGoalText = document.getElementById('totalCalsGoalText');
Â  Â  Â  Â const calorieProgress = document.getElementById('calorieProgress');
Â  Â  Â  Â const shareButton = document.getElementById('shareButton');
Â  Â  Â  Â const clearButton = document.getElementById('clearButton');

Â  Â  Â  Â // Seletores do Modal
Â  Â  Â  Â const modalOverlay = document.getElementById('modalOverlay');
Â  Â  Â  Â const warningModal = document.getElementById('warningModal');
Â  Â  Â  Â const closeModalButton = document.getElementById('closeModalButton');
Â  Â  Â  Â const modalGoalText = document.getElementById('modalGoalText');

Â  Â  Â  Â // --- FunÃ§Ãµes de Salvamento (COM NAMESPACE DE USUÃRIO) ---
Â  Â  Â  Â function saveProfile() {
Â  Â  Â  Â  Â  Â if (!window.userId) return;
Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â const profile = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â weight: weightInput.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â height: heightInput.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â age: ageInput.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â gender: genderSelect.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â activity: activitySelect.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â goalType: goalTypeSelect.value
Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(`treinoProfile_${window.userId}`, JSON.stringify(profile));
Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(`treinoGoal_${window.userId}`, calorieGoal.toString());
Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao salvar perfil no localStorage:", e);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function saveLog() {
Â  Â  Â  Â  Â  Â if (!window.userId) return;
Â  Â  Â  Â  Â  Â historyLog[selectedDate] = dailyLog;
Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(`treinoHistory_${window.userId}`, JSON.stringify(historyLog));
Â  Â  Â  Â  Â  Â  Â  Â populateHistoryDropdown();
Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao salvar log no localStorage:", e);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â // --- FunÃ§Ã£o de Carregamento Principal (COM NAMESPACE) ---
Â  Â  Â  Â function loadDataFromLocalStorage() {
Â  Â  Â  Â  Â  Â if (!window.userId) return;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â // Carrega Perfil (Metas)
Â  Â  Â  Â  Â  Â  Â  Â const savedProfile = JSON.parse(localStorage.getItem(`treinoProfile_${window.userId}`));
Â  Â  Â  Â  Â  Â  Â  Â if (savedProfile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â weightInput.value = savedProfile.weight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â heightInput.value = savedProfile.height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ageInput.value = savedProfile.age;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â genderSelect.value = savedProfile.gender;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â activitySelect.value = savedProfile.activity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â goalTypeSelect.value = savedProfile.goalType || 'ganhar';
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â // Carrega Meta (Calorias)
Â  Â  Â  Â  Â  Â  Â  Â calorieGoal = parseFloat(localStorage.getItem(`treinoGoal_${window.userId}`)) || 0;
Â  Â  Â  Â  Â  Â  Â  Â if (calorieGoal > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedGoalType = savedProfile?.goalType || 'ganhar';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedGoalName = goalDisplayNames[savedGoalType];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  goalText.textContent = `Sua meta (${savedGoalName}): ${calorieGoal.toFixed(0)} kcal/dia`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  goalText.classList.remove('hidden', 'text-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  goalText.classList.add('text-green-700');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  goalTag.textContent = savedGoalName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  goalTag.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  goalTag.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â // Carrega HistÃ³rico de RefeiÃ§Ãµes
Â  Â  Â  Â  Â  Â  Â  Â historyLog = JSON.parse(localStorage.getItem(`treinoHistory_${window.userId}`)) || {};

Â  Â  Â  Â  Â  Â  Â  Â populateHistoryDropdown();
Â  Â  Â  Â  Â  Â  Â  Â loadLogForDate(selectedDate); // Carrega o log do dia de hoje
Â  Â  Â  Â  Â  Â  Â  Â updateMealSuggestion();

Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao carregar dados do localStorage:", e);
Â  Â  Â  Â  Â  Â  Â  Â localStorage.removeItem(`treinoProfile_${window.userId}`);
Â  Â  Â  Â  Â  Â  Â  Â localStorage.removeItem(`treinoGoal_${window.userId}`);
Â  Â  Â  Â  Â  Â  Â  Â localStorage.removeItem(`treinoHistory_${window.userId}`);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function loadLogForDate(dateString) {
Â  Â  Â  Â  Â  Â selectedDate = dateString;
Â  Â  Â  Â  Â  Â dailyLog = historyLog[dateString] || {
Â  Â  Â  Â  Â  Â  Â  Â cafe_da_manha: [], almoco: [], lanche: [], jantar: [], ceia: []
Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â renderFoodList();
Â  Â  Â  Â  Â  Â updateTotals(true);
Â  Â  Â  Â  Â  Â const isToday = (selectedDate === todayString);
Â  Â  Â  Â  Â  Â toggleInputs(isToday);
Â  Â  Â  Â  Â  Â historySelect.value = dateString;
Â  Â  Â  Â }

Â  Â  Â  Â function populateHistoryDropdown() {
Â  Â  Â  Â  Â  Â historySelect.innerHTML = '';
Â  Â  Â  Â  Â  Â const dates = Object.keys(historyLog).sort().reverse();
Â  Â  Â  Â  Â  Â if (!dates.includes(todayString)) {
Â  Â  Â  Â  Â  Â  Â  Â dates.unshift(todayString);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â if (dates.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â // Garante que "Hoje" apareÃ§a mesmo se nÃ£o houver histÃ³rico
Â  Â  Â  Â  Â  Â  Â  Â dates.push(todayString);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â let foundSelected = false;
Â  Â  Â  Â  Â  Â historySelect.innerHTML = ''; // Limpa opÃ§Ãµes
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â dates.forEach(date => {
Â  Â  Â  Â  Â  Â  Â  Â const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â option.value = date;
Â  Â  Â  Â  Â  Â  Â  Â const [year, month, day] = date.split('-');
Â  Â  Â  Â  Â  Â  Â  Â const formattedDate = `${day}/${month}/${year}`;
Â  Â  Â  Â  Â  Â  Â  Â option.textContent = (date === todayString) ? `Hoje (${formattedDate})` : formattedDate;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â if (date === selectedDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â option.selected = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â foundSelected = true;
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â historySelect.appendChild(option);
Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â // Se o 'selectedDate' (de alguma forma) nÃ£o estiver na lista, seleciona o primeiro
Â  Â  Â  Â  Â  Â if (!foundSelected && historySelect.options.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â historySelect.options[0].selected = true;
Â  Â  Â  Â  Â  Â  Â  Â selectedDate = historySelect.options[0].value;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function toggleInputs(isEnabled) {
Â  Â  Â  Â  Â  Â const currentGoalType = goalTypeSelect.value || 'ganhar';
Â  Â  Â  Â  Â  Â const currentGoalName = goalDisplayNames[currentGoalType];
Â  Â  Â  Â  Â  Â const titleTextNode = foodListTitle.querySelector('span:first-child');

Â  Â  Â  Â  Â  Â if (isEnabled) {
Â  Â  Â  Â  Â  Â  Â  Â addFoodSection.classList.remove('opacity-50', 'pointer-events-none');
Â  Â  Â  Â  Â  Â  Â  Â historyWarning.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â titleTextNode.textContent = "Suas RefeiÃ§Ãµes (Hoje):";
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â addFoodSection.classList.add('opacity-50', 'pointer-events-none');
Â  Â  Â  Â  Â  Â  Â  Â historyWarning.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â const [y, m, d] = selectedDate.split('-');
Â  Â  Â  Â  Â  Â  Â  Â titleTextNode.textContent = `RefeiÃ§Ãµes de ${d}/${m}/${y}:`;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â if (calorieGoal > 0) {
Â  Â  Â  Â  Â  Â  Â  Â goalTag.textContent = currentGoalName;
Â  Â  Â  Â  Â  Â  Â  Â goalTag.classList.remove('hidden');
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â goalTag.classList.add('hidden');
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â updateMealSuggestion();
Â  Â  Â  Â }

Â  Â  Â  Â // --- FunÃ§Ãµes do Perfil ---
Â  Â  Â  Â function calculateGoal() {
Â  Â  Â  Â  Â  Â const weight = parseFloat(weightInput.value);
Â  Â  Â  Â  Â  Â const height = parseFloat(heightInput.value);
Â  Â  Â  Â  Â  Â const age = parseFloat(ageInput.value);
Â  Â  Â  Â  Â  Â const gender = genderSelect.value;
Â  Â  Â  Â  Â  Â const activity = parseFloat(activitySelect.value);
Â  Â  Â  Â  Â  Â const goalType = goalTypeSelect.value;

Â  Â  Â  Â  Â  Â if (isNaN(weight) || isNaN(height) || isNaN(age) || weight <= 0 || height <= 0 || age <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â goalText.textContent = "Por favor, preencha todos os campos.";
Â  Â  Â  Â  Â  Â  Â  Â goalText.classList.remove('hidden', 'text-green-700');
Â  Â  Â  Â  Â  Â  Â  Â goalText.classList.add('text-red-600');
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â let bmr;
Â  Â  Â  Â  Â  Â if (gender === 'male') {
Â  Â  Â  Â  Â  Â  Â  Â bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â const tdee = bmr * activity;
Â  Â  Â  Â  Â  Â let goalName = '';
Â  Â  Â  Â  Â  Â switch (goalType) {
Â  Â  Â  Â  Â  Â  Â  Â case 'perder':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â calorieGoal = tdee - 400;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â goalName = goalDisplayNames.perder;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â  Â  Â case 'manter':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â calorieGoal = tdee;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â goalName = goalDisplayNames.manter;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â  Â  Â case 'ganhar':
Â  Â  Â  Â  Â  Â  Â  Â default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â calorieGoal = tdee + 400;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â goalName = goalDisplayNames.ganhar;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â goalText.textContent = `Sua meta (${goalName}): ${calorieGoal.toFixed(0)} kcal/dia`;
Â  Â  Â  Â  Â  Â goalText.classList.remove('hidden', 'text-red-600');
Â  Â  Â  Â  Â  Â goalText.classList.add('text-green-700');
Â  Â  Â  Â  Â  Â goalTag.textContent = goalName;
Â  Â  Â  Â  Â  Â goalTag.classList.remove('hidden');
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â saveProfile(); // Salva no localStorage com namespace
Â  Â  Â  Â  Â  Â updateTotals();
Â  Â  Â  Â  Â  Â updateMealSuggestion();
Â  Â  Â  Â }
Â  Â  Â  Â 
Â  Â  Â  Â function updateMealSuggestion() {
Â  Â  Â  Â  Â  Â if (calorieGoal === 0) {
Â  Â  Â  Â  Â  Â  Â  Â mealSuggestion.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â const goalType = goalTypeSelect.value || 'ganhar';
Â  Â  Â  Â  Â  Â const mealTime = mealTimeSelect.value || 'cafe_da_manha';
Â  Â  Â  Â  Â  Â const suggestionText = mealSuggestions[goalType][mealTime];
Â  Â  Â  Â  Â  Â mealSuggestion.innerHTML = `ğŸ’¡ <span class="font-semibold">SugestÃ£o p/ ${goalDisplayNames[goalType]}:</span> ${suggestionText}`;
Â  Â  Â  Â }

Â  Â  Â  Â // --- FunÃ§Ãµes do DiÃ¡rio ---
Â  Â  Â  Â function handleSearchInput() {
Â  Â  Â  Â  Â  Â const searchTerm = foodSearchInput.value.toLowerCase().trim();
Â  Â  Â  Â  Â  Â searchDropdown.innerHTML = '';
Â  Â  Â  Â  Â  Â if (searchTerm.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â searchDropdown.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â const filteredFoods = Object.entries(foodDatabase).filter(([key, food]) =>
Â  Â  Â  Â  Â  Â  Â  Â food.name.toLowerCase().includes(searchTerm)
Â  Â  Â  Â  Â  Â );
Â  Â  Â  Â  Â  Â if (filteredFoods.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â searchDropdown.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â filteredFoods.forEach(([key, food]) => {
Â  Â  Â  Â  Â  Â  Â  Â const tagHTML = food.visceralFat
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ? '<span class="ml-2 text-xs font-semibold text-red-600 bg-red-100 px-2 py-0.5 rounded-full">âš ï¸</span>'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : '';
Â  Â  Â  Â  Â  Â  Â  Â const itemHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100" data-key="${key}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="font-medium text-gray-800">${food.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-sm text-gray-500">(${food.unit})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${tagHTML}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â  Â searchDropdown.innerHTML += itemHTML;
Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â searchDropdown.classList.remove('hidden');
Â  Â  Â  Â }

Â  Â  Â  Â function handleSelectSearchResult(event) {
Â  Â  Â  Â  Â  Â const selectedItem = event.target.closest('[data-key]');
Â  Â  Â  Â  Â  Â if (!selectedItem) return;
Â  Â  Â  Â  Â  Â const key = selectedItem.dataset.key;
Â  Â  Â  Â  Â  Â const food = foodDatabase[key];
Â  Â  Â  Â  Â  Â selectedFoodKey = key;
Â  Â  Â  Â  Â  Â foodSearchInput.value = `${food.name} (${food.unit})`;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â if (food.unit.includes('100g')) {
Â  Â  Â  Â  Â  Â  Â  Â foodQuantityInput.value = '100';
Â  Â  Â  Â  Â  Â  Â  Â foodQuantityInput.placeholder = 'Gramas';
Â  Â  Â  Â  Â  Â } else if (food.unit.includes('colher')) {
Â  Â  Â  Â  Â  Â  Â  Â  foodQuantityInput.value = '1';
Â  Â  Â  Â  Â  Â  Â  Â  foodQuantityInput.placeholder = 'Colheres';
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â foodQuantityInput.value = '1';
Â  Â  Â  Â  Â  Â  Â  Â foodQuantityInput.placeholder = 'Unidades';
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â searchDropdown.classList.add('hidden');
Â  Â  Â  Â  Â  Â foodQuantityInput.focus();
Â  Â  Â  Â  Â  Â foodQuantityInput.select();
Â  Â  Â  Â }

Â  Â  Â  Â function handleAddFood() {
Â  Â  Â  Â  Â  Â const quantityInput = parseFloat(foodQuantityInput.value);
Â  Â  Â  Â  Â  Â const selectedMealKey = mealTimeSelect.value;
Â  Â  Â  Â  Â  Â if (!selectedFoodKey || isNaN(quantityInput) || quantityInput <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â console.warn("Tentativa de adicionar alimento invÃ¡lido.");
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  if (!dailyLog) {
Â  Â  Â  Â  Â  Â  Â  Â dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [], ceia: [] };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â const foodData = foodDatabase[selectedFoodKey];
Â  Â  Â  Â  Â  Â let calculationFactor = quantityInput;
Â  Â  Â  Â  Â  Â if (foodData.unit.includes('100g') || foodData.unit.includes('100ml')) {
Â  Â  Â  Â  Â  Â  Â  Â calculationFactor = quantityInput / 100.0;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â const itemProtein = (foodData.protein || 0) * calculationFactor;
Â  Â  Â  Â  Â  Â const itemCarbs = (foodData.carbs || 0) * calculationFactor;
Â  Â  Â  Â  Â  Â const itemCals = (foodData.cals || 0) * calculationFactor;
Â  Â  Â  Â  Â  Â let quantityDisplay;
Â  Â  Â  Â  Â  Â if (foodData.unit.includes('100g')) {
Â  Â  Â  Â  Â  Â  Â  Â quantityDisplay = `${quantityInput.toLocaleString('pt-BR')} g`;
Â  Â  Â  Â  Â  Â } else if (foodData.unit.includes('100ml')) {
Â  Â  Â  Â  Â  Â  Â  Â quantityDisplay = `${quantityInput.toLocaleString('pt-BR')} ml`;
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â quantityDisplay = `${quantityInput.toLocaleString('pt-BR')}x`;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â const logItem = {
Â  Â  Â  Â  Â  Â  Â  Â id: Date.now(),
Â  Â  Â  Â  Â  Â  Â  Â displayName: `${quantityDisplay} ${foodData.name}`,
Â  Â  Â  Â  Â  Â  Â  Â protein: itemProtein,
Â  Â  Â  Â  Â  Â  Â  Â carbs: itemCarbs,
Â  Â  Â  Â  Â  Â  Â  Â cals: itemCals,
Â  Â  Â  Â  Â  Â  Â  Â visceralFatTag: foodData.visceralFat,
Â  Â  Â  Â  Â  Â  Â  Â timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
Â  Â  Â  Â  Â  Â  Â  Â done: false
Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â if (!dailyLog[selectedMealKey]) {
Â  Â  Â  Â  Â  Â  Â  Â dailyLog[selectedMealKey] = [];
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â dailyLog[selectedMealKey].push(logItem);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â renderFoodList();
Â  Â  Â  Â  Â  Â updateTotals();
Â  Â  Â  Â  Â  Â saveLog();
Â  Â  Â  Â  Â  Â foodSearchInput.value = '';
Â  Â  Â  Â  Â  Â foodQuantityInput.value = '';
Â  Â  Â  Â  Â  Â foodQuantityInput.placeholder = 'Qtd.';
Â  Â  Â  Â  Â  Â selectedFoodKey = null;
Â  Â  Â  Â }

Â  Â  Â  Â function renderFoodList() {
Â  Â  Â  Â  Â  Â foodListContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â let totalItems = 0;
Â  Â  Â  Â  Â  Â if (dailyLog && typeof dailyLog === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â Object.entries(dailyLog).forEach(([mealKey, items]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (Array.isArray(items) && items.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalItems += items.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const mealTitle = document.createElement('h4');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mealTitle.className = "text-md font-semibold text-gray-600 pt-2";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mealTitle.textContent = mealDisplayNames[mealKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â foodListContainer.appendChild(mealTitle);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const tagHTML = item.visceralFatTag
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ? '<span class="ml-2 text-xs font-semibold text-red-600 bg-red-100 px-2 py-0.5 rounded-full">âš ï¸ Gord. Visceral</span>'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const isDone = item.done || false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const timestamp = item.timestamp ? `Ã s ${item.timestamp}` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const itemProtein = item.protein || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const itemCarbs = item.carbs || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const itemCals = item.cals || 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â itemDiv.className = "flex items-center bg-white p-3 rounded-lg shadow-sm";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â itemDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="checkbox"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="done-checkbox h-5 w-5 text-green-600 rounded border-gray-300 focus:ring-green-500"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-id="${item.id}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-meal-key="${mealKey}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isDone ? 'checked' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${selectedDate !== todayString ? 'disabled' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex-grow mx-3 min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-baseline ${isDone ? 'line-through text-gray-400' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="font-medium ${isDone ? 'text-gray-500' : 'text-gray-800'} truncate">${item.displayName}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="text-xs ${isDone ? 'text-gray-400' : 'text-gray-500'} flex-shrink-0 ml-2">${timestamp}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${tagHTML}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-sm ${isDone ? 'line-through text-gray-400' : 'text-gray-500'} mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="${isDone ? '' : 'text-emerald-600'}">${itemProtein.toFixed(1)} g prot</span> |
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="${isDone ? '' : 'text-blue-600'}">${itemCarbs.toFixed(1)} g carbs</span> |
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="${isDone ? '' : 'text-orange-600'}">${itemCals.toFixed(0)} kcal</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="remove-btn text-red-500 hover:text-red-700 font-bold text-2xl ${selectedDate !== todayString ? 'hidden' : ''}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-id="${item.id}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-meal-key="${mealKey}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â title="Remover"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Ã—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â foodListContainer.appendChild(itemDiv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â if (totalItems === 0) {
Â  Â  Â  Â  Â  Â  Â  Â emptyListText.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â foodListContainer.appendChild(emptyListText);
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â emptyListText.classList.add('hidden');
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function handleRemoveFood(event) {
Â  Â  Â  Â  Â  Â const removeBtn = event.target.closest('.remove-btn');
Â  Â  Â  Â  Â  Â if (!removeBtn) return;
Â  Â  Â  Â  Â  Â if (selectedDate !== todayString) return;
Â  Â  Â  Â  Â  Â const idToRemove = parseInt(removeBtn.dataset.id);
Â  Â  Â  Â  Â  Â const mealKey = removeBtn.dataset.mealKey;
Â  Â  Â  Â  Â  Â dailyLog[mealKey] = dailyLog[mealKey].filter(item => item.id !== idToRemove);
Â  Â  Â  Â  Â  Â renderFoodList();
Â  Â  Â  Â  Â  Â updateTotals();
Â  Â  Â  Â  Â  Â saveLog();
Â  Â  Â  Â }
Â  Â  Â  Â 
Â  Â  Â  Â function handleToggleDone(event) {
Â  Â  Â  Â  Â  Â const checkbox = event.target.closest('.done-checkbox');
Â  Â  Â  Â  Â  Â if (!checkbox) return;
Â  Â  Â  Â  Â  Â if (selectedDate !== todayString) return;
Â  Â  Â  Â  Â  Â const idToToggle = parseInt(checkbox.dataset.id);
Â  Â  Â  Â  Â  Â const mealKey = checkbox.dataset.mealKey;
Â  Â  Â  Â  Â  Â const item = dailyLog[mealKey].find(i => i.id === idToToggle);
Â  Â  Â  Â  Â  Â if (item) {
Â  Â  Â  Â  Â  Â  Â  Â item.done = checkbox.checked;
Â  Â  Â  Â  Â  Â  Â  Â saveLog();
Â  Â  Â  Â  Â  Â  Â  Â renderFoodList();
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function updateTotals(isLoading = false) {
Â  Â  Â  Â  Â  Â let totalCarbs = 0;
Â  Â  Â  Â  Â  Â let totalCals = 0;
Â  Â  Â  Â  Â  Â let totalProteins = 0;

Â  Â  Â  Â  Â  Â if (dailyLog && typeof dailyLog === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â Object.values(dailyLog).forEach(mealArray => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (Array.isArray(mealArray)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â mealArray.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalProteins += item.protein || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalCarbs += item.carbs || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalCals += item.cals || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â totalProteinsEl.textContent = `${totalProteins.toFixed(1)} g`;
Â  Â  Â  Â  Â  Â totalCarbsEl.textContent = `${totalCarbs.toFixed(1)} g`;
Â  Â  Â  Â  Â  Â totalCalsGoalText.textContent = `${totalCals.toFixed(0)} / ${calorieGoal > 0 ? calorieGoal.toFixed(0) : '...'} kcal`;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â let percentage = (calorieGoal > 0) ? (totalCals / calorieGoal) * 100 : 0;
Â  Â  Â  Â  Â  Â calorieProgress.style.width = `${Math.min(percentage, 100)}%`;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â if (percentage > 100) {
Â  Â  Â  Â  Â  Â  Â  Â calorieProgress.classList.remove('bg-orange-500');
Â  Â  Â  Â  Â  Â  Â  Â calorieProgress.classList.add('bg-green-500');
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â calorieProgress.classList.remove('bg-green-500');
Â  Â  Â  Â  Â  Â  Â  Â calorieProgress.classList.add('bg-orange-500');
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â const isOverLimit = (calorieGoal > 0) && (totalCals > calorieGoal);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â if (isOverLimit) {
Â  Â  Â  Â  Â  Â  Â  Â if (!goalExceededNotified && !isLoading && selectedDate === todayString) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalGoalText.textContent = `Meta: ${calorieGoal.toFixed(0)} kcal | Atual: ${totalCals.toFixed(0)} kcal`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showWarningModal();
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â goalExceededNotified = true;
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â goalExceededNotified = false;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function handleShareWhatsApp() {
Â  Â  Â  Â  Â  Â const currentGoalType = goalTypeSelect.value || 'ganhar';
Â  Â  Â  Â  Â  Â const currentGoalName = goalDisplayNames[currentGoalType];
Â  Â  Â  Â  Â  Â let waText = `Meu Resumo Alimentar (${selectedDate.split('-').reverse().join('/')})\n`;
Â  Â  Â  Â  Â  Â waText += `*Objetivo:* ${currentGoalName}\n\n`;
Â  Â  Â  Â  Â  Â let totalItems = 0;
Â  Â  Â  Â  Â  Â if (dailyLog && typeof dailyLog === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â Object.entries(dailyLog).forEach(([mealKey, items]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (Array.isArray(items) && items.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â totalItems += items.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â waText += `*${mealDisplayNames[mealKey]}*\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const doneStatus = item.done ? '[Feito] ' : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â waText += `- ${doneStatus}${item.displayName} (${(item.protein || 0).toFixed(0)}g prot, ${(item.cals || 0).toFixed(0)} kcal)\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â waText += "\n";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â if (totalItems === 0) {
Â  Â  Â  Â  Â  Â  Â  Â console.warn("Sem itens para compartilhar.");
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â waText += "*Resumo Total:*\n";
Â  Â  Â  Â  Â  Â waText += `*Calorias:* ${totalCalsGoalText.textContent}\n`;
Â  Â  Â  Â  Â  Â waText += `*ProteÃ­nas:* ${totalProteinsEl.textContent}\n`;
Â  Â  Â  Â  Â  Â waText += `*Carboidratos:* ${totalCarbsEl.textContent}\n`;
Â  Â  Â  Â  Â  Â const encodedText = encodeURIComponent(waText);
Â  Â  Â  Â  Â  Â const waURL = `https://wa.me/?text=${encodedText}`;
Â  Â  Â  Â  Â  Â window.open(waURL, '_blank');
Â  Â  Â  Â }

Â  Â  Â  Â function clearAll() {
Â  Â  Â  Â  Â  Â dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [], ceia: [] };
Â  Â  Â  Â  Â  Â goalExceededNotified = false;
Â  Â  Â  Â  Â  Â if (selectedDate === todayString) {
Â  Â  Â  Â  Â  Â  Â  Â saveLog();
Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â delete historyLog[selectedDate];
Â  Â  Â  Â  Â  Â  Â  Â saveLog();
Â  Â  Â  Â  Â  Â  Â  Â loadLogForDate(todayString);
Â  Â  Â  Â  Â  Â  Â  Â populateHistoryDropdown();
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â renderFoodList();
Â  Â  Â  Â  Â  Â updateTotals();
Â  Â  Â  Â }
Â  Â  Â  Â 
Â  Â  Â  Â function showWarningModal() {
Â  Â  Â  Â  Â  Â warningModal.classList.remove('hidden', 'scale-95', 'opacity-0');
Â  Â  Â  Â  Â  Â modalOverlay.classList.remove('hidden');
Â  Â  Â  Â  Â  Â requestAnimationFrame(() => {
Â  Â  Â  Â  Â  Â  Â  Â warningModal.classList.add('scale-100', 'opacity-100');
Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â }
Â  Â  Â  Â 
Â  Â  Â  Â function hideWarningModal() {
Â  Â  Â  Â  Â  Â warningModal.classList.remove('scale-100', 'opacity-100');
Â  Â  Â  Â  Â  Â warningModal.classList.add('scale-95', 'opacity-0');
Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â warningModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â modalOverlay.classList.add('hidden');
Â  Â  Â  Â  Â  Â }, 150);
Â  Â  Â  Â }

Â  Â  Â  Â // --- FunÃ§Ãµes de Importar/Exportar (COM NAMESPACE) ---
Â  Â  Â  Â function handleExport() {
Â  Â  Â  Â  Â  Â if (!window.userId) return;
Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â const profile = localStorage.getItem(`treinoProfile_${window.userId}`);
Â  Â  Â  Â  Â  Â  Â  Â const history = localStorage.getItem(`treinoHistory_${window.userId}`);
Â  Â  Â  Â  Â  Â  Â  Â const goal = localStorage.getItem(`treinoGoal_${window.userId}`);

Â  Â  Â  Â  Â  Â  Â  Â if (!profile && !history) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Nenhum dado para exportar.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â const backupData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â profile: JSON.parse(profile),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â history: JSON.parse(history),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â goal: goal
Â  Â  Â  Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â  Â  Â  Â const jsonString = JSON.stringify(backupData, null, 2);
Â  Â  Â  Â  Â  Â  Â  Â const blob = new Blob([jsonString], { type: 'application/json' });
Â  Â  Â  Â  Â  Â  Â  Â const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â a.href = url;
Â  Â  Â  Â  Â  Â  Â  Â a.download = `assistente_treino_backup_${todayString}.json`;
Â  Â  Â  Â  Â  Â  Â  Â document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  Â  Â a.click();
Â  Â  Â  Â  Â  Â  Â  Â document.body.removeChild(a);
Â  Â  Â  Â  Â  Â  Â  Â URL.revokeObjectURL(url);

Â  Â  Â  Â  Â  Â } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao exportar dados:", e);
Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â }

Â  Â  Â  Â function handleImport(event) {
Â  Â  Â  Â  Â  Â if (!window.userId) return;
Â  Â  Â  Â  Â  Â const file = event.target.files[0];
Â  Â  Â  Â  Â  Â if (!file) {
Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â const reader = new FileReader();
Â  Â  Â  Â  Â  Â reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const data = JSON.parse(e.target.result);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (data.profile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(`treinoProfile_${window.userId}`, JSON.stringify(data.profile));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (data.history) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(`treinoHistory_${window.userId}`, JSON.stringify(data.history));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (data.goal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â localStorage.setItem(`treinoGoal_${window.userId}`, data.goal);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â location.reload();

Â  Â  Â  Â  Â  Â  Â  Â } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao importar o arquivo. O arquivo Ã© um JSON vÃ¡lido?", err);
Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â  Â reader.readAsText(file);
Â  Â  Â  Â  Â  Â event.target.value = null;
Â  Â  Â  Â }

// --- InicializaÃ§Ã£o e Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
Â  Â // NÃƒO carregue os dados aqui. A inicializaÃ§Ã£o do Firebase (initializeFirebase)
Â  Â // irÃ¡ chamar 'checkUserProfile', que entÃ£o chama 'loadDataFromLocalStorage'
Â  Â // no momento certo, apÃ³s a autenticaÃ§Ã£o.
Â  Â 
Â  Â calculateButton.addEventListener('click', calculateGoal);
Â  Â goalTypeSelect.addEventListener('change', updateMealSuggestion);
Â  Â mealTimeSelect.addEventListener('change', updateMealSuggestion);
Â  Â foodSearchInput.addEventListener('input', handleSearchInput);
Â  Â foodSearchInput.addEventListener('blur', () => {
Â  Â  Â  Â setTimeout(() => searchDropdown.classList.add('hidden'), 150);
Â  Â });
Â  Â foodSearchInput.addEventListener('focus', handleSearchInput);
Â  Â searchDropdown.addEventListener('mousedown', handleSelectSearchResult);
Â  Â addFoodButton.addEventListener('click', handleAddFood);
Â  Â foodListContainer.addEventListener('click', handleRemoveFood);
Â  Â foodListContainer.addEventListener('change', handleToggleDone);
Â  Â shareButton.addEventListener('click', handleShareWhatsApp);
Â  Â clearButton.addEventListener('click', clearAll);
Â  Â historySelect.addEventListener('change', (e) => {
Â  Â  Â  Â loadLogForDate(e.target.value);
Â  Â });
Â  Â 
Â  Â closeModalButton.addEventListener('click', hideWarningModal);
Â  Â modalOverlay.addEventListener('click', hideWarningModal);

Â  Â exportButton.addEventListener('click', handleExport);
Â  Â importFile.addEventListener('change', handleImport);

Â  Â // Adiciona tambÃ©m os listeners para o cÃ³digo global
Â  Â window.handleSearchInput = handleSearchInput;
Â  Â window.handleSelectSearchResult = handleSelectSearchResult;
Â  Â window.handleAddFood = handleAddFood;
Â  Â window.handleRemoveFood = handleRemoveFood;
Â  Â window.handleToggleDone = handleToggleDone;
Â  Â window.handleShareWhatsApp = handleShareWhatsApp;
Â  Â window.clearAll = clearAll;
Â  Â window.calculateGoal = calculateGoal;
Â  Â window.updateMealSuggestion = updateMealSuggestion;
Â  Â window.handleExport = handleExport;
Â  Â window.handleImport = handleImport;
Â  Â window.loadLogForDate = (e) => loadLogForDate(e.target.value);
Â  Â window.hideWarningModal = hideWarningModal;
});
Â  Â </script>

</body>
</html>
