<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fitness-Pro 2.0</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      scroll-behavior: smooth;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    #calorieProgress {
      transition: width 0.3s ease-in-out;
    }
    #foodList {
      min-height: 12rem;
    }
    .rotated {
      transform: rotate(180deg);
    }
    .modal-transition {
      transition: opacity 0.3s, transform 0.3s;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex flex-col items-center justify-start p-4 py-8">
  <!-- Conte√∫do fixo omitido por brevidade, insira o conte√∫do est√°tico e HTML conforme enviado -->

  <!-- Scripts JavaScript -->
  <script>
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC9WSxM9GA64fq9lkLhsTyvMbD1AlO1MM4",
      authDomain: "assistente-de-treino-668ce.firebaseapp.com",
      projectId: "assistente-de-treino-668ce",
      storageBucket: "assistente-de-treino-668ce.firebasestorage.app",
      messagingSenderId: "878456748339",
      appId: "1:878456748339:web:5b310b5e91a7b23d0ba646",
      measurementId: "G-FCQ5CQT1WY"
    };
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.firestore();

    let userId = null;
    let calorieGoal = 0;
    let selectedFoodKey = null;
    let dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
    const todayString = new Date().toISOString().split('T')[0];
    let goalExceededNotified = false;
    let profilePicBase64 = null;
    let isEditingProfile = false;
    let currentGoalType = 'ganhar';

    // Fun√ß√µes auxiliares
    function getProfileDocRef() {
      return firebaseDb.collection('users').doc(userId).collection('data').doc('profile');
    }
    function getMetasDocRef() {
      return firebaseDb.collection('users').doc(userId).collection('data').doc('metas');
    }
    function getMealsDocRef() {
      return firebaseDb.collection('users').doc(userId).collection('data').doc('meals_today');
    }
    function showElement(el) { el.classList.remove('hidden'); }
    function hideElement(el) { el.classList.add('hidden'); }
    function showModal(modal, overlay) {
      showElement(overlay);
      showElement(modal);
      requestAnimationFrame(() => {
        modal.classList.remove('scale-90', 'opacity-0');
        modal.classList.add('scale-100', 'opacity-100');
      });
    }
    function hideModal(modal, overlay) {
      modal.classList.remove('scale-100', 'opacity-100');
      modal.classList.add('scale-90', 'opacity-0');
      setTimeout(() => {
        hideElement(modal);
        hideElement(overlay);
        clearRegistrationError();
      }, 150);
    }
    function showRegistrationError(message) {
      const errorEl = document.getElementById('registrationError');
      errorEl.textContent = message;
      showElement(errorEl);
    }
    function clearRegistrationError() {
      const errorEl = document.getElementById('registrationError');
      errorEl.textContent = '';
      hideElement(errorEl);
    }
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    function saveProfilePicLocally() {
      if (profilePicBase64) {
        localStorage.setItem(`profilePic_${userId}`, profilePicBase64);
        document.getElementById('profileImageDisplay').src = profilePicBase64;
        document.getElementById('modalProfileImage').src = profilePicBase64;
      }
    }
    function loadProfilePicLocally() {
      const localPic = localStorage.getItem(`profilePic_${userId}`);
      if (localPic) {
        profilePicBase64 = localPic;
        document.getElementById('profileImageDisplay').src = localPic;
        document.getElementById('modalProfileImage').src = localPic;
      } else {
        document.getElementById('profileImageDisplay').src = "https://placehold.co/64x64/E0F2F1/065F46?text=FP";
        document.getElementById('modalProfileImage').src = "https://placehold.co/96x96/E0F2F1/065F46?text=FP";
        profilePicBase64 = null;
      }
    }
    
    async function loadProfileAndMetas() {
      try {
        const profileSnap = await getProfileDocRef().get();
        if (profileSnap.exists) {
          const data = profileSnap.data();
          document.getElementById('userNameDisplay').textContent = data.userName || 'Usu√°rio';
          document.getElementById('userNameInput').value = data.userName || '';
          document.getElementById('phoneInput').value = data.phone || '';
          loadProfilePicLocally();
        } else if (!isEditingProfile) {
          showModal(document.getElementById('profileModal'), document.getElementById('profileModalOverlay'));
          return;
        }
        const metasSnap = await getMetasDocRef().get();
        if (metasSnap.exists) {
          const data = metasSnap.data();
          document.getElementById('weight').value = data.weight || '';
          document.getElementById('height').value = data.height || '';
          document.getElementById('age').value = data.age || '';
          document.getElementById('gender').value = data.gender || 'male';
          document.getElementById('activity').value = data.activity || '1.55';
          document.getElementById('goalType').value = data.goalType || 'ganhar';
          calorieGoal = parseFloat(data.calorieGoal) || 0;
          currentGoalType = data.goalType || 'ganhar';
        }
        updateGoalDisplay();
        updateMealSuggestion();
      } catch (error) {
        console.error("Erro ao carregar perfil/metas:", error);
        if (!isEditingProfile) {
          showModal(document.getElementById('profileModal'), document.getElementById('profileModalOverlay'));
        }
      }
    }
    
    async function saveProfileData() {
      clearRegistrationError();
      const userName = document.getElementById('userNameInput').value.trim();
      const phone = document.getElementById('phoneInput').value.trim();
      if (!userName) {
        showRegistrationError("Por favor, insira um nome de usu√°rio.");
        return;
      }
      try {
        await getProfileDocRef().set({ userName, phone, userId });
        saveProfilePicLocally();
        document.getElementById('userNameDisplay').textContent = userName;
        hideModal(document.getElementById('profileModal'), document.getElementById('profileModalOverlay'));
        isEditingProfile = false;
        if (calorieGoal === 0) loadProfileAndMetas();
      } catch (error) {
        console.error("Erro ao salvar perfil:", error);
        showRegistrationError("Erro ao salvar perfil. Verifique sua conex√£o.");
      }
    }
    
    async function saveMetas() {
      const goalText = document.getElementById('goalText');
      const weight = parseFloat(document.getElementById('weight').value);
      const height = parseFloat(document.getElementById('height').value);
      const age = parseFloat(document.getElementById('age').value);
      const gender = document.getElementById('gender').value;
      const activity = parseFloat(document.getElementById('activity').value);
      const goalType = document.getElementById('goalType').value;
      if (isNaN(weight) || isNaN(height) || isNaN(age) || weight <= 0 || height <= 0 || age <= 0) {
        goalText.textContent = "Por favor, preencha todos os campos.";
        goalText.classList.remove('hidden', 'text-green-700');
        goalText.classList.add('text-red-600');
        return;
      }
      let bmr;
      if (gender === 'male') {
        bmr = 10*weight + 6.25*height - 5*age + 5;
      } else {
        bmr = 10*weight + 6.25*height - 5*age - 161;
      }
      const tdee = bmr * activity;
      let finalGoal;
      switch(goalType) {
        case 'perder':
          finalGoal = tdee - 400; break;
        case 'manter':
          finalGoal = tdee; break;
        case 'ganhar':
        default:
          finalGoal = tdee + 400; break;
      }
      calorieGoal = finalGoal;
      currentGoalType = goalType;
      try {
        await getMetasDocRef().set({ weight, height, age, gender, activity, goalType, calorieGoal: finalGoal.toFixed(0) });
        updateGoalDisplay();
        updateTotals(false);
        updateMealSuggestion();
        renderFoodList();
      } catch (error) {
        console.error("Erro ao salvar metas no servidor:", error);
        goalText.textContent = "Erro ao salvar meta no servidor. (Verifique as regras do Firebase)";
        goalText.classList.remove('hidden', 'text-green-700');
        goalText.classList.add('text-red-600');
      }
    }
    
    function updateGoalDisplay() {
      const goalText = document.getElementById('goalText');
      if (calorieGoal > 0) {
        const goalType = document.getElementById('goalType').value || 'ganhar';
        const goalName = {
          ganhar: 'Ganho de Massa',
          manter: 'Manuten√ß√£o',
          perder: 'Perda de Peso'
        }[goalType];
        goalText.textContent = `Sua meta (${goalName}): ${calorieGoal.toFixed(0)} kcal/dia`;
        goalText.classList.remove('hidden', 'text-red-600', 'text-gray-600');
        goalText.classList.add('text-green-700');
        document.getElementById('goalTag').textContent = goalName;
        showElement(document.getElementById('goalTag'));
      } else {
        goalText.textContent = "Clique em 'Calcular e Salvar Meta'.";
        goalText.classList.remove('hidden', 'text-green-700', 'text-red-600');
        goalText.classList.add('text-gray-600');
        hideElement(document.getElementById('goalTag'));
      }
    }
    
    function updateMealSuggestion() {
      const mealSuggestion = document.getElementById('mealSuggestion');
      if (calorieGoal === 0) {
        mealSuggestion.innerHTML = 'Preencha e salve suas metas acima para ver sugest√µes de refei√ß√µes.';
        return;
      }
      const goalType = document.getElementById('goalType').value || 'ganhar';
      const mealTime = document.getElementById('mealTimeSelect').value || 'cafe_da_manha';
      const mealSuggestions = {
          ganhar: {
              cafe_da_manha: "Ex: Ovos, Aveia, Banana, Whey Protein.",
              almoco: "Ex: Arroz, Peito de Frango, Feij√£o, Batata Doce.",
              lanche: "Ex: P√£o Integral, Pasta de Amendoim, Iogurte Grego.",
              jantar: "Ex: Macarr√£o, Carne Mo√≠da, Salada com Azeite.",
          },
          perder: {
              cafe_da_manha: "Ex: Ovos, Morangos, Caf√© Preto, Iogurte Natural.",
              almoco: "Ex: Salada, Til√°pia, Br√≥colis, Pouco Arroz Integral.",
              lanche: "Ex: Ma√ß√£, Queijo Minas, Castanhas (pouco).",
              jantar: "Ex: Sopa de legumes, Peito de Frango, Alface.",
          },
          manter: {
              cafe_da_manha: "Refei√ß√£o balanceada. Ex: P√£o Integral, Ovos, Mam√£o.",
              almoco: "Equilibre prato. Ex: Arroz, Feij√£o, Bife, Salada.",
              lanche: "Ex: Uvas, Iogurte, Aveia.",
              jantar: "Refei√ß√£o leve. Ex: Batata Doce, Frango, Br√≥colis.",
          }
      };
      const suggestionText = mealSuggestions[goalType][mealTime];
      mealSuggestion.innerHTML = `üí° <span class="font-semibold">Sugest√£o p/ ${goalType}:</span> ${suggestionText}`;
    }
    
    async function loadDailyLog() {
      try {
        const mealsSnap = await getMealsDocRef().get();
        if (mealsSnap.exists) {
          const data = mealsSnap.data();
          if (data.date !== todayString) {
            dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
          } else {
            dailyLog = data.log || dailyLog;
          }
        }
      } catch (error) {
        console.error("Erro ao carregar refei√ß√µes:", error);
      }
    }
    
    // Inicializa√ß√£o principal da app
    async function initApp() {
      // Aguarde autentica√ß√£o do usu√°rio an√¥nima ou real
      firebaseAuth.onAuthStateChanged(async (user) => {
        if (user) {
          userId = user.uid;
          // Carrega dados perfil e metas
          await loadProfileAndMetas();
          await loadDailyLog();
          document.getElementById('loadingScreen').classList.add('hidden');
          document.getElementById('mainApp').classList.remove('hidden');
        } else {
          // Autentica√ß√£o an√¥nima
          try {
            await firebaseAuth.signInAnonymously();
          } catch (error) {
            console.error("Erro na autentica√ß√£o an√¥nima:", error);
          }
        }
      });
      
      // Eventos dos bot√µes
      document.getElementById('saveProfileButton').addEventListener('click', saveProfileData);
      document.getElementById('calculateButton').addEventListener('click', saveMetas);
      
      // Outros eventos que voc√™ deseje conectar...
    }

    // Chama a inicializa√ß√£o
    initApp();

  </script>
</body>
</html>
