<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness-Pro 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Scripts do Firebase (CARREGAMENTO ROB√öSTO SEM 'IMPORT') -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* Define a fonte Inter como padr√£o */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        #calorieProgress {
            transition: width 0.3s ease-in-out;
        }
        #foodList {
            min-height: 12rem; /* 192px */
        }
        /* Estilo para girar a seta no detalhe aberto */
        details[open] .details-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex flex-col items-center justify-start p-4 py-8">

    <!-- Loading Screen (Conectando) -->
    <div id="app-loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col space-y-4">
        <svg class="animate-spin h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="app-loading-text" class="text-gray-600 font-medium">Conectando ao app...</p>
    </div>

    <!-- Modal de Cadastro/Edi√ß√£o de Perfil -->
    <div id="registrationOverlay" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden transition-opacity"></div>
    <div id="registrationModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl z-50 hidden transition-transform scale-95 opacity-0">
        <div class="text-center">
            <h3 id="registrationModalTitle" class="text-2xl font-bold text-gray-800 mb-6">Crie seu Perfil</h3>
            
            <p id="registrationError" class="text-sm font-semibold text-white bg-red-500 p-2 rounded-lg mb-3 hidden"></p>

            <!-- Foto de Perfil -->
            <label for="profilePicInput" class="cursor-pointer mx-auto block w-24 h-24 rounded-full overflow-hidden border-4 border-green-500 mb-4 shadow-lg">
                <img id="profilePicPreview" src="https://placehold.co/100x100/e2e8f0/718096?text=Foto" alt="Pr√©-visualiza√ß√£o da Foto" class="w-full h-full object-cover">
            </label>
            <input type="file" id="profilePicInput" accept="image/*" class="hidden" onchange="handleProfilePicChange(event)">
            <p class="text-xs text-gray-500 mb-4">Clique na foto para alterar (M√°x 5MB)</p>

            <div class="space-y-4">
                <div>
                    <input type="text" id="usernameInput" placeholder="Seu nome de Usu√°rio" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div>
                    <input type="tel" id="phoneInput" placeholder="Telefone (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
            </div>

            <button id="saveProfileButton" class="mt-6 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors flex items-center justify-center" onclick="handleSaveProfile()">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="saveProfileButtonText">Come√ßar a Usar</span>
            </button>
            <button id="cancelEditButton" class="mt-3 w-full text-gray-500 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors hidden" onclick="closeProfileEditor()">
                Cancelar Edi√ß√£o
            </button>
        </div>
    </div>
    <!-- Fim do Modal de Cadastro -->

    <!-- Card Principal (Conte√∫do Principal) -->
    <div id="main-app-content" class="bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-xl space-y-6 hidden">
        
        <!-- SE√á√ÉO DO T√çTULO E PERFIL -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-green-600">
                    Fitness-Pro 2.0
                </h1>
                <button id="shareAppButton" class="text-green-600 hover:text-green-700 p-2 rounded-full transition-colors" onclick="handleShareApp()" title="Compartilhar o App">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                </button>
            </div>
            
            <!-- Linha do Perfil -->
            <div id="profile-display-section" class="flex items-center justify-between bg-gray-50 p-4 rounded-xl border border-gray-200 hidden">
                <div class="flex items-center space-x-3">
                    <img id="displayProfilePic" src="https://placehold.co/100x100/e2e8f0/718096?text=Foto" alt="Foto de Perfil" class="w-10 h-10 rounded-full object-cover border border-gray-300">
                    <span id="displayUsername" class="text-lg font-semibold text-gray-800">
                        Usu√°rio An√¥nimo
                    </span>
                </div>
                <button onclick="openProfileEditor()" class="text-sm text-blue-600 hover:text-blue-800 font-medium py-1 px-3 rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors">
                    Editar
                </button>
            </div>
        </div>

        <!-- Se√ß√£o: Minhas Metas (Perfil) -->
        <details class="bg-gray-50 p-4 rounded-xl border border-green-300 shadow-sm">
            <summary class="text-xl font-semibold text-gray-700 cursor-pointer list-none">
                <div class="flex justify-between items-center">
                    <span class="text-green-600">Minhas Metas</span>
                    <span class="details-icon text-green-600 transition-transform duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </span>
                </div>
            </summary>
            <div id="profileForm" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                    <input type="number" id="weight" placeholder="70" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="height" class="block text-sm font-medium text-gray-700">Altura (cm)</label>
                    <input type="number" id="height" placeholder="175" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Idade</label>
                    <input type="number" id="age" placeholder="25" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="col-span-2 sm:col-span-3">
                    <label for="gender" class="block text-sm font-medium text-gray-700">G√™nero</label>
                    <select id="gender" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="male">Masculino</option>
                        <option value="female">Feminino</option>
                    </select>
                </div>
                <div class="col-span-2 sm:col-span-3">
                    <label for="activity" class="block text-sm font-medium text-gray-700">N√≠vel de Atividade</label>
                    <select id="activity" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="1.2">Sedent√°rio (pouco ou nenhum)</option>
                        <option value="1.375">Leve (1-3 dias/semana)</option>
                        <option value="1.55" selected>Moderado (3-5 dias/semana)</option>
                        <option value="1.725">Ativo (6-7 dias/semana)</option>
                        <option value="1.9">Muito Ativo (trabalho f√≠sico + treino)</option>
                    </select>
                </div>
                
                <div class="col-span-2 sm:col-span-3">
                    <label for="goalType" class="block text-sm font-medium text-gray-700">Meu Objetivo</label>
                    <select id="goalType" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="ganhar">Ganhar Massa (Bulking)</option>
                        <option value="manter">Manter Peso (Manuten√ß√£o)</option>
                        <option value="perder">Perder Peso (Cutting)</option>
                    </select>
                </div>

                <button id="calculateButton" class="col-span-2 sm:col-span-3 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors" onclick="calculateGoal()">
                    Calcular e Salvar Meta
                </button>
            </div>
            <p id="goalText" class="text-center text-lg font-semibold text-green-700 mt-4 hidden"></p>
        </details>

        <!-- Se√ß√£o: Adicionar Alimento -->
        <div id="addFoodSection" class="transition-opacity duration-300">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Alimento</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-start">
                <!-- Barra de Pesquisa -->
                <div class="relative sm:col-span-3">
                    <label for="foodSearch" class="block text-sm font-medium text-gray-700 mb-1">
                        1. Pesquisar Alimento
                    </label>
                    <input 
                        type="text" 
                        id="foodSearch" 
                        placeholder="Digite o nome do alimento..."
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                        autocomplete="off"
                        oninput="handleSearchInput()"
                        onblur="setTimeout(() => document.getElementById('searchDropdown').classList.add('hidden'), 150)"
                        onfocus="handleSearchInput()"
                    >
                    <!-- Dropdown de Resultados -->
                    <div id="searchDropdown" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-48 overflow-y-auto" onmousedown="handleSelectSearchResult(event)">
                        <!-- Resultados da pesquisa aqui -->
                    </div>
                </div>

                <!-- Se√ß√£o: Refei√ß√£o -->
                <div class="sm:col-span-2">
                    <label for="mealTimeSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        2. Escolher Refei√ß√£o
                    </label>
                    <select id="mealTimeSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 bg-white" onchange="updateMealSuggestion()">
                        <option value="cafe_da_manha">Caf√© da Manh√£</option>
                        <option value="almoco">Almo√ßo</option>
                        <option value="lanche">Lanche</option>
                        <option value="jantar">Jantar</option>
                    </select>
                </div>
                
                <!-- Quantidade -->
                <div class="sm:col-span-1">
                    <label for="foodQuantity" class="block text-sm font-medium text-gray-700 mb-1">
                        3. Qtd.
                    </label>
                    <input 
                        type="number" 
                        id="foodQuantity" 
                        placeholder="Qtd."
                        min="0"
                        step="0.1"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                </div>
                
                <!-- Sugest√£o de Refei√ß√£o -->
                <div id="mealSuggestion" class="text-sm text-gray-600 mt-1 sm:col-span-3 px-1">
                    <!-- Sugest√£o ser√° injetada aqui -->
                </div>

                <!-- Bot√£o Adicionar -->
                <button id="addFoodButton" class="sm:col-span-3 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors mt-3" onclick="handleAddFood()">
                    Adicionar Alimento
                </button>
                
                <!-- Bot√£o de Compartilhamento -->
                <button id="shareButton" class="sm:col-span-3 w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 transition-colors mt-3" onclick="handleShareWhatsApp()">
                    Compartilhar Resumo no WhatsApp
                </button>
            </div>
        </div>

        <!-- Lista de Alimentos Adicionados -->
        <div class="border-t border-gray-200 pt-4">
            <h3 id="foodListTitle" class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <span>Suas Refei√ß√µes (Hoje):</span>
                <span id="goalTag" class="hidden text-xs sm:text-sm font-medium text-blue-700 bg-blue-100 py-0.5 px-3 rounded-full"></span>
            </h3>
            <div id="foodList" class="overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-4 bg-gray-50" onclick="handleRemoveFood(event)" onchange="handleToggleDone(event)">
                <p id="emptyListText" class="text-gray-400 text-center mt-4">Nenhum alimento adicionado ainda.</p>
                <!-- Se√ß√µes de refei√ß√£o ser√£o injetadas aqui -->
            </div>
        </div>

        <!-- Divisor -->
        <hr class="border-t border-gray-200">

        <!-- Resumo (MODIFICADO) -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-800 text-center">Resumo do Dia</h2>
            
            <!-- Barra de Progresso de Calorias -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-base font-medium text-orange-600">Calorias</span>
                    <span id="totalCalsGoalText" class="text-sm font-medium text-gray-600">0 / 0 kcal</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
                    <div id="calorieProgress" class="bg-orange-500 h-4 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- NOVOS TOTAIS LADO A LADO -->
            <div class="grid grid-cols-2 gap-4 text-center">
                <!-- Total de Prote√≠nas -->
                <div>
                    <p class="text-base font-medium text-emerald-600 mb-1">
                        Prote√≠nas
                    </p>
                    <p id="totalProteins" class="text-3xl font-bold text-emerald-600">
                        0 g
                    </p>
                </div>
                <!-- Total de Carboidratos -->
                <div>
                    <p class="text-base font-medium text-blue-600 mb-1">
                        Carboidratos
                    </p>
                    <p id="totalCarbs" class="text-3xl font-bold text-blue-600">
                        0 g
                    </p>
                </div>
            </div>
        </div>

    </div>

    <!-- Rodap√© -->
    <footer class="mt-8 text-sm text-gray-500">
        Desenvolvido por Thiago
    </footer>

    <!-- Modal de Aviso de Limite -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden transition-opacity"></div>
    <div id="warningModal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden transition-transform scale-95 opacity-0">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
                <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mt-4">Meta Atingida!</h3>
            <p class="text-base text-gray-600 mt-2">
                Voc√™ ultrapassou sua meta de calorias do dia.
            </p>
            <p id="modalGoalText" class="text-sm text-gray-500 mt-1"></p>
            <button id="closeModalButton" class="mt-6 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors" onclick="hideWarningModal()">
                Entendi
            </button>
        </div>
    </div>
    <!-- Fim do Modal -->

    <script>
        
        // --- FUN√á√ïES DE L√ìGICA DO FIREBASE (Global Namespace) ---
        
        window.currentProfileData = {}; 
        window.calorieGoal = 0; 
        window.dailyLog = {};
        window.todayString = new Date().toISOString().split('T')[0];
        window.goalExceededNotified = false;

        async function initializeFirebase() {
            try {
                // A SUA CONFIGURA√á√ÉO PESSOAL DO FIREBASE
                const firebaseConfig = {
                    apiKey: "AIzaSyC9WSxM9GA64fq9lkLhsTyvMbD1AlO1MM4",
                    authDomain: "assistente-de-treino-668ce.firebaseapp.com",
                    projectId: "assistente-de-treino-668ce",
                    storageBucket: "assistente-de-treino-668ce.firebasestorage.app",
                    messagingSenderId: "878456748339",
                    appId: "1:878456748339:web:5b310b5e91a7b23d0ba646"
                };

                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth(app);
                const db = firebase.firestore(app);
                
                // Vari√°veis globais acess√≠veis pela l√≥gica do app
                window.auth = auth;
                window.db = db;
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        await checkUserProfile();
                    } else {
                        try {
                            await auth.signInAnonymously();
                        } catch (error) {
                            console.error("Erro ao tentar login an√¥nimo:", error);
                            document.getElementById('app-loading-text').textContent = "Erro ao conectar. Tente recarregar a p√°gina.";
                        }
                    }
                });
            } catch (error) {
                console.error("Cr√≠tico ao inicializar o Firebase:", error);
                document.getElementById('app-loading-text').textContent = "Erro ao carregar o app. Verifique a configura√ß√£o ou o modo do seu BD.";
            }
        }

        async function checkUserProfile() {
            const userId = window.userId;
            if (!userId) return;

            const loadingOverlay = document.getElementById('app-loading');
            const mainAppContent = document.getElementById('main-app-content');
            const registrationModal = document.getElementById('registrationModal');
            const registrationOverlay = document.getElementById('registrationOverlay');

            try {
                // 1. Define os caminhos dos documentos (Original e Correto)
                const profileRef = window.db.collection("users").doc(userId).collection("profile").doc("data");
                const metasRef = window.db.collection("users").doc(userId).collection("profile").doc("metas");
                const mealsRef = window.db.collection("users").doc(userId).collection("meals").doc("today");

                // 2. Faz as chamadas em paralelo
                const [profileSnap, metasSnap, mealsSnap] = await Promise.all([
                    profileRef.get(),
                    metasRef.get(),
                    mealsRef.get()
                ]);

                // 3. Processa o Perfil (Nome, Telefone, Foto)
                if (profileSnap.exists) {
                    loadProfileUI(profileSnap.data()); 
                } else {
                    // NOVO USU√ÅRIO - Mostra o modal de cadastro
                    document.getElementById('registrationModalTitle').textContent = 'Crie seu Perfil';
                    document.getElementById('saveProfileButtonText').textContent = 'Come√ßar a Usar';
                    document.getElementById('cancelEditButton').classList.add('hidden');
                    
                    registrationModal.classList.remove('hidden', 'scale-95', 'opacity-0');
                    registrationOverlay.classList.remove('hidden');
                    loadingOverlay.classList.add('hidden');
                    return; 
                }

                // 4. Processa as Metas (Peso, Altura, etc.)
                if (metasSnap.exists) {
                    loadMetasUI(metasSnap.data());
                }
                
                // 5. Processa as Refei√ß√µes (Verifica a data!)
                loadTodayMeals(mealsSnap.exists ? mealsSnap.data() : null);

                // 6. Mostra o app
                mainAppContent.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');

            } catch (error) {
                console.error("Erro CR√çTICO ao carregar dados do usu√°rio do Firestore:", error);
                document.getElementById('app-loading-text').textContent = "Erro ao carregar seus dados. VERIFIQUE AS SUAS REGRAS DE SEGURAN√áA.";
            }
        }

        function loadProfileUI(profileData) {
            window.currentProfileData = profileData || {}; 
            if (profileData && profileData.username) {
                document.getElementById('displayUsername').textContent = profileData.username;
            } else {
                document.getElementById('displayUsername').textContent = "Usu√°rio An√¥nimo";
            }
            document.getElementById('usernameInput').value = profileData.username || '';
            document.getElementById('phoneInput').value = profileData.phone || '';

            const profilePicData = localStorage.getItem(`treinoProfilePic_${window.userId}`);
            const picPreviewEl = document.getElementById('profilePicPreview');
            const picDisplayEl = document.getElementById('displayProfilePic');
            const defaultPic = "https://placehold.co/100x100/e2e8f0/718096?text=Foto";

            if (profilePicData) {
                picPreviewEl.src = profilePicData;
                picDisplayEl.src = profilePicData;
            } else {
                picPreviewEl.src = defaultPic;
                picDisplayEl.src = defaultPic;
            }
            document.getElementById('profile-display-section').classList.remove('hidden');
        }

        function loadMetasUI(metasData) {
            if (!metasData) return;
            
            weightInput.value = metasData.weight || '';
            heightInput.value = metasData.height || '';
            ageInput.value = metasData.age || '';
            genderSelect.value = metasData.gender || 'male';
            activitySelect.value = metasData.activity || '1.55';
            goalTypeSelect.value = metasData.goalType || 'ganhar';
            
            window.calorieGoal = parseFloat(metasData.calorieGoal) || 0; 
            
            if (window.calorieGoal > 0) {
                 const goalName = goalDisplayNames[metasData.goalType] || goalDisplayNames['ganhar'];
                 goalText.textContent = `Sua meta (${goalName}): ${window.calorieGoal.toFixed(0)} kcal/dia`;
                 goalText.classList.remove('hidden', 'text-red-600');
                 goalText.classList.add('text-green-700');
                 goalTag.textContent = goalName;
                 goalTag.classList.remove('hidden');
            } else {
                 goalTag.classList.add('hidden'); 
            }
            window.updateMealSuggestion();
        }
        
        function loadTodayMeals(mealData) {
            if (mealData && mealData.savedDate === window.todayString) {
                window.dailyLog = mealData.log;
            } else {
                // Limpeza Autom√°tica √† Meia-noite
                window.dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
                if (mealData) {
                    window.saveTodayMeals(); 
                }
            }
            window.renderFoodList();
            window.updateTotals(true);
        }

        // --- Fun√ß√µes do Modal ---
        function showRegistrationError(message) {
            const errorEl = document.getElementById('registrationError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        function clearRegistrationError() {
            document.getElementById('registrationError').classList.add('hidden');
        }
        function openProfileEditor() {
            clearRegistrationError();
            document.getElementById('registrationModalTitle').textContent = 'Editar Perfil';
            document.getElementById('saveProfileButtonText').textContent = 'Salvar Altera√ß√µes';
            document.getElementById('cancelEditButton').classList.remove('hidden');
            loadProfileUI(window.currentProfileData); 
            document.getElementById('registrationModal').classList.remove('hidden', 'scale-95', 'opacity-0');
            document.getElementById('registrationOverlay').classList.remove('hidden');
        }
        function closeProfileEditor() {
            const registrationModal = document.getElementById('registrationModal');
            const registrationOverlay = document.getElementById('registrationOverlay');
            registrationModal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                registrationModal.classList.add('hidden');
                registrationOverlay.classList.add('hidden');
            }, 150);
            loadProfileUI(window.currentProfileData);
        }

        // --- SALVA O PERFIL (NOME, FOTO) ---
        async function handleSaveProfile() {
            clearRegistrationError(); 
            const userId = window.userId;
            const username = document.getElementById('usernameInput').value;
            const phone = document.getElementById('phoneInput').value;

            if (!username) {
                showRegistrationError("Por favor, insira um nome de usu√°rio."); 
                return;
            }

            const saveButton = document.getElementById('saveProfileButton');
            const buttonText = saveButton.querySelector('span');
            const spinner = saveButton.querySelector('svg');

            buttonText.textContent = "Salvando...";
            spinner.classList.remove('hidden');
            saveButton.disabled = true;

            try {
                const dataToSave = {
                    ...window.currentProfileData, 
                    username: username,
                    phone: phone,
                    lastUpdatedAt: new Date()
                };
                if (!window.currentProfileData.createdAt) {
                    dataToSave.createdAt = new Date();
                }

                const profileRef = window.db.collection("users").doc(userId).collection("profile").doc("data");
                await profileRef.set(dataToSave, { merge: true });

                loadProfileUI(dataToSave);
                
                if (Object.keys(window.dailyLog).length === 0) {
                    const metasRef = window.db.collection("users").doc(userId).collection("profile").doc("metas");
                    const mealsRef = window.db.collection("users").doc(userId).collection("meals").doc("today");
                    
                    const [metasSnap, mealsSnap] = await Promise.all([metasRef.get(), mealsRef.get()]);
                    
                    if (metasSnap.exists) loadMetasUI(metasSnap.data());
                    loadTodayMeals(mealsSnap.exists ? mealsSnap.data() : null);
                }

                closeProfileEditor();
                document.getElementById('main-app-content').classList.remove('hidden');

            } catch (error) {
                console.error("Erro ao salvar perfil no Firestore:", error);
                showRegistrationError(`Erro ao salvar: ${error.message}. Tente novamente.`);
            } finally {
                spinner.classList.add('hidden');
                saveButton.disabled = false;
            }
        }

        function handleProfilePicChange(event) {
            clearRegistrationError(); 
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                showRegistrationError("A imagem √© muito grande (limite de 5MB)."); 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataURL = e.target.result;
                try {
                    localStorage.setItem(`treinoProfilePic_${window.userId}`, dataURL);
                    document.getElementById('profilePicPreview').src = dataURL;
                    document.getElementById('displayProfilePic').src = dataURL; 
                } catch (error) {
                    console.error("Erro ao salvar foto no localStorage (provavelmente cheio):", error);
                    showRegistrationError("N√£o foi poss√≠vel salvar sua foto. Armazenamento cheio?");
                }
            };
            reader.readAsDataURL(file);
        }

        async function saveMetas() {
            const userId = window.userId;
            if (!userId) return;
            
            const metasData = {
                weight: weightInput.value,
                height: heightInput.value,
                age: ageInput.value,
                gender: genderSelect.value,
                activity: activitySelect.value,
                goalType: goalTypeSelect.value,
                calorieGoal: window.calorieGoal.toString()
            };
            
            try {
                const metasRef = window.db.collection("users").doc(userId).collection("profile").doc("metas");
                await metasRef.set(metasData);
            } catch (e) {
                console.error("Erro ao salvar metas no Firestore:", e);
            }
        }
        
        async function saveTodayMeals() {
            const userId = window.userId;
            if (!userId) return;
            
            const dataToSave = {
                savedDate: window.todayString,
                log: window.dailyLog
            };
            
            try {
                const mealsRef = window.db.collection("users").doc(userId).collection("meals").doc("today");
                await mealsRef.set(dataToSave);
            } catch (e) {
                console.error("Erro ao salvar refei√ß√µes no Firestore:", e);
            }
        }

        // Fun√ß√µes de Metas, Alimentos, etc (Mesmas da √∫ltima vers√£o)
        // [O restante das fun√ß√µes JavaScript foi colado abaixo do 'initializeFirebase' no HTML]

        // --- Vari√°veis de Dados (Food Database etc) ---
        const foodDatabase = {
            'banana': { name: 'Banana', protein: 1.1, carbs: 27, cals: 105, unit: 'unidade', visceralFat: false },
            'maca': { name: 'Ma√ß√£', protein: 0.3, carbs: 25, cals: 95, unit: 'unidade', visceralFat: false },
            'abacate': { name: 'Abacate', protein: 2, carbs: 9, cals: 160, unit: '100g', visceralFat: false },
            'mamao': { name: 'Mam√£o Formosa', protein: 0.5, carbs: 11, cals: 43, unit: '100g', visceralFat: false },
            'melancia': { name: 'Melancia', protein: 0.6, carbs: 8, cals: 30, unit: '100g', visceralFat: false },
            'uva': { name: 'Uva', protein: 0.7, carbs: 18, cals: 69, unit: '100g', visceralFat: false },
            'laranja': { name: 'Laranja', protein: 1, carbs: 12, cals: 47, unit: 'unidade', visceralFat: false },
            'morango': { name: 'Morango', protein: 0.7, carbs: 8, cals: 32, unit: '100g', visceralFat: false },
            'brocolis': { name: 'Br√≥colis (cozido)', protein: 2.4, carbs: 7, cals: 35, unit: '100g', visceralFat: false },
            'alface': { name: 'Alface Crespa', protein: 1.4, carbs: 2.9, cals: 15, unit: '100g', visceralFat: false },
            'tomate': { name: 'Tomate', protein: 0.9, carbs: 3.9, cals: 18, unit: '100g', visceralFat: false },
            'cenoura': { name: 'Cenoura (crua)', protein: 0.9, carbs: 10, cals: 41, unit: '100g', visceralFat: false },
            'cebola': { name: 'Cebola', protein: 1.1, carbs: 9, cals: 40, unit: '100g', visceralFat: false },
            'couve_flor': { name: 'Couve-flor (cozida)', protein: 1.9, carbs: 5, cals: 25, unit: '100g', visceralFat: false },
            'peito_frango': { name: 'Peito de Frango (grelhado)', protein: 31, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
            'ovo': { name: 'Ovo Cozido', protein: 6.3, carbs: 0.6, cals: 77, unit: 'unidade', visceralFat: false },
            'ovo_frito': { name: 'Ovo Frito (em √≥leo)', protein: 6.2, carbs: 0.6, cals: 95, unit: 'unidade', visceralFat: false },
            'ovos_mexidos': { name: 'Ovos Mexidos (c/ manteiga)', protein: 6.5, carbs: 1.5, cals: 105, unit: 'unidade (1 ovo)', visceralFat: true },
            'whey_protein': { name: 'Whey Protein', protein: 24, carbs: 3, cals: 120, unit: 'scoop 30g', visceralFat: false },
            'carne_moida': { name: 'Carne Mo√≠da (patinho, cozida)', protein: 26, carbs: 0, cals: 180, unit: '100g', visceralFat: false },
            'bife_alcatra': { name: 'Bife (Alcatra, grelhado)', protein: 28, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
            'tilapia': { name: 'Til√°pia (grelhada)', protein: 26, carbs: 0, cals: 128, unit: '100g', visceralFat: false },
            'salmao': { name: 'Salm√£o (grelhado)', protein: 20, carbs: 0, cals: 208, unit: '100g', visceralFat: false },
            'atum_lata': { name: 'Atum em Lata (em √≥leo)', protein: 29, carbs: 0, cals: 186, unit: '100g', visceralFat: false },
            'tofu': { name: 'Tofu', protein: 8, carbs: 2.8, cals: 76, unit: '100g', visceralFat: false },
            'leite_integral': { name: 'Leite Integral', protein: 3.2, carbs: 5, cals: 61, unit: '100ml', visceralFat: true },
            'leite_desnatado': { name: 'Leite Desnatado', protein: 3.4, carbs: 5, cals: 35, unit: '100ml', visceralFat: false },
            'queijo_mussarela': { name: 'Queijo Mussarela', protein: 22, carbs: 3.1, cals: 300, unit: '100g (fatia 30g)', visceralFat: true },
            'queijo_minas': { name: 'Queijo Minas Frescal', protein: 17, carbs: 3, cals: 264, unit: '100g', visceralFat: false },
            'iogurte_grego': { name: 'Iogurte Grego (natural)', protein: 10, carbs: 3.6, cals: 59, unit: '100g', visceralFat: false },
            'iogurte_natural': { name: 'Iogurte Natural Desnatado', protein: 4.1, carbs: 7, cals: 57, unit: '100g', visceralFat: false },
            'arroz_branco': { name: 'Arroz Branco (cozido)', protein: 2.7, carbs: 28, cals: 130, unit: '100g', visceralFat: false },
            'arroz_integral': { name: 'Arroz Integral (cozido)', protein: 2.6, carbs: 23, cals: 111, unit: '100g', visceralFat: false },
            'pao_forma': { name: 'P√£o de Forma (Branco)', protein: 2.5, carbs: 15, cals: 80, unit: 'fatia', visceralFat: true },
            'pao_integral': { name: 'P√£o de Forma (Integral)', protein: 3, carbs: 12, cals: 70, unit: 'fatia', visceralFat: false },
            'batata_doce': { name: 'Batata Doce (cozida)', protein: 1.6, carbs: 20, cals: 86, unit: '100g', visceralFat: false },
            'batata_inglesa': { name: 'Batata Inglesa (cozida)', protein: 2, carbs: 20, cals: 87, unit: '100g', visceralFat: false },
            'feijao_preto': { name: 'Feij√£o Preto (cozido)', protein: 9, carbs: 24, cals: 131, unit: '100g', visceralFat: false },
            'feijao_carioca': { name: 'Feij√£o Carioca (cozido)', protein: 4.8, carbs: 14, cals: 76, unit: '100g', visceralFat: false },
            'aveia': { name: 'Aveia em Flocos', protein: 17, carbs: 66, cals: 389, unit: '100g', visceralFat: false },
            'macarrao': { name: 'Macarr√£o (cozido)', protein: 5, carbs: 25, cals: 131, unit: '100g', visceralFat: false },
            'cuscuz': { name: 'Cuscuz (hidratado)', protein: 3.8, carbs: 23, cals: 112, unit: '100g', visceralFat: false },
            'tapioca': { name: 'Tapioca (goma)', protein: 0, carbs: 89, cals: 355, unit: '100g', visceralFat: false },
            'pasta_amendoim': { name: 'Pasta de Amendoim (integral)', protein: 25, carbs: 20, cals: 588, unit: '100g (colher 15g)', visceralFat: false },
            'azeite': { name: 'Azeite de Oliva', protein: 0, carbs: 0, cals: 119, unit: 'colher sopa', visceralFat: false },
            'castanha_caju': { name: 'Castanha de Caju', protein: 18, carbs: 30, cals: 553, unit: '100g', visceralFat: false },
            'amendoim': { name: 'Amendoim', protein: 26, carbs: 16, cals: 567, unit: '100g', visceralFat: false },
            'manteiga': { name: 'Manteiga com sal', protein: 0.9, carbs: 0.1, cals: 717, unit: '100g (colher 5g)', visceralFat: true },
            'refrigerante': { name: 'Refrigerante (Cola)', protein: 0, carbs: 26, cals: 105, unit: 'lata 350ml', visceralFat: true },
            'chocolate_ao_leite': { name: 'Chocolate ao Leite', protein: 8, carbs: 59, cals: 535, unit: '100g (barra 25g)', visceralFat: true },
            'biscoito_recheado': { name: 'Biscoito Recheado (Chocolate)', protein: 5, carbs: 70, cals: 450, unit: '100g (unid 10g)', visceralFat: true },
            'pizza_mussarela': { name: 'Pizza Mussarela', protein: 11, carbs: 33, cals: 271, unit: '100g (1 fatia)', visceralFat: true },
            'mel': { name: 'Mel', protein: 0.3, carbs: 82, cals: 304, unit: '100g', visceralFat: true },
            'cafe_preto': { name: 'Caf√© Preto (sem a√ß√∫car)', protein: 0.1, carbs: 0, cals: 2, unit: 'x√≠cara', visceralFat: false }
        };

        const mealDisplayNames = {
            cafe_da_manha: "‚òï Caf√© da Manh√£",
            almoco: "üçΩÔ∏è Almo√ßo",
            lanche: "üçé Lanche",
            jantar: "üç≤ Jantar"
        };
        const goalDisplayNames = {
            ganhar: 'Ganho de Massa',
            manter: 'Manuten√ß√£o',
            perder: 'Perda de Peso'
        };
        const mealSuggestions = {
            ganhar: {
                cafe_da_manha: "Ex: Ovos, Aveia, Banana, Whey Protein.",
                almoco: "Ex: Arroz, Peito de Frango, Feij√£o, Batata Doce.",
                lanche: "Ex: P√£o Integral, Pasta de Amendoim, Iogurte Grego.",
                jantar: "Ex: Macarr√£o, Carne Mo√≠da, Salada com Azeite."
            },
            perder: {
                cafe_da_manha: "Ex: Ovos, Morangos, Caf√© Preto, Iogurte Natural.",
                almoco: "Ex: Salada, Til√°pia, Br√≥colis, Pouco Arroz Integral.",
                lanche: "Ex: Ma√ß√£, Queijo Minas, Castanhas (pouco).",
                jantar: "Ex: Sopa de legumes, Peito de Frango, Alface."
            },
            manter: {
                cafe_da_manha: "Refei√ß√£o balanceada. Ex: P√£o Integral, Ovos, Mam√£o.",
                almoco: "Equilibre prato. Ex: Arroz, Feij√£o, Bife, Salada.",
                lanche: "Ex: Uvas, Iogurte, Aveia.",
                jantar: "Refei√ß√£o leve. Ex: Batata Doce, Frango, Br√≥colis."
            }
        };

        // Seletores do DOM - Perfil
        const weightInput = document.getElementById('weight');
        const heightInput = document.getElementById('height');
        const ageInput = document.getElementById('age');
        const genderSelect = document.getElementById('gender');
        const activitySelect = document.getElementById('activity');
        const goalTypeSelect = document.getElementById('goalType'); 
        const calculateButton = document.getElementById('calculateButton');
        const goalText = document.getElementById('goalText');

        // Seletores do DOM - Log
        const foodSearchInput = document.getElementById('foodSearch');
        const searchDropdown = document.getElementById('searchDropdown');
        const mealTimeSelect = document.getElementById('mealTimeSelect');
        const foodQuantityInput = document.getElementById('foodQuantity');
        const mealSuggestion = document.getElementById('mealSuggestion'); 
        const addFoodButton = document.getElementById('addFoodButton');
        
        // Seletores do DOM - Hist√≥rico (Limpar foi removido)
        const goalTag = document.getElementById('goalTag'); 

        // Seletores do DOM - Lista e Totais
        const foodListContainer = document.getElementById('foodList');
        const emptyListText = document.getElementById('emptyListText');
        const totalProteinsEl = document.getElementById('totalProteins'); 
        const totalCarbsEl = document.getElementById('totalCarbs');
        const totalCalsGoalText = document.getElementById('totalCalsGoalText');
        const calorieProgress = document.getElementById('calorieProgress');
        const shareButton = document.getElementById('shareButton'); 
        const shareAppButton = document.getElementById('shareAppButton'); 

        // Seletores do Modal
        const modalOverlay = document.getElementById('modalOverlay');
        const warningModal = document.getElementById('warningModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalGoalText = document.getElementById('modalGoalText');

        // --- Associa o Inicializador ao Carregamento da P√°gina ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
</body>
</html>
