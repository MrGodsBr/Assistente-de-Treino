<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FITNESS-PRO 2.0</title>
  <meta name="theme-color" content="#16a34a">
  <meta name="description" content="FITNESS-PRO 2.0 - Assistente de nutri√ß√£o e fitness">

  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  <meta name="apple-mobile-web-app-title" content="FITNESS-PRO 2.0">
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* DEFINI√á√ÉO DA COR DAS PROTE√çNAS (ex: Tailwind emerald-500/600) */
    :root {
        --cor-proteinas-base: #10B981;
        --cor-proteinas-dark: #059669;
        --ai-grad-start: #ff7e5f; 
        --ai-grad-end: #feb47b;   
        --ai-grad-bg: #8e44ad;   
    }
    
    /* GRADIENTE CUSTOMIZADO para simular o bot√£o */
    .ai-button-gradient {
        background-image: linear-gradient(to right, #e74c3c, #f39c12);
        position: relative;
        overflow: hidden;
        background: linear-gradient(90deg, #bb74b9 0%, #ff8c00 100%);
    }

    /* 1. CAIXA ALTA PARA OS T√çTULOS SOLICITADOS */
    .titulo-secao-caixa-alta {
        text-transform: uppercase;
    }
    
    /* 2. COR DA BARRA DE META DE PESO IGUAL √Ä DAS PROTE√çNAS */
    #weightProgress {
        background-color: var(--cor-proteinas-base) !important; 
    }
    
    /* T√≠tulos do seu c√≥digo original */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    #calorieProgress, #waterProgress, #weightProgress { transition: width 0.3s ease-in-out; } 
    .modal-transition { transition: opacity 0.3s, transform 0.3s; }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    /* Estilos para a nova estrutura de lista */
    .meal-section { border-top: 1px solid #e5e7eb; padding-top: 1rem; }
    .meal-section:first-child { border-top: none; padding-top: 0; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex flex-col items-center justify-start p-4 py-8">

  <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
    <div class="spinner rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600"></div>
    <p class="text-xl font-semibold text-green-700 mt-4">Conectando ao app...</p>
  </div>
  
  <div id="fullRegistrationModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="fullRegistrationModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <h3 class="text-2xl font-bold text-gray-800 text-center mb-4" id="regModalTitle">Crie sua Conta</h3>
    <p id="regError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

    <div class="space-y-4">
      <div class="flex flex-col items-center">
        <img id="regProfileImage" src="https://placehold.co/96x96/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-24 h-24 rounded-full object-cover shadow-lg mb-2 cursor-pointer" onclick="document.getElementById('regProfilePicInput').click()">
        <button type="button" onclick="document.getElementById('regProfilePicInput').click()" class="text-sm text-blue-600 hover:underline">Selecionar Foto</button>
        <input type="file" id="regProfilePicInput" class="hidden" accept="image/*">
      </div>

      <div>
        <label for="regUserNameInput" class="block text-sm font-medium text-gray-700">Nome de Usu√°rio *</label>
        <input type="text" id="regUserNameInput" placeholder="Seu nome" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      
      <div id="registrationFields">
          <div>
            <label for="regEmailInput" class="block text-sm font-medium text-gray-700">Email *</label>
            <input type="email" id="regEmailInput" placeholder="seu.email@exemplo.com" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <div>
            <label for="regPasswordInput" class="block text-sm font-medium text-gray-700">Senha * (M√≠n. 6 caracteres)</label>
            <div class="relative mt-1">
              <input type="password" id="regPasswordInput" placeholder="Sua senha" class="w-full p-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
              <button type="button" onclick="togglePasswordVisibility('regPasswordInput')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                <svg id="regPasswordInput_eye" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: block;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7.25M17.5 14.5c.89 0 1.611-.72 1.611-1.611s-.72-1.611-1.61-1.611-1.61.72-1.61 1.611.72 1.611 1.611 1.611zM12 5c4.478 0 8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25-4.478 0-8.268-2.943-9.543-7.25 1.275 4.307 5.065 7.25 9.543 7.25zm0 0a3 3 0 100 6 3 3 0 000-6z" />
                </svg>
                <svg id="regPasswordInput_eye_open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 19c-4.478 0-8.268-2.943-9.543-7.25C3.732 7.943 7.522 5 12 5s8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25z" />
                </svg>
              </button>
            </div>
          </div>
      </div>

      <div>
        <label for="regPhoneInput" class="block text-sm font-medium text-gray-700">Telefone (opcional)</label>
        <input type="tel" id="regPhoneInput" placeholder="(99) 99999-9999" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>

      <button id="registerAndProfileButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
        Criar Conta e Perfil
      </button>
      <button id="showLoginButton" class="w-full text-sm text-gray-600 font-medium py-2 mt-4 hover:text-gray-900">
        J√° tenho conta. Fazer Login
      </button>
    </div>
  </div>

  <div id="loginModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="loginModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">Fazer Login</h3>
    <p id="loginError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

    <div class="space-y-4">
      <div>
        <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="loginEmail" placeholder="seu.email@exemplo.com" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Senha</label>
        <div class="relative mt-1">
          <input type="password" id="loginPassword" placeholder="Sua senha" class="w-full p-2 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          <button type="button" onclick="togglePasswordVisibility('loginPassword')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
            <svg id="loginPassword_eye" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: block;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7.25M17.5 14.5c.89 0 1.611-.72 1.611-1.611s-.72-1.611-1.61-1.611-1.61.72-1.61 1.611.72 1.611 1.611 1.611zM12 5c4.478 0 8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25-4.478 0-8.268-2.943-9.543-7.25 1.275 4.307 5.065 7.25 9.543 7.25zm0 0a3 3 0 100 6 3 3 0 000-6z" />
            </svg>
            <svg id="loginPassword_eye_open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM12 19c-4.478 0-8.268-2.943-9.543-7.25C3.732 7.943 7.522 5 12 5s8.268 2.943 9.543 7.25c-1.275 4.307-5.065 7.25-9.543 7.25z" />
            </svg>
          </button>
        </div>
      </div>
      <button id="loginSubmitButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
        Entrar
      </button>
      <button id="showRegistrationButton" class="w-full text-sm text-gray-600 font-medium py-2 mt-4 hover:text-gray-900">
        N√£o tenho conta. Criar Perfil
      </button>
    </div>
  </div>

  <div id="warningModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="warningModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
        <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mt-4">Meta Atingida!</h3>
      <p class="text-base text-gray-600 mt-2">Voc√™ ultrapassou sua meta de calorias do dia.</p>
      <p id="modalGoalText" class="text-sm text-gray-500 mt-1"></p>
      <button id="closeWarningModalButton" class="mt-6 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
        Entendi
      </button>
    </div>
  </div>
    
  <div id="aiModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="aiModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-md p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-start mb-4 border-b pb-3">
      <h3 class="text-2xl font-bold text-green-700">üß† An√°lise de IA (Gemini)</h3>
      <button onclick="hideAIModal()" class="text-gray-400 hover:text-gray-600">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    
    <div id="aiAnalysisContent" class="space-y-4 text-gray-700">
        <p class="text-center font-medium">Analisando dados...</p>
        <div class="spinner mx-auto h-8 w-8 border-t-2 border-b-2 border-green-600"></div>
    </div>
    
    <button onclick="hideAIModal()" class="mt-6 w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
      Fechar An√°lise
    </button>
  </div>

  <div id="customFoodModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
  <div id="customFoodModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
    <h3 class="text-2xl font-bold text-gray-800 text-center mb-4">Criar Alimento Customizado</h3>
    <p id="customFoodError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

    <div class="space-y-4">
      <div>
        <label for="customFoodName" class="block text-sm font-medium text-gray-700">Nome do Alimento *</label>
        <input type="text" id="customFoodName" placeholder="Ex: Bolo de Fub√° da Vov√≥" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      
      <button id="fetchMacrosButton" class="w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors text-sm flex items-center justify-center space-x-2">
        <span>ü§ñ Buscar Macros Sugeridos</span>
        <div id="customFoodSpinner" class="spinner h-4 w-4 border-t-2 border-b-2 border-blue-600 hidden"></div>
      </button>

      <div>
        <label for="customFoodUnit" class="block text-sm font-medium text-gray-700">Por√ß√£o *</label>
        <input type="text" id="customFoodUnit" placeholder="Ex: 100g, 1 fatia, 1 unidade" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      
      <div class="grid grid-cols-3 gap-3">
          <div>
            <label for="customFoodCals" class="block text-sm font-medium text-gray-700">Calorias *</label>
            <input type="number" id="customFoodCals" placeholder="kcal" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <div>
            <label for="customFoodProt" class="block text-sm font-medium text-gray-700">Prote√≠nas</label>
            <input type="number" id="customFoodProt" placeholder="g" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <div>
            <label for="customFoodCarbs" class="block text-sm font-medium text-gray-700">Carbos</label>
            <input type="number" id="customFoodCarbs" placeholder="g" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
      </div>
      
      <button id="saveCustomFoodButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
        Salvar e Adicionar
      </button>
      <button id="closeCustomFoodModal" type="button" class="w-full text-sm text-gray-600 font-medium py-2 mt-4 hover:text-gray-900">
        Cancelar
      </button>
    </div>
  </div>


  <div id="mainApp" class="bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-xl space-y-6 hidden">

    <header class="flex justify-between items-center border-b pb-4">
      <h1 class="text-3xl font-bold">
        <span class="text-green-600">FITNESS</span>
        <span class="text-white">-</span>
        <span class="text-blue-600">PRO 2.0</span>
      </h1>
      <button id="shareAppButton" class="text-blue-600 p-2 rounded-full hover:bg-gray-100 transition-colors" title="Compartilhar o App">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.42" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
      </button>
    </header>

    <div id="userProfileDisplay" class="flex items-center space-x-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
      <img id="profileImageDisplay" src="https://placehold.co/64x64/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-16 h-16 rounded-full object-cover shadow-md">
      <div class="flex-grow">
        <span id="userNameDisplay" class="block text-xl font-semibold text-gray-800">Usu√°rio</span>
        <button id="authControlButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors mt-1">
          Fazer Login / Criar Conta
        </button>
      </div>
      <button id="editProfileButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">Editar</button>
    </div>
    
    <details id="goalsDetails" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
      <summary class="text-xl font-semibold text-gray-700 cursor-pointer list-none">
        <div class="flex justify-between items-center text-green-600">
          <span class="titulo-secao-caixa-alta">Minhas Metas</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </div>
      </summary>
      <div id="profileForm" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div>
          <label for="weight" class="block text-sm font-medium text-gray-700">Peso Atual (kg)</label>
          <input type="number" id="weight" placeholder="70" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="targetWeight" class="block text-sm font-medium text-gray-700">Meta Peso (kg)</label>
          <input type="number" id="targetWeight" placeholder="75" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="height" class="block text-sm font-medium text-gray-700">Altura (cm)</label>
          <input type="number" id="height" placeholder="175" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="age" class="block text-sm font-medium text-gray-700">Idade</label>
          <input type="number" id="age" placeholder="25" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="gender" class="block text-sm font-medium text-gray-700">G√™nero</label>
          <select id="gender" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="male">Masculino</option>
            <option value="female">Feminino</option>
          </select>
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="activity" class="block text-sm font-medium text-gray-700">N√≠vel de Atividade</label>
          <select id="activity" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="1.2">Sedent√°rio (pouco ou nenhum)</option>
            <option value="1.375">Leve (1-3 dias/semana)</option>
            <option value="1.55" selected>Moderado (3-5 dias/semana)</option>
            <option value="1.725">Ativo (6-7 dias/semana)</option>
            <option value="1.9">Muito Ativo (trabalho f√≠sico + treino)</option>
          </select>
        </div>
        <div class="col-span-2 sm:col-span-3">
          <label for="goalType" class="block text-sm font-medium text-gray-700">Meu Objetivo</label>
          <select id="goalType" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="ganhar">Ganhar Massa (Bulking)</option>
            <option value="manter">Manter Peso (Manuten√ß√£o)</option>
            <option value="perder">Perder Peso (Cutting)</option>
          </select>
        </div>
        <button id="calculateButton" class="col-span-2 sm:col-span-3 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
          Calcular e Salvar Meta
        </button>
      </div>
      <p id="goalText" class="text-center text-lg font-semibold text-green-700 mt-4 hidden"></p>
    </details>
    <div id="addFoodSection">
      <h2 class="text-xl font-semibold text-gray-700 mb-3 titulo-secao-caixa-alta">Adicionar Alimento</h2> 
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-start">
        <div class="relative sm:col-span-3">
          <label for="foodSearch" class="block text-sm font-medium text-gray-700 mb-1">1. Pesquisar Alimento (Busca na Internet)</label>
          
          <div class="relative">
            <input
              type="text"
              id="foodSearch"
              placeholder="Digite o nome do alimento..."
              class="w-full p-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
              autocomplete="off"
            >
            <button 
              type="button" 
              id="clearSearchButton"
              onclick="clearFoodSearch()" 
              class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors"
              title="Limpar Busca"
            >
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div id="searchDropdown" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-56 overflow-y-auto"></div>
        </div>

        <div class="sm:col-span-2">
          <label for="mealTimeSelect" class="block text-sm font-medium text-gray-700 mb-1">2. Escolher Refei√ß√£o</label>
          <select id="mealTimeSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
            <option value="cafe_da_manha">Caf√© da Man√£</option>
            <option value="almoco">Almo√ßo</option>
            <option value="lanche">Lanche</option>
            <option value="jantar">Jantar</option>
          </select>
        </div>

        <div class="sm:col-span-1">
          <label for="foodQuantity" class="block text-sm font-medium text-gray-700 mb-1">3. Qtd.</label>
          <input
            type="number"
            id="foodQuantity"
            placeholder="Qtd."
            min="0"
            step="0.1"
            class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
          >
        </div>

        <div id="mealSuggestion" class="text-sm text-gray-600 mt-1 sm:col-span-3 px-1"></div>

        <button id="addFoodButton" class="sm:col-span-3 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-3">
          Adicionar Alimento
        </button>
        <button id="shareButton" class="sm:col-span-3 w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors mt-3">
          Compartilhar Resumo no WhatsApp
        </button>
      </div>
    </div>
    <div class="border-t border-gray-200 pt-4">
        <label for="dateSelector" class="block text-lg font-semibold text-gray-700 mb-2 titulo-secao-caixa-alta">Hist√≥rico:</label> 
        <input type="date" id="dateSelector" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
        <p id="dateStatus" class="text-sm text-gray-500 mt-1 text-center"></p>
    </div>
    <div id="hydrationTracker" class="border-t border-gray-200 pt-4 pb-4">
        <h2 class="text-xl font-semibold text-blue-600 mb-3 titulo-secao-caixa-alta">üíß Adicionar Hidrata√ß√£o</h2> 
        <div class="flex items-end space-x-3 mb-4">
            <div class="flex-grow">
                <label for="waterQuantityInput" class="block text-sm font-medium text-gray-700">Qtd. de √Ågua (ml)</label>
                <input
                    type="number"
                    id="waterQuantityInput"
                    placeholder="250"
                    min="50"
                    step="50"
                    value="250"
                    class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
            </div>
            <button id="addWaterButton" class="h-10 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                Adicionar
            </button>
        </div>
    </div>
    <div class="border-b border-gray-200 py-4">
      <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center justify-between space-x-2">
        <span class="titulo-secao-caixa-alta">Refei√ß√µes do Dia:</span> 
        <span id="goalTag" class="text-xs font-medium text-blue-700 bg-blue-100 py-0.5 px-2 rounded-full flex-shrink-0 hidden"></span>
      </h3>
      <div id="foodList" class="overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-4 bg-gray-50 min-h-48">
        <p id="emptyListText" class="text-gray-400 text-center mt-4">Nenhum alimento adicionado ainda.</p>
        <div id="water_container" class="mb-2 meal-section"> 
            <h4 class="font-semibold text-gray-700 mb-2 text-lg titulo-secao-caixa-alta">üíß Registros de √Ågua</h4> 
            <div class="space-y-2" id="list-water"></div>
        </div>
        <div id="cafe_da_manha_container"></div>
        <div id="almoco_container"></div>
        <div id="lanche_container"></div>
        <div id="jantar_container"></div>
      </div>
      <p class="text-xs text-gray-500 mt-2">‚ö†Ô∏è indica alimentos que podem aumentar a gordura visceral.</p>
    </div>
    <div class="space-y-4">
        
        <div class="relative flex justify-between items-center pr-2"> 
            <h2 class="text-xl font-semibold text-gray-800 titulo-secao-caixa-alta my-0">RESUMO DO DIA</h2> 
            
            <button 
                id="openAIModalButton" 
                onclick="analyzeDailySummary()" 
                class="ai-button-gradient flex items-center justify-center space-x-1 px-3 py-1.5 rounded-full text-white font-bold text-sm shadow-md transform hover:scale-[1.05] transition duration-150 ease-in-out"
                title="An√°lise Avan√ßada de IA"
                style="max-width: 150px;"
            >
                 <svg class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.188C2.697 14.01 2 13.042 2 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    <path fill="white" d="M17.485 10.999l1.414 1.414-1.414 1.414-1.414-1.414zM16 8l.5.5.5-.5H16zM20 4l1 1-1 1h-2z"/>
                 </svg>
                
                 <span>AI Assistant</span>
            </button>
        </div>
        <div id="weightProgressSection">
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-emerald-600">Meta de Peso</span> 
          <span id="weightGoalText" class="text-sm font-semibold text-emerald-600">0 kg / 0 kg</span> 
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="weightProgress" class="bg-emerald-500 h-4 rounded-full" style="width: 0%"></div> 
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-blue-600">√Ågua</span>
          <span id="waterGoalText" class="text-sm font-semibold text-blue-600">Consumo: 0 ml / Meta: 0 ml</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="waterProgress" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <div>
        <div class="flex justify-between items-center mb-1">
          <span class="text-base font-medium text-orange-600">Calorias</span>
          <span id="totalCalsGoalText" class="text-sm font-semibold text-orange-600">0 / 0 kcal</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
          <div id="calorieProgress" class="bg-orange-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 text-center">
        <div>
          <p class="text-base font-medium text-emerald-600 mb-1">Prote√≠nas</p>
          <p id="totalProteins" class="text-3xl font-bold text-emerald-600">0 g</p>
          <p id="proteinGoalText" class="text-sm font-medium text-gray-500">Meta: 0 g</p>
        </div>
        <div>
          <p class="text-base font-medium text-blue-600 mb-1">Carboidratos</p>
          <p id="totalCarbs" class="text-3xl font-bold text-blue-600">0 g</p>
          <p id="carbGoalText" class="text-sm font-medium text-gray-500">Meta: 0 g</p>
        </div>
      </div>
      </div>
    </div>

  <footer class="mt-8 text-sm text-gray-500">Desenvolvido por Thiago</footer>

<script>
  // Config do Firebase (client keys podem ficar p√∫blicas; proteja via regras)
  const firebaseConfig = {
    apiKey: "AIzaSyC9WSxM9GA64fq9lkLhsTyvMbD1AlO1MM4",
    authDomain: "assistente-de-treino-668ce.firebaseapp.com",
    projectId: "assistente-de-treino-668ce",
    storageBucket: "assistente-de-treino-668ce.firebasestorage.app",
    messagingSenderId: "878456748339",
    appId: "1:878456748339:web:5b310b5e91a7b23d0ba646",
    measurementId: "G-FCQ5CQT1WY"
  };

  let firebaseApp, firebaseAuth, firebaseDb, userId = null;

  // Estado global
  
  let calorieGoal = 0;
  let proteinGoal = 0; 
  let carbGoal = 0;    
  let fatGoal = 0;     
  let waterGoal = 0;

  let currentWeight = 0;
  let targetWeight = 0;
  
  // selectedFoodKey √© um OBJETO com os dados do alimento (vindo da API ou do foodDatabase)
  let selectedFoodKey = null;
  
  let dailyLog = {};
  let waterLog = 0;
  const TODAY = new Date(); TODAY.setHours(0,0,0,0);
  const todayDateString = TODAY.toISOString().split('T')[0];
  let currentDateString = todayDateString;
  let goalExceededNotified = false;
  let profilePicBase64 = null;
  let isEditingProfile = false;
  let currentGoalType = 'ganhar';
  let unsubscribeListener = null;
  let isInitialLoad = true; 
  
  // Vari√°vel para controlar o "debounce" da busca
  let searchTimeout = null;
  
  // Cache de Alimentos Customizados
  let customFoodCache = {}; 

  const MEAL_KEYS = ['cafe_da_manha', 'almoco', 'lanche', 'jantar'];
  const mealDisplayNames = {
    cafe_da_manha: "‚òï Caf√© da Man√£",
    almoco: "üçΩÔ∏è Almo√ßo",
    lanche: "üçé Lanche",
    jantar: "üç≤ Jantar",
  };
  const ALL_LOG_KEYS = ['water', ...MEAL_KEYS];

  const goalDisplayNames = {
    ganhar: 'Ganho de Massa',
    manter: 'Manuten√ß√£o',
    perder: 'Perda de Peso'
  };

  const mealSuggestions = {
    ganhar: {
      cafe_da_manha: "Ex: Ovos, Aveia, Banana, Whey Protein.",
      almoco: "Ex: Arroz, Peito de Frango, Feij√£o, Batata Doce.",
      lanche: "Ex: P√£o Integral, Pasta de Amendoim, Iogurte Grego.",
      jantar: "Ex: Macarr√£o, Carne Mo√≠da, Salada com Azeite.",
    },
    perder: {
      cafe_da_manha: "Ex: Ovos, Morangos, Caf√© Preto, Iogurte Natural.",
      almoco: "Ex: Salada, Til√°pia, Br√≥colis, Pouco Arroz Integral.",
      lanche: "Ex: Ma√ß√£, Queijo Minas, Castanhas (pouco).",
      jantar: "Ex: Sopa de legumes, Peito de Frango, Alface.",
    },
    manter: {
      cafe_da_manha: "Refei√ß√£o balanceada. Ex: P√£o Integral, Ovos, Mam√£o.",
      almoco: "Equilibre prato. Ex: Arroz, Feij√£o, Bife, Salada.",
      lanche: "Ex: Uvas, Iogurte, Aveia.",
      jantar: "Refei√ß√£o leve. Ex: Batata Doce, Frango, Br√≥colis.",
    }
  };

  // Lista de Favoritos (o antigo foodDatabase)
  const foodDatabase = {
    'whey_protein': { name: 'Whey Protein', protein: 24, carbs: 3, cals: 120, unit: 'scoop 30g', visceralFat: false },
    'creatina': { name: 'Creatina (pura)', protein: 0, carbs: 0, cals: 0, unit: 'scoop 3g', visceralFat: false },
    'ovo_cozido': { name: 'Ovo Cozido', protein: 6.3, carbs: 0.6, cals: 77, unit: 'unidade', visceralFat: false },
    'peito_frango': { name: 'Peito de Frango (grelhado)', protein: 31, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
    'arroz_branco': { name: 'Arroz Branco (cozido)', protein: 2.7, carbs: 28, cals: 130, unit: '100g', visceralFat: false },
    'batata_doce': { name: 'Batata Doce (cozida)', protein: 1.6, carbs: 20, cals: 86, unit: '100g', visceralFat: false },
    'banana': { name: 'Banana', protein: 1.1, carbs: 27, cals: 105, unit: 'unidade', visceralFat: false },
    'maca': { name: 'Ma√ß√£', protein: 0.3, carbs: 25, cals: 95, unit: 'unidade', visceralFat: false },
    'pasta_amendoim': { name: 'Pasta de Amendoim (integral)', protein: 25, carbs: 20, cals: 588, unit: '100g (colher 15g)', visceralFat: false },
    'pao_integral': { name: 'P√£o de Forma (Integral)', protein: 3, carbs: 12, cals: 70, unit: 'fatia', visceralFat: false },
    'cafe_preto': { name: 'Caf√© Preto (sem a√ß√∫car)', protein: 0.1, carbs: 0, cals: 2, unit: 'x√≠cara', visceralFat: false },
  };
  
  // ####################################################################
  // ##                 NOVO DICION√ÅRIO DE TRADU√á√ÉO                  ##
  // ####################################################################
  // PT -> EN (Para buscar na API)
  const translationDictionaryPTEN = {
      'ovo': 'egg',
      'ovos': 'eggs',
      'arroz': 'rice',
      'feij√£o': 'beans',
      'feijao': 'beans',
      'peixe': 'fish',
      'til√°pia': 'tilapia',
      'tilapia': 'tilapia',
      'salm√£o': 'salmon',
      'salmao': 'salmon',
      'frango': 'chicken',
      'peito de frango': 'chicken breast',
      'carne': 'beef',
      'batata': 'potato',
      'batata doce': 'sweet potato',
      'p√£o': 'bread',
      'pao': 'bread',
      'leite': 'milk',
      'queijo': 'cheese',
      'banana': 'banana',
      'ma√ß√£': 'apple',
      'maca': 'apple'
      // Adicione mais tradu√ß√µes simples aqui
  };
  
  // EN -> PT (Para mostrar o resultado)
  const translationDictionaryENPT = {
      'egg': 'Ovo',
      'eggs': 'Ovos',
      'rice': 'Arroz',
      'beans': 'Feij√£o',
      'fish': 'Peixe',
      'salmon': 'Salm√£o',
      'chicken': 'Frango',
      'beef': 'Carne',
      'potato': 'Batata',
      'milk': 'Leite',
      'cheese': 'Queijo',
      'banana': 'Banana',
      'apple': 'Ma√ß√£',
      // Regex para nomes mais complexos (ex: "Fried Egg" -> "Ovo Frito")
      'fried egg': 'Ovo Frito',
      'scrambled egg': 'Ovos Mexidos',
      'chicken breast': 'Peito de Frango'
  };

  function translateQuery(query) {
      const normalizedQuery = normalizeText(query).toLowerCase().trim();
      
      // Tenta traduzir a frase inteira
      if (translationDictionaryPTEN[normalizedQuery]) {
          return translationDictionaryPTEN[normalizedQuery];
      }
      // Se n√£o achar, retorna o termo original
      return normalizedQuery; 
  }
  
  function translateResult(englishName) {
      const englishLower = englishName.toLowerCase();

      // 1. Tenta traduzir a frase exata (Ex: "Fried Egg" -> "Ovo Frito")
      const translatedPhrase = translationDictionaryENPT[englishLower];
      if (translatedPhrase) {
          return translatedPhrase;
      }
      
      // 2. Se n√£o achar, tenta traduzir a primeira palavra (Ex: "Whole Egg" -> "Ovo inteiro")
      const parts = englishName.split(' ');
      if (parts.length > 1) {
          const firstWord = parts[0].toLowerCase();
          if (translationDictionaryENPT[firstWord]) {
              parts[0] = translationDictionaryENPT[firstWord];
              return parts.join(' ');
          }
      }
      
      // 3. Se tudo falhar, retorna o nome em ingl√™s mesmo
      return englishName;
  }
  // ####################################################################


  // Helpers Firebase (com guardas)
  function getDayRef(uid, date) {
    if (!uid) throw new Error('Usu√°rio n√£o autenticado');
    return firebaseDb.collection('users').doc(uid).collection('days').doc(date);
  }
  function getItemsRef(uid, date) {
    return getDayRef(uid, date).collection('items');
  }
  function getProfileDocRef() {
    if (!userId) throw new Error('Usu√°rio n√£o autenticado');
    return firebaseDb.collection('users').doc(userId).collection('data').doc('profile');
  }
  function getMetasDocRef() {
    if (!userId) throw new Error('Usu√°rio n√£o autenticado');
    return firebaseDb.collection('users').doc(userId).collection('data').doc('metas');
  }
  // Refer√™ncia Alimentos Customizados
  function getCustomFoodsRef() {
    if (!userId) throw new Error('Usu√°rio n√£o autenticado');
    return firebaseDb.collection('users').doc(userId).collection('custom_foods');
  }
  

  // UI helpers
  function showElement(el){ el.classList.remove('hidden'); }
  function hideElement(el){ el.classList.add('hidden'); }
  function showModal(modal, overlay){
    showElement(overlay); showElement(modal);
    requestAnimationFrame(()=>{
      modal.classList.remove('scale-90','opacity-0');
      modal.classList.add('scale-100','opacity-100');
    });
  }
  function hideModal(modal, overlay){
    modal.classList.remove('scale-100','opacity-100');
    modal.classList.add('scale-90','opacity-0');
    setTimeout(()=>{ hideElement(modal); hideElement(overlay); clearRegError(); }, 250);
  }
  function showRegError(message){ const el=document.getElementById('regError'); el.textContent=message; showElement(el); }
  function clearRegError(){ const el=document.getElementById('regError'); el.textContent=''; hideElement(el); }
  function showLoginError(message){ const el=document.getElementById('loginError'); el.textContent=message; showElement(el); }
  function clearLoginError(){ const el=document.getElementById('loginError'); el.textContent=''; hideElement(el); }
  function fileToBase64(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=e=>reject(e); r.readAsDataURL(file); }); }
  function saveProfilePicLocally(){
    if(profilePicBase64 && userId){
      localStorage.setItem(`profilePic_${userId}`, profilePicBase64);
      document.getElementById('profileImageDisplay').src=profilePicBase64;
      document.getElementById('regProfileImage').src=profilePicBase64;
    }
  }
  function loadProfilePicLocally(){
    if(!userId) return;
    const pic=localStorage.getItem(`profilePic_${userId}`);
    if(pic){
      profilePicBase64=pic;
      document.getElementById('profileImageDisplay').src=pic;
      document.getElementById('regProfileImage').src=pic;
    }
  }
  function togglePasswordVisibility(fieldId) {
    const input = document.getElementById(fieldId);
    const eye = document.getElementById(fieldId + '_eye');
    const eyeOpen = document.getElementById(fieldId + '_eye_open');
    if (!input || !eye || !eyeOpen) return;
    if (input.type === 'password') {
      input.type = 'text';
      eye.style.display='none';
      eyeOpen.style.display='block';
    } else {
      input.type = 'password';
      eye.style.display='block';
      eyeOpen.style.display='none';
    }
  }
  
  // MODAL DA IA
  function showAIModal(){
    const modal = document.getElementById('aiModal');
    const overlay = document.getElementById('aiModalOverlay');
    showModal(modal, overlay);
  }
  function hideAIModal(){
    hideModal(document.getElementById('aiModal'), document.getElementById('aiModalOverlay'));
  }
  
  // MODAL ALIMENTO CUSTOMIZADO
  function showCustomFoodModal(searchQuery = '') {
    const modal = document.getElementById('customFoodModal');
    const overlay = document.getElementById('customFoodModalOverlay');
    
    document.getElementById('customFoodName').value = searchQuery; 
    document.getElementById('customFoodUnit').value = '100g'; 
    document.getElementById('customFoodCals').value = '';
    document.getElementById('customFoodProt').value = '';
    document.getElementById('customFoodCarbs').value = '';
    
    const errorEl = document.getElementById('customFoodError');
    errorEl.textContent = '';
    hideElement(errorEl);
    
    hideElement(document.getElementById('customFoodSpinner'));
    document.getElementById('fetchMacrosButton').disabled = false;
    
    showModal(modal, overlay);
  }

  function hideCustomFoodModal() {
    hideModal(document.getElementById('customFoodModal'), document.getElementById('customFoodModalOverlay'));
  }

  // Busca macros para o alimento customizado (COM TRADU√á√ÉO)
  async function fetchCustomFoodMacros() {
    const name = document.getElementById('customFoodName').value.trim();
    if (!userId) { showLoginModal(); return; }
    if (name.length < 2) {
      alert("Por favor, digite um nome para o alimento primeiro.");
      return;
    }

    const spinner = document.getElementById('customFoodSpinner');
    const button = document.getElementById('fetchMacrosButton');
    const errorEl = document.getElementById('customFoodError');

    showElement(spinner);
    button.disabled = true;
    errorEl.textContent = '';
    hideElement(errorEl);

    try {
      // 1. TRADUZ A BUSCA (Ex: "Bolo de Fub√°" -> "Bolo de Fuba")
      const translatedName = translateQuery(name);
      
      const response = await fetch(`/api/search?food=${encodeURIComponent(translatedName)}`);
      if (!response.ok) throw new Error('N√£o foi poss√≠vel buscar sugest√µes.');

      const results = await response.json();
      const bestMatch = results[0];

      if (bestMatch) {
        document.getElementById('customFoodUnit').value = bestMatch.serving_desc || '100g';
        document.getElementById('customFoodCals').value = bestMatch.cals.toFixed(0);
        document.getElementById('customFoodProt').value = bestMatch.protein.toFixed(1);
        document.getElementById('customFoodCarbs').value = bestMatch.carbs.toFixed(1);
      } else {
        errorEl.textContent = "Nenhum macro sugerido encontrado. Preencha manualmente.";
        showElement(errorEl);
      }

    } catch (e) {
      console.error("Erro ao buscar macros:", e);
      errorEl.textContent = "Erro ao buscar. Tente novamente.";
      showElement(errorEl);
    } finally {
      hideElement(spinner);
      button.disabled = false;
    }
  }

  // Salva o alimento customizado no Firebase
  async function saveCustomFood() {
    if (!userId) {
      showLoginModal();
      return;
    }

    const errorEl = document.getElementById('customFoodError');
    const button = document.getElementById('saveCustomFoodButton');
    button.disabled = true;
    errorEl.textContent = '';
    hideElement(errorEl);

    try {
      const name = document.getElementById('customFoodName').value.trim();
      const unit = document.getElementById('customFoodUnit').value.trim();
      const cals = parseFloat(document.getElementById('customFoodCals').value);
      const protein = parseFloat(document.getElementById('customFoodProt').value) || 0;
      const carbs = parseFloat(document.getElementById('customFoodCarbs').value) || 0;

      if (!name || !unit || isNaN(cals) || cals < 0) {
        throw new Error("Preencha pelo menos Nome, Por√ß√£o e Calorias.");
      }

      const foodObject = {
        name: name,
        unit: unit, 
        cals: cals,
        protein: protein,
        carbs: carbs,
        fat: 0, 
        serving_desc: unit,
        isCustom: true 
      };
      
      const docRef = await getCustomFoodsRef().add(foodObject);
      
      foodObject.id = docRef.id;
      customFoodCache[docRef.id] = foodObject;
      
      selectFood(foodObject);
      hideCustomFoodModal();

    } catch (e) {
      console.error("Erro ao salvar alimento:", e);
      errorEl.textContent = e.message;
      showElement(errorEl);
    } finally {
      button.disabled = false;
    }
  }
  
  
  // FUN√á√ÉO DE AN√ÅLISE DA IA MELHORADA
  function analyzeDailySummary() {
    if (!userId) { 
        showLoginModal();
        return; 
    }
    
    showAIModal(); 
    const contentEl = document.getElementById('aiAnalysisContent');
    
    // 1. Mostrar estado de carregamento
    contentEl.innerHTML = `
        <p class="text-center font-medium text-gray-700">Aguarde, o Gemini est√° analisando seus dados...</p>
        <div class="spinner mx-auto h-8 w-8 border-t-2 border-b-2 border-green-600"></div>
    `;

    // 2. Coletar Dados para o Prompt
    let totalCals = 0, totalProtein = 0, totalCarbs = 0;
    const foodItems = Object.values(dailyLog).filter(i => i.type === 'food');
    foodItems.forEach(i => { 
        totalCals += i.cals; 
        totalProtein += i.protein; 
        totalCarbs += i.carbs; 
    });
    
    const waterConsumed = waterLog;
    const goalType = currentGoalType;
    const calsRemaining = calorieGoal - totalCals;
    const waterRemaining = waterGoal - waterConsumed;
    const unhealthyItemsCount = 0; 
    const mealsLogged = MEAL_KEYS.filter(meal => foodItems.some(item => item.meal === meal));
    
    // Simula√ß√£o da An√°lise da IA
    setTimeout(() => {
        let analysisHTML = "";
        
        analysisHTML += `<h4 class="font-bold text-xl text-gray-800 border-b pb-1 mb-2">‚≠ê Resumo do Desempenho</h4>`;
        
        let calsStatus, waterStatus;
        
        if (totalCals >= calorieGoal) {
            calsStatus = `<p class="text-green-700 font-semibold">‚úÖ Meta de Calorias: Atingida!</p>`;
        } else {
            calsStatus = `<p class="text-yellow-700 font-semibold">‚ö†Ô∏è Meta de Calorias: ${calsRemaining.toFixed(0)} kcal restantes.</p>`;
        }
        
        if (waterConsumed >= waterGoal) {
            waterStatus = `<p class="text-blue-700 font-semibold">üíß Meta de √Ågua: Atingida!</p>`;
        } else {
            waterStatus = `<p class="text-orange-700 font-semibold">üíß Meta de √Ågua: Faltam ${waterRemaining.toFixed(0)} ml.</p>`;
        }
        
        let proteinStatus = '';
        if (proteinGoal > 0) {
            if (totalProtein >= proteinGoal) {
                proteinStatus = `<p class="text-green-700 font-semibold">üí™ Prote√≠na: Meta Atingida!</p>`;
            } else {
                proteinStatus = `<p class="text-yellow-700 font-semibold">üí™ Prote√≠na: Faltam ${(proteinGoal - totalProtein).toFixed(0)}g.</p>`;
            }
        } else {
             proteinStatus = `<p class="text-gray-500 font-semibold">üí™ Prote√≠na: Nenhuma meta definida.</p>`;
        }
        
        analysisHTML += calsStatus + waterStatus + proteinStatus;
        
        analysisHTML += `<hr class="my-4 border-gray-200">`;
        analysisHTML += `<h4 class="font-bold text-xl text-gray-800 border-b pb-1 mb-2">üçé Qualidade da Dieta</h4>`;

        if (foodItems.length > 3) {
            analysisHTML += `<p class="text-green-700 font-semibold">üåü √ìtima Escolha!</p>`;
            analysisHTML += `<p class="text-sm">Sua dieta hoje pareceu focada em alimentos de alta qualidade. Continue assim para melhorar a composi√ß√£o corporal!</p>`;
        } else if (foodItems.length > 0) {
             analysisHTML += `<p class="text-green-700 font-semibold">üåü Boas escolhas!</p>`;
             analysisHTML += `<p class="text-sm">Voc√™ est√° no caminho certo. Lembre-se de variar os alimentos para obter todos os nutrientes.</p>`;
        } else {
             analysisHTML += `<p class="text-gray-500 text-sm">N√£o h√° dados suficientes para analisar a qualidade da dieta.</p>`;
        }
        
        analysisHTML += `<hr class="my-4 border-gray-200">`;
        analysisHTML += `<h4 class="font-bold text-xl text-gray-800 border-b pb-1 mb-2">üí° Plano de A√ß√£o</h4>`;
        
        if (mealsLogged.length < 3 && foodItems.length > 0) {
            analysisHTML += `<p class="text-yellow-600 font-medium">Melhore a Distribui√ß√£o:</p>`;
            analysisHTML += `<p class="text-sm">Voc√™ registrou apenas ${mealsLogged.length} refei√ß√µes. Tente ter pelo menos 3 a 4 refei√ß√µes bem distribu√≠das.</p>`;
        } else if (calsRemaining > 500 && goalType === 'ganhar') {
            analysisHTML += `<p class="text-yellow-600 font-medium">Estrat√©gia para Bulking:</p>`;
            analysisHTML += `<p class="text-sm">Para bater sua meta de Ganho de Massa, adicione lanches l√≠quidos (shakes) entre as refei√ß√µes.</p>`;
        } else if (waterRemaining > 500) {
            analysisHTML += `<p class="text-blue-600 font-medium">Foco na Hidrata√ß√£o:</p>`;
            analysisHTML += `<p class="text-sm">Deixe uma garrafa de √°gua √† vista. Bater a meta de √°gua √© crucial.</p>`;
        } else {
            analysisHTML += `<p class="text-green-700 font-medium">Recomenda√ß√£o:</p>`;
            analysisHTML += `<p class="text-sm">Mantenha a consist√™ncia! Seu plano para amanh√£ deve seguir a mesma estrutura.</p>`;
        }
        
        contentEl.innerHTML = analysisHTML;

    }, 2000); 
  }

  // AUTENTICA√á√ÉO E PERFIL
  function showRegistrationModal(isEdit = false) {
    isEditingProfile = isEdit;
    const modal = document.getElementById('fullRegistrationModal');
    const overlay = document.getElementById('fullRegistrationModalOverlay');

    clearRegError();
    document.getElementById('regModalTitle').textContent = isEdit ? 'Editar Perfil' : 'Crie sua Conta';

    const regFields = document.getElementById('registrationFields');
    const saveButton = document.getElementById('registerAndProfileButton');
    const showLoginBtn = document.getElementById('showLoginButton');

    if (isEdit) {
      regFields.classList.add('hidden');
      saveButton.textContent = 'Salvar Perfil';
      showLoginBtn.classList.add('hidden');
      const nameInput = document.getElementById('regUserNameInput');
      const phoneInput = document.getElementById('regPhoneInput');
      nameInput.value = document.getElementById('userNameDisplay')?.textContent || '';
      phoneInput.value = localStorage.getItem(`phone_${userId}`) || ''; 
    } else {
      regFields.classList.remove('hidden');
      saveButton.textContent = 'Criar Conta e Perfil';
      showLoginBtn.classList.remove('hidden');
      document.getElementById('regEmailInput').value = '';
      document.getElementById('regPasswordInput').value = '';
      document.getElementById('regUserNameInput').value = '';
      document.getElementById('regPhoneInput').value = '';
    }

    showModal(modal, overlay);
  }

  function hideRegistrationModal(){
    hideModal(document.getElementById('fullRegistrationModal'), document.getElementById('fullRegistrationModalOverlay'));
  }
  function showLoginModal(){
    clearLoginError();
    showModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
  }
  function hideLoginModal(){
    hideModal(document.getElementById('loginModal'), document.getElementById('loginModalOverlay'));
  }

  // Firebase init (compat)
  function initFirebase() {
    // ###########################################
    // ## A CORRE√á√ÉO DE INICIALIZA√á√ÉO EST√Å AQUI ##
    // ###########################################
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.firestore();
    
    try {
        firebaseDb.enablePersistence().catch(err => {
            if (err.code === 'failed-precondition') {
                console.warn('Persist√™ncia n√£o habilitada (Multiplas abas).');
            } else if (err.code === 'unimplemented') {
                console.warn('Persist√™ncia n√£o suportada neste navegador.');
            } else {
                 console.error('Erro ao habilitar persist√™ncia:', err);
            }
        });
    } catch (e) {
        console.warn('Erro ao tentar habilitar persist√™ncia.');
    }
  }
  
  // Carregar o perfil e metas
  async function loadProfileAndMetas(){
      try{
        if (!userId) return false;
        
        const pSnap = await getProfileDocRef().get();
        
        if(pSnap.exists){
          const d=pSnap.data();
          document.getElementById('userNameDisplay').textContent=d.userName||firebaseAuth.currentUser.displayName||'Usu√°rio';
          localStorage.setItem(`phone_${userId}`, d.phone || ''); 
          loadProfilePicLocally();
          
          const mSnap = await getMetasDocRef().get();
          if(mSnap.exists){
            const mData=mSnap.data();
            document.getElementById('weight').value=mData.weight||'';
            document.getElementById('targetWeight').value=mData.targetWeight||''; 
            document.getElementById('height').value=mData.height||'';
            document.getElementById('age').value=mData.age||'';
            document.getElementById('gender').value=mData.gender||'male';
            document.getElementById('activity').value=mData.activity||'1.55';
            document.getElementById('goalType').value=mData.goalType||'ganhar';
            
            calorieGoal = parseFloat(mData.calorieGoal)||0;
            waterGoal = parseFloat(mData.waterGoal)||0; 
            proteinGoal = parseFloat(mData.proteinGoal) || 0;
            carbGoal = parseFloat(mData.carbGoal) || 0;    
            fatGoal = parseFloat(mData.fatGoal) || 0;        

            currentGoalType = mData.goalType||'ganhar';
            currentWeight = parseFloat(mData.weight)||0; 
            targetWeight = parseFloat(mData.targetWeight)||0; 
          }
          updateGoalDisplay();
          updateMealSuggestion();
          return true; // Sucesso
        } else {
             showRegistrationModal(false); 
             return false; // Perfil n√£o completo
        }

      }catch(e){
        console.error("Erro ao carregar perfil/metas:", e); 
        if(userId) showRegistrationModal(false);
        return false;
      }
    }
    
  // Carregar Alimentos Customizados
  async function loadCustomFoods() {
    if (!userId) return;
    customFoodCache = {}; 
    try {
      const snap = await getCustomFoodsRef().get();
      snap.forEach(doc => {
        customFoodCache[doc.id] = { id: doc.id, ...doc.data() };
      });
      console.log("Alimentos customizados carregados:", Object.keys(customFoodCache).length);
    } catch (e) {
      console.error("Erro ao carregar alimentos customizados:", e);
    }
  }

  
  // Auth state
  function attachAuthListener() {
    firebaseAuth.onAuthStateChanged(async (user) => {
      if (isInitialLoad) {
          hideElement(document.getElementById('loadingScreen'));
          isInitialLoad = false;
      }

      if (user) {
        userId = user.uid;
        document.getElementById('authControlButton').textContent = 'Fazer Logout';
        document.getElementById('authControlButton').onclick = () => firebaseAuth.signOut();
        
        const profileLoaded = await loadProfileAndMetas();
        
        if (profileLoaded) {
            hideElement(document.getElementById('fullRegistrationModalOverlay'));
            hideElement(document.getElementById('fullRegistrationModal'));
            hideElement(document.getElementById('loginModalOverlay'));
            hideElement(document.getElementById('loginModal'));

            showElement(document.getElementById('mainApp'));
            
            await loadCustomFoods(); 
            loadDayData(currentDateString); 
            
            document.getElementById('goalsDetails').classList.remove('opacity-50');
            document.getElementById('addFoodSection').classList.remove('opacity-50');
            document.getElementById('hydrationTracker').classList.remove('opacity-50');

        } else {
            hideElement(document.getElementById('mainApp'));
            document.getElementById('goalsDetails').classList.add('opacity-50');
            document.getElementById('addFoodSection').classList.add('opacity-50');
            document.getElementById('hydrationTracker').classList.add('opacity-50');
        }

      } else {
        userId = null;
        if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; } 
        customFoodCache = {}; 
        
        hideElement(document.getElementById('mainApp'));
        document.getElementById('authControlButton').textContent = 'Fazer Login / Criar Conta';
        document.getElementById('authControlButton').onclick = () => showLoginModal();
        document.getElementById('userNameDisplay').textContent = 'Visitante';
        
        const hasEverLoggedIn = localStorage.getItem('hasEverLoggedIn') === 'true';

        if (hasEverLoggedIn) {
             showLoginModal();
        } else {
             showRegistrationModal(false); 
        }

        document.getElementById('goalsDetails').classList.add('opacity-50');
        document.getElementById('addFoodSection').classList.add('opacity-50');
        document.getElementById('hydrationTracker').classList.add('opacity-50');
      }
    });
  }

  // L√≥gica de Metas e UI (mantida)
  
  async function saveMetas(){
    if (!userId) { showLoginModal(); return; } 
      
    const weight=parseFloat(document.getElementById('weight').value);
    const targetWeightInput=document.getElementById('targetWeight'); 
    const targetWeightValue=parseFloat(targetWeightInput.value); 
    const height=parseFloat(document.getElementById('height').value);
    const age=parseFloat(document.getElementById('age').value);
    const gender=document.getElementById('gender').value;
    const activity=parseFloat(document.getElementById('activity').value);
    const goalType=document.getElementById('goalType').value;
    const goalText=document.getElementById('goalText');

    if(isNaN(weight)||isNaN(height)||isNaN(age)||weight<=0||height<=0||age<=0){
      goalText.textContent="Por favor, preencha Peso, Altura e Idade corretamente.";
      goalText.classList.remove('hidden','text-green-700');
      goalText.classList.add('text-red-600');
      return;
    }
    
    if(goalType !== 'manter' && (isNaN(targetWeightValue) || targetWeightValue <= 0 || targetWeightValue === weight)){
      goalText.textContent="Por favor, insira uma Meta de Peso v√°lida, diferente do peso atual, para o seu objetivo.";
      goalText.classList.remove('hidden','text-green-700');
      goalText.classList.add('text-red-600');
      return;
    }

    let bmr = (10*weight)+(6.25*height)-(5*age)+(gender==='male'?5:-161);
    const tdee = bmr*activity;
    let finalCalorieGoal = goalType==='perder'? tdee-400 : goalType==='manter'? tdee : tdee+400;

    let mlPerKg = 35;
    if (age >= 56 && age <= 65) {
        mlPerKg = 30;
    } else if (age > 65) {
        mlPerKg = 25;
    }
    const finalWaterGoal = Math.round(weight * mlPerKg);

    let proteinGoalInGrams = 0;
    if (goalType === 'manter') {
        proteinGoalInGrams = weight * 1.8; 
    } else {
        proteinGoalInGrams = weight * 2.0;
    }
    const caloriesFromProtein = proteinGoalInGrams * 4;
    const caloriesFromFat = finalCalorieGoal * 0.25;
    const fatGoalInGrams = caloriesFromFat / 9;
    const caloriesFromCarbs = finalCalorieGoal - caloriesFromProtein - caloriesFromFat;
    const carbGoalInGrams = caloriesFromCarbs / 4;


    calorieGoal=finalCalorieGoal;
    waterGoal=finalWaterGoal;
    proteinGoal = proteinGoalInGrams;
    carbGoal = carbGoalInGrams;
    fatGoal = fatGoalInGrams;
    
    currentGoalType=goalType;
    currentWeight = weight; 
    targetWeight = targetWeightValue; 

    try{
      await getMetasDocRef().set({ 
          weight, targetWeight: targetWeightValue, height, age, gender, activity, goalType, 
          calorieGoal: parseFloat(finalCalorieGoal.toFixed(0)), 
          waterGoal: parseFloat(finalWaterGoal.toFixed(0)),   
          proteinGoal: parseFloat(proteinGoalInGrams.toFixed(0)),
          carbGoal: parseFloat(carbGoalInGrams.toFixed(0)),
          fatGoal: parseFloat(fatGoalInGrams.toFixed(0))
      }, { merge: true });

      updateGoalDisplay();
      updateTotals(false);
      updateWaterTracker(true); 
      updateWeightProgress(); 
      updateMealSuggestion();
      goalText.textContent="Metas salvas com sucesso!";
      goalText.classList.remove('hidden','text-red-600');
      goalText.classList.add('text-green-700');
    }catch(e){
      goalText.textContent="Erro ao salvar meta. Verifique sua conex√£o.";
      goalText.classList.remove('hidden','text-green-700');
      goalText.classList.add('text-red-600');
    }
  }

  function updateGoalDisplay(){
    const goalText=document.getElementById('goalText');
    if(calorieGoal>0){
      const goalType=document.getElementById('goalType').value||'ganhar';
      const goalName=goalDisplayNames[goalType];
      goalText.textContent=`Sua meta (${goalName}): ${calorieGoal.toFixed(0)} kcal/dia`;
      goalText.classList.remove('hidden','text-red-600');
      goalText.classList.add('text-green-700');
      document.getElementById('goalTag').textContent=goalName;
      showElement(document.getElementById('goalTag'));
    }else{
      goalText.textContent="Clique em 'Calcular e Salvar Meta'.";
      goalText.classList.remove('hidden','text-green-700','text-red-600');
      goalText.classList.add('text-gray-600');
      hideElement(document.getElementById('goalTag'));
    }
    
    if (proteinGoal > 0) {
        document.getElementById('proteinGoalText').textContent = `Meta: ${proteinGoal.toFixed(0)} g`;
    } else {
        document.getElementById('proteinGoalText').textContent = `Meta: 0 g`;
    }
    if (carbGoal > 0) {
        document.getElementById('carbGoalText').textContent = `Meta: ${carbGoal.toFixed(0)} g`;
    } else {
        document.getElementById('carbGoalText').textContent = `Meta: 0 g`;
    }

    updateWaterTracker(true); 
    updateWeightProgress(); 
  }
  
  function updateWeightProgress() {
      const goalText = document.getElementById('weightGoalText');
      const progressEl = document.getElementById('weightProgress');
      const progressSection = document.getElementById('weightProgressSection');

      if (currentWeight === 0 || targetWeight === 0 || currentGoalType === 'manter') {
          hideElement(progressSection);
          return;
      }
      
      showElement(progressSection); 

      const startWeight = parseFloat(document.getElementById('weight').value) || 0; 
      const current = currentWeight;
      const target = targetWeight;

      const initial = startWeight > 0 ? startWeight : current;

      if (target === initial) {
          progressEl.style.width = '0%';
          progressEl.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-400', 'bg-indigo-500'); 
          progressEl.classList.add('bg-emerald-500'); 
          goalText.textContent = `${current.toFixed(1)} kg / ${target.toFixed(1)} kg`;
          return;
      }

      let progress = 0;
      let totalChange = Math.abs(target - initial);
      
      if (totalChange > 0) {
          
          if (target < initial) { 
              progress = ((initial - current) / totalChange) * 100;
              progressEl.classList.remove('bg-green-500', 'bg-gray-400', 'bg-indigo-500');
              progressEl.classList.add('bg-red-500'); 
          } else { 
              progress = ((current - initial) / totalChange) * 100;
              progressEl.classList.remove('bg-red-500', 'bg-gray-400', 'bg-indigo-500');
              progressEl.classList.add('bg-green-500'); 
          }
      }
      
      progress = Math.min(Math.max(progress, 0), 100); 

      progressEl.style.width = progress + '%';
      goalText.textContent = `${current.toFixed(1)} kg / ${target.toFixed(1)} kg (${progress.toFixed(0)}%)`;
  }

  function updateMealSuggestion(){
    const el=document.getElementById('mealSuggestion');
    if(calorieGoal===0){ el.innerHTML='Preencha e salve suas metas acima para ver sugest√µes de refei√ß√µes.'; return; }
    const goalType=document.getElementById('goalType').value||'ganhar';
    const mealTime=document.getElementById('mealTimeSelect').value||'cafe_da_manha';
    const txt=mealSuggestions[goalType][mealTime];
    el.innerHTML=`üí° <span class="font-semibold">Sugest√£o p/ ${goalDisplayNames[goalType]}:</span> ${txt}`;
  }

  // L√≥gica de Log Di√°rio (adaptada)

  function clearFoodListUI() {
    MEAL_KEYS.forEach(k => {
        const container = document.getElementById(`${k}_container`);
        if (container) container.innerHTML = '';
    });
    const waterList = document.getElementById('list-water');
    if (waterList) waterList.innerHTML = '';
    manageEmptyListText();
  }
  
  async function loadDayData(dateStr){
    if (!userId) return;
    if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; }
    
    currentDateString = dateStr;
    dailyLog = {}; 
    waterLog = 0; 
    clearFoodListUI();
    updateTotals(false);
    updateWaterTracker(false); 

    const itemsRef = getItemsRef(userId, dateStr);
    
    const isToday = currentDateString === todayDateString;
    const addFoodSection = document.getElementById('addFoodSection');
    const shareButton = document.getElementById('shareButton');
    const dateStatus = document.getElementById('dateStatus');
    const addWaterButton = document.getElementById('addWaterButton'); 
    const waterInput = document.getElementById('waterQuantityInput');

    if (isToday) {
        addFoodSection.classList.remove('opacity-50');
        addFoodSection.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
        shareButton.disabled = false;
        addWaterButton.disabled = false; 
        waterInput.disabled = false;
        dateStatus.textContent = 'Visualizando e Editando o dia de Hoje';
    } else {
        addFoodSection.classList.add('opacity-50');
        addFoodSection.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
        shareButton.disabled = true;
        addWaterButton.disabled = true; 
        waterInput.disabled = true;
        dateStatus.textContent = `Visualizando Hist√≥rico (Somente Leitura) em ${dateStr}`;
    }

    let initialLoad = true;
    unsubscribeListener = itemsRef.orderBy('clientTs','asc').onSnapshot(
      { includeMetadataChanges: true },
      (snap)=>{
        let shouldUpdateTotals = false;
        
        if (initialLoad) {
          dailyLog = {};
          clearFoodListUI();
        }

        snap.docChanges().forEach(change => {
          const item = { ...change.doc.data(), id: change.doc.id };
          shouldUpdateTotals = true;
          
          if (change.type === "added" || change.type === "modified") {
              dailyLog[item.id] = item;
              updateFoodItemElement(item); 
          }
          
          if (change.type === "removed") {
              delete dailyLog[item.id];
              removeFoodItemElement(item.id); 
          }
        });
        
        waterLog = Object.values(dailyLog)
                     .filter(i => i.type === 'water')
                     .reduce((total, item) => total + item.quantity, 0);

        if(shouldUpdateTotals) {
          updateTotals(true);
          updateWaterTracker(true);
        }
        
        manageEmptyListText();
        initialLoad = false;
      },
      (error) => {
          console.error("Erro no listener do Firestore:", error);
      }
    );
  }

  // Fun√ß√µes de UI (updateFoodItemElement, removeFoodItemElement, manageEmptyListText, etc)
  function updateFoodItemElement(item){
      const existingElement = document.getElementById(`food-item-${item.id}`);
      
      let newItemElement;
      let listContainer;

      if (item.type === 'water') {
          newItemElement = createWaterItemElement(item);
          listContainer = document.getElementById('list-water');
      } else {
          newItemElement = createFoodItemElement(item);
          
          const mealContainer = document.getElementById(`${item.meal}_container`);
          let mealSection = document.getElementById(`section-${item.meal}`);

          if (!mealSection) {
              mealSection = document.createElement('div');
              mealSection.id = `section-${item.meal}`;
              mealSection.className = 'meal-section mb-2';
              mealSection.innerHTML = `<h4 class="font-semibold text-gray-700 mb-2 text-lg">${mealDisplayNames[item.meal]}</h4><div class="space-y-2" id="list-${item.meal}"></div>`;
              if (mealContainer) mealContainer.appendChild(mealSection);
          }
          listContainer = document.getElementById(`list-${item.meal}`);
      }
      
      if (existingElement) {
          existingElement.remove();
      }

      if (listContainer) {
          const itemIds = Object.keys(dailyLog).filter(id => {
              const logItem = dailyLog[id];
              return logItem.type === item.type && 
                     (item.type === 'water' || logItem.meal === item.meal);
          }).sort((a, b) => dailyLog[a].clientTs - dailyLog[b].clientTs);

          const itemIndex = itemIds.indexOf(item.id);
          
          if (itemIndex > 0) {
              const prevItemId = itemIds[itemIndex - 1];
              const prevElement = document.getElementById(`food-item-${prevItemId}`);
              if (prevElement) {
                  prevElement.after(newItemElement);
              } else {
                  listContainer.appendChild(newItemElement);
              }
          } else if (itemIndex === 0) {
               const firstElement = listContainer.firstChild;
               if(firstElement) {
                   listContainer.insertBefore(newItemElement, firstElement);
               } else {
                   listContainer.appendChild(newItemElement);
               }
          } else {
              listContainer.appendChild(newItemElement);
          }
          
          if (item.type !== 'water') {
              const mealSection = listContainer.closest('.meal-section');
              if (mealSection && !mealSection.id.startsWith('section-')) {
                 mealSection.id = `section-${item.meal}`; 
              }
          }
      }
  }

  function removeFoodItemElement(itemId){
      const element = document.getElementById(`food-item-${itemId}`);
      if(element){
          const listContainer = element.parentNode;
          element.remove();
          if (listContainer) {
              if (listContainer.children.length === 0 && listContainer.id !== 'list-water') {
                  const mealSection = listContainer.closest('.meal-section');
                  if (mealSection) mealSection.remove();
              }
          }
      }
  }

  function createWaterItemElement(item){
      const div = document.createElement('div');
      div.id = `food-item-${item.id}`;
      div.className = "flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200";
      
      const isToday = currentDateString === todayDateString;
      const deleteButtonHtml = isToday ? `
          <button onclick="removeFoodFromLog('${item.id}')" class="ml-2 text-red-600 hover:text-red-800 transition-colors" title="Remover">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
          </button>
      ` : `<div class="w-7 h-7"></div>`;

      div.innerHTML = `
          <div class="flex-grow">
              <p class="font-medium text-blue-800">${item.name}</p>
              <p class="text-sm">
                  <span class="text-gray-600">${item.quantity} ml</span> 
                  ${item.timeStr ? `<span class="text-gray-400 mx-1">|</span> <span class="text-gray-500 font-medium">${item.timeStr}</span>` : ''}
              </p>
          </div>
          ${deleteButtonHtml}
      `;
      return div;
  }

  function createFoodItemElement(item){
    const warn = '';
    const div = document.createElement('div');
    div.id = `food-item-${item.id}`;
    div.className = "flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200";
    
    const isToday = currentDateString === todayDateString;
    const deleteButtonHtml = isToday ? `
      <button onclick="removeFoodFromLog('${item.id}')" class="ml-2 text-red-600 hover:text-red-800 transition-colors" title="Remover">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </button>
    ` : `<div class="w-7 h-7"></div>`; 
    
    // ####################################################################
    // ##                 TRADUZINDO O NOME DO ALIMENTO                ##
    // ####################################################################
    const displayName = translateResult(item.name);
    // ####################################################################

    div.innerHTML = `
      <div class="flex-grow">
        <p class="font-medium text-gray-800">${displayName}${warn}</p>
        <p class="text-sm">
          <span class="text-gray-600">${item.quantity} ${item.unit} ‚Ä¢ </span>
          <span class="text-orange-600 font-semibold">${item.cals} kcal</span>
          ${item.timeStr ? `<span class="text-gray-400 mx-1">|</span> <span class="text-gray-500 font-medium">${item.timeStr}</span>` : ''}
        </p>
        <p class="text-xs">
          <span class="text-emerald-600 font-medium">P: ${item.protein}g</span>
          <span class="text-gray-400 mx-1">|</span>
          <span class="text-blue-600 font-medium">C: ${item.carbs}g</span>
        </p>
      </div>
      ${deleteButtonHtml}
    `;
    return div;
  }

  function manageEmptyListText(){
      const empty = document.getElementById('emptyListText');
      const hasItems = Object.keys(dailyLog).length > 0;
      
      if (hasItems) {
          hideElement(empty);
      } else {
          showElement(empty);
      }
      
      const waterContainer = document.getElementById('water_container');
      const hasWaterItems = Object.values(dailyLog).some(i => i.type === 'water');
      if (waterContainer) {
          if (hasWaterItems) {
              showElement(waterContainer);
          } else {
              hideElement(waterContainer);
          }
      }
  }

  function updateTotals(checkGoal=true){
    let totalCals=0, totalProtein=0, totalCarbs=0;
    Object.values(dailyLog).filter(i => i.type === 'food').forEach(i=>{ totalCals+=i.cals; totalProtein+=i.protein; totalCarbs+=i.carbs; });
    
    document.getElementById('totalProteins').textContent = totalProtein.toFixed(1)+' g';
    document.getElementById('totalCarbs').textContent   = totalCarbs.toFixed(1)+' g';

    if (proteinGoal > 0) {
        document.getElementById('proteinGoalText').textContent = `Meta: ${proteinGoal.toFixed(0)} g`;
    } else {
        document.getElementById('proteinGoalText').textContent = `Meta: 0 g`;
    }
    
    if (carbGoal > 0) {
        document.getElementById('carbGoalText').textContent = `Meta: ${carbGoal.toFixed(0)} g`;
    } else {
        document.getElementById('carbGoalText').textContent = `Meta: 0 g`;
    }


    const isToday = currentDateString === todayDateString;

    if(calorieGoal>0){
      document.getElementById('totalCalsGoalText').textContent = `${totalCals.toFixed(0)} / ${calorieGoal.toFixed(0)} kcal`;
      const pct=Math.min((totalCals/calorieGoal)*100, 100);
      document.getElementById('calorieProgress').style.width=pct+'%';
      
      if(isToday && checkGoal && !goalExceededNotified && totalCals>=calorieGoal){
        goalExceededNotified=true;
        showGoalExceededModal();
      } else if (!isToday && goalExceededNotified) {
           goalExceededNotified = false;
      }
    }else{
      document.getElementById('totalCalsGoalText').textContent = `${totalCals.toFixed(0)} kcal`;
      document.getElementById('calorieProgress').style.width='0%';
    }
  }

  function showGoalExceededModal(){
    const goalType=document.getElementById('goalType').value||'ganhar';
    document.getElementById('modalGoalText').textContent = `Meta de ${goalDisplayNames[goalType]}: ${calorieGoal.toFixed(0)} kcal atingida!`;
    showModal(document.getElementById('warningModal'), document.getElementById('warningModalOverlay'));
  }
  
  async function addWater() {
    if (!userId) { showLoginModal(); return; } 
    
    if (currentDateString !== todayDateString) {
        alert("Voc√™ s√≥ pode registrar o consumo de √°gua no dia de hoje.");
        return;
    }

    const addWaterButton = document.getElementById('addWaterButton');
    addWaterButton.disabled = true; 
    
    const input = document.getElementById('waterQuantityInput');
    const quantity = parseInt(input.value);

    if (isNaN(quantity) || quantity <= 0) {
        alert("Por favor, insira uma quantidade de √°gua v√°lida em mililitros.");
        addWaterButton.disabled = false;
        return;
    }
    
    const itemsRef = getItemsRef(userId, todayDateString);

    try {
        const now = new Date();
        const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; 
        
        const payload = {
            type: 'water', 
            name: '√Ågua Pura',
            quantity: quantity,
            unit: 'ml',
            ts: firebase.firestore.FieldValue.serverTimestamp(), 
            clientTs: Date.now(),
            timeStr: timeStr 
        };

        await itemsRef.add(payload);

        input.value = '250'; 
    } catch (e) {
        alert("Erro ao registrar √°gua. Tente novamente. Verifique as regras do Firebase.");
        console.error("Erro ao adicionar √°gua:", e);
    } finally {
        addWaterButton.disabled = false; 
    }
  }

  function updateWaterTracker(checkGoal = true) {
      const goalText = document.getElementById('waterGoalText');
      const progressEl = document.getElementById('waterProgress');
      
      goalText.textContent = `Consumo: ${waterLog} ml / Meta: ${waterGoal} ml`;

      if (waterGoal > 0) {
          const pct = Math.min((waterLog / waterGoal) * 100, 100);
          progressEl.style.width = pct + '%';
      } else {
          progressEl.style.width = '0%';
      }
  }

  // ADICIONAR ALIMENTO (Atualizado)
  async function addFoodToLog(){
    if (!userId) { showLoginModal(); return; } 
      
    if(currentDateString !== todayDateString) {
      alert("Voc√™ s√≥ pode adicionar alimentos no dia de hoje.");
      return;
    }
    
    const addFoodButton = document.getElementById('addFoodButton');
    addFoodButton.disabled = true; 
    
    if(!selectedFoodKey || typeof selectedFoodKey !== 'object'){ 
      alert("Por favor, selecione um alimento da lista."); 
      addFoodButton.disabled = false; 
      return; 
    }
    
    const quantity=parseFloat(document.getElementById('foodQuantity').value);
    const meal=document.getElementById('mealTimeSelect').value;
    
    if(isNaN(quantity)||quantity<=0){ 
      alert("Por favor, insira uma quantidade v√°lida."); 
      addFoodButton.disabled = false; 
      return; 
    }

    const f = selectedFoodKey; 
    const now = new Date();
    const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; 
    
    const payload = {
      type: 'food', 
      key: f.id || f.name, 
      name: f.name,
      quantity,
      unit: f.unit || f.serving_desc, 
      
      protein: parseFloat((f.protein * quantity).toFixed(1)),
      carbs: parseFloat((f.carbs * quantity).toFixed(1)),
      cals: parseFloat((f.cals * quantity).toFixed(0)),
      
      visceralFat: f.visceralFat || false, 
      meal,
      ts: firebase.firestore.FieldValue.serverTimestamp(), 
      clientTs: Date.now(),
      timeStr: timeStr 
    };

    const itemsRef = getItemsRef(userId, currentDateString);
    
    try {
      await itemsRef.add(payload);
    } catch (e) {
      alert("Erro ao adicionar alimento. Verifique sua conex√£o e as regras do Firebase.");
      console.error("Erro ao adicionar alimento:", e);
    }
    
    clearFoodSearch();
    addFoodButton.disabled = false;
  }
  
  // LIMPAR A BUSCA
  function clearFoodSearch() {
    document.getElementById('foodSearch').value = '';
    document.getElementById('foodQuantity').value = '';
    document.getElementById('foodQuantity').placeholder = 'Qtd.';
    selectedFoodKey = null;
    hideElement(document.getElementById('searchDropdown'));
    document.getElementById('addFoodButton').disabled = false;
    document.getElementById('foodSearch').focus();
  }

  // REMOVER ALIMENTO
  async function removeFoodFromLog(itemId){
    if (!userId) { showLoginModal(); return; } 
      
    if(currentDateString !== todayDateString) {
      alert("Voc√™ s√≥ pode remover alimentos no dia de hoje.");
      return;
    }

    const itemElement = document.getElementById(`food-item-${itemId}`);
    if (itemElement) itemElement.style.opacity = '0.5';

    const itemsRef = getItemsRef(userId, currentDateString);
    try { 
      await itemsRef.doc(itemId).delete(); 
    } catch (err) { 
      console.error('Falha ao excluir item:', err); 
      alert("Erro ao excluir o registro. Verifique sua conex√£o e permiss√µes (Regras do Firebase).");
      if (itemElement) itemElement.style.opacity = '1';
    }
  }

  function getItemsByMeal() {
      return Object.values(dailyLog)
          .filter(i => i.type === 'food')
          .reduce((acc, item) => {
              const meal = item.meal;
              acc[meal] = acc[meal] || [];
              acc[meal].push(item);
              return acc;
          }, {});
  }

  // ####################################################################
  // ##           FUN√á√ÉO searchFood ATUALIZADA (COM TRADUTOR)          ##
  // ####################################################################
  const normalizeText = (text) => {
      return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  };

  async function searchFood(){
    const q_raw = document.getElementById('foodSearch').value.trim();
    const dd = document.getElementById('searchDropdown');

    clearTimeout(searchTimeout);

    if(q_raw.length < 2){ 
      hideElement(dd); 
      return; 
    }
    
    const q_normalized = normalizeText(q_raw.toLowerCase());
    
    dd.innerHTML = `<div class="p-3 text-gray-500 text-sm text-center">Buscando...</div>`;
    showElement(dd);
    
    let html = '';
    let resultCount = 0;
    
    // 1. Busca R√ÅPIDA nos Alimentos Customizados (do usu√°rio)
    const customResults = Object.values(customFoodCache).filter(f => {
      const nameNormalized = normalizeText(f.name.toLowerCase());
      return nameNormalized.includes(q_normalized);
    });
    
    customResults.forEach(f => {
      html += `
        <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200" 
             onclick='selectFood(${JSON.stringify(f)})'>
          <p class="font-medium text-green-700">‚úèÔ∏è ${f.name} (Meu Alimento)</p>
          <p class="text-xs"><span class="text-orange-600 font-medium">${f.cals} kcal</span> <span class="text-gray-600">por ${f.unit}</span></p>
        </div>
      `;
    });
    resultCount += customResults.length;

    // 2. Busca R√ÅPIDA nos favoritos locais (foodDatabase)
    const localResults = Object.keys(foodDatabase).filter(k => {
      const f = foodDatabase[k];
      const nameNormalized = normalizeText(f.name.toLowerCase());
      return nameNormalized.includes(q_normalized) || k.includes(q_normalized);
    });
    
    localResults.forEach(key => {
      const f = foodDatabase[key];
      const foodObject = {
        id: key, name: f.name, serving_desc: f.unit, cals: f.cals, 
        carbs: f.carbs, protein: f.protein, fat: 0, 
        visceralFat: f.visceralFat 
      };
      
      html += `
        <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200" 
             onclick='selectFood(${JSON.stringify(foodObject)})'>
          <p class="font-medium text-gray-800">‚≠ê ${f.name} (R√°pido)</p>
          <p class="text-xs"><span class="text-orange-600 font-medium">${f.cals} kcal</span> <span class="text-gray-600">por ${f.unit}</span></p>
        </div>
      `;
    });
    resultCount += localResults.length;
    
    if (resultCount > 0) {
      html += `<hr class="my-1 border-gray-300">`; // Divisor
    }
    
    dd.innerHTML = html + `<div id="apiLoading" class="p-3 text-gray-500 text-sm text-center">Buscando na internet...</div>`;


    // 3. Busca na API (com "debounce" e TRADU√á√ÉO)
    searchTimeout = setTimeout(async () => {
      
      // ###############################################################
      // ##                      A TRADU√á√ÉO PT -> EN AQUI             ##
      // ###############################################################
      const translatedQuery = translateQuery(q_raw);
      // ###############################################################
      
      try {
        const response = await fetch(`/api/search?food=${encodeURIComponent(translatedQuery)}`);
        const loadingEl = document.getElementById('apiLoading');
        
        if (!response.ok) {
            if (loadingEl) {
                loadingEl.textContent = "Erro ao buscar na internet.";
                loadingEl.classList.remove("text-gray-500");
                loadingEl.classList.add("text-red-500");
            }
            return; 
        }
        
        const apiResults = await response.json();
        resultCount += apiResults.length;

        // Se n√£o houver NENHUM resultado
        if(resultCount === 0){
          dd.innerHTML = `
            <div class="p-3 text-gray-500 text-center text-sm">Nenhum alimento encontrado.</div>
            <div class="p-2">
              <button 
                onclick="showCustomFoodModal('${q_raw.replace(/'/g, "\\'")}')" 
                class="w-full bg-green-100 text-green-700 font-semibold py-2 px-3 rounded-lg text-sm">
                + Criar alimento "${q_raw}"
              </button>
            </div>
          `;
          return;
        }
        
        // Remove o "Buscando..."
        if (loadingEl) loadingEl.remove();
        
        // Mapeia os resultados da API (E TRADUZ DE VOLTA)
        apiResults.forEach(f => {
          const translatedName = translateResult(f.name); // Traduz o nome
          
          html += `
            <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200" 
                 onclick='selectFood(${JSON.stringify(f)})'>
              <p class="font-medium text-gray-800">${translatedName}</p> 
              <p class="text-xs"><span class="text-orange-600 font-medium">${f.cals.toFixed(0)} kcal</span> <span class="text-gray-600">por ${f.serving_desc}</span></p>
            </div>
          `;
        });
        
        dd.innerHTML = html; 

      } catch (error) {
        console.error("Erro ao chamar a API:", error);
        const loadingEl = document.getElementById('apiLoading');
        if (loadingEl) {
            loadingEl.textContent = "Erro ao buscar na internet.";
            loadingEl.classList.remove("text-gray-500");
            loadingEl.classList.add("text-red-500");
        }
      }
    }, 300); // Aguarda 300ms antes de fazer a chamada
  }
  // ####################################################################


  // SELECIONAR ALIMENTO (Atualizado)
  function selectFood(foodObject){
    if (typeof foodObject === 'string') {
        try {
            foodObject = JSON.parse(foodObject);
        } catch (e) {
            console.error("Falha ao ler o objeto do alimento:", e);
            return;
        }
    }

    selectedFoodKey = foodObject; 
    
    // Mostra o nome traduzido no campo de busca
    document.getElementById('foodSearch').value = translateResult(foodObject.name);
    
    const unit = foodObject.unit || foodObject.serving_desc;
    document.getElementById('foodQuantity').placeholder = `Qtd. (x ${unit})`;
    
    hideElement(document.getElementById('searchDropdown'));
    document.getElementById('foodQuantity').value = '1'; 
    document.getElementById('foodQuantity').focus();
  }


  // Eventos de UI
  function wireUI(){
    // Auth
    document.getElementById('authControlButton').addEventListener('click', ()=>{
      if (userId) {
        firebaseAuth.signOut();
      } else {
        showLoginModal();
      }
    });
    document.getElementById('showLoginButton').addEventListener('click', (e)=>{
      e.preventDefault();
      hideRegistrationModal();
      showLoginModal();
    });
    document.getElementById('showRegistrationButton').addEventListener('click', (e)=>{
      e.preventDefault();
      hideLoginModal();
      showRegistrationModal(false);
    });
    document.getElementById('registerAndProfileButton').addEventListener('click', async ()=>{
      try{
        if (isEditingProfile) {
          // Salvar perfil
          const name = document.getElementById('regUserNameInput').value.trim();
          const phone = document.getElementById('regPhoneInput').value.trim();
          if (!userId) throw new Error('Necess√°rio login para salvar perfil.');
          
          await getProfileDocRef().set({ userName: name, phone, updatedAt: new Date().toISOString() }, { merge: true });
          if (firebaseAuth.currentUser && name) {
            await firebaseAuth.currentUser.updateProfile({ displayName: name });
            localStorage.setItem(`phone_${userId}`, phone || ''); 
            document.getElementById('userNameDisplay').textContent = name;
          }
          saveProfilePicLocally();
          hideRegistrationModal();
        } else {
          // Criar conta
          const email = document.getElementById('regEmailInput').value.trim();
          const pass = document.getElementById('regPasswordInput').value;
          const name = document.getElementById('regUserNameInput').value.trim();
          const phone = document.getElementById('regPhoneInput').value.trim();

          if (!email || !pass || pass.length < 6 || !name) throw new Error('Preencha nome, email e senha (m√≠n. 6).');
          
          const cred = await firebaseAuth.createUserWithEmailAndPassword(email, pass);
          await cred.user.updateProfile({ displayName: name });
          
          userId = cred.user.uid;
          
          await getProfileDocRef().set({ userName: name, phone: phone || null, createdAt: new Date().toISOString() });
          
          saveProfilePicLocally();
          localStorage.setItem('hasEverLoggedIn', 'true');
          hideRegistrationModal();
        }
      } catch(e){
        let errorMessage = e.message || 'Erro ao salvar.';
        if(e.code === 'auth/email-already-in-use') errorMessage = 'Este email j√° est√° em uso.';
        showRegError(errorMessage);
        console.error("Erro na auth/save:", e);
      }
    });
    document.getElementById('loginSubmitButton').addEventListener('click', async ()=>{
      try{
        const email = document.getElementById('loginEmail').value.trim();
        const pass = document.getElementById('loginPassword').value;
        if (!email || !pass) throw new Error('Preencha email e senha.');
        await firebaseAuth.signInWithEmailAndPassword(email, pass);
        localStorage.setItem('hasEverLoggedIn', 'true');
        hideLoginModal();
      } catch(e){
        let errorMessage = e.message || 'Falha no login.';
        if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') errorMessage = 'Email ou senha inv√°lidos.';
        showLoginError(errorMessage);
        console.error("Erro no login:", e);
      }
    });

    // Perfil
    document.getElementById('editProfileButton').addEventListener('click', ()=>{
      if (!userId) { showLoginModal(); } else { showRegistrationModal(true); }
    });
    const picInput = document.getElementById('regProfilePicInput');
    picInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      profilePicBase64 = await fileToBase64(f);
      document.getElementById('regProfileImage').src = profilePicBase64;
    });

    // Data
    const dateInput = document.getElementById('dateSelector');
    dateInput.value = currentDateString;
    dateInput.max = todayDateString;
    dateInput.addEventListener('change', ()=>{
      currentDateString = dateInput.value;
      loadDayData(currentDateString);
    });

    // A√ß√µes
    document.getElementById('calculateButton').addEventListener('click', saveMetas);
    document.getElementById('addFoodButton').addEventListener('click', addFoodToLog);
    document.getElementById('addWaterButton').addEventListener('click', addWater); 
    document.getElementById('goalType').addEventListener('change', updateMealSuggestion);
    document.getElementById('mealTimeSelect').addEventListener('change', updateMealSuggestion);
    
    // Evento de busca agora √© 'input'
    document.getElementById('foodSearch').addEventListener('input', searchFood); 
    
    document.getElementById('shareButton').addEventListener('click', shareToWhatsApp);
    document.getElementById('shareAppButton').addEventListener('click', shareApp);
    document.getElementById('closeWarningModalButton').addEventListener('click', ()=>{
      hideModal(document.getElementById('warningModal'), document.getElementById('warningModalOverlay'));
    });
    
    // MODAL CUSTOMIZADO
    document.getElementById('closeCustomFoodModal').addEventListener('click', hideCustomFoodModal);
    document.getElementById('fetchMacrosButton').addEventListener('click', fetchCustomFoodMacros);
    document.getElementById('saveCustomFoodButton').addEventListener('click', saveCustomFood);

    
    document.addEventListener('click', (e)=>{
      if(!e.target.closest('#foodSearch') && !e.target.closest('#searchDropdown')){
        hideElement(document.getElementById('searchDropdown'));
      }
    });
  }

  // Boot
  (function boot(){
    initFirebase();
    wireUI();
    attachAuthListener();
  })();
</script>
</body>
</html>
