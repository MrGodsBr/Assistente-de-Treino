<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#16a34a">
    <meta name="description" content="Fitness-Pro 2.0 - Seu assistente pessoal de nutrição e fitness">
    <title>Fitness-Pro 2.0</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK v9 (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        
        /* Remove setas do input number */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Animações */
        #calorieProgress {
            transition: width 0.3s ease-in-out;
        }
        
        .modal-transition {
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Loading spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex flex-col items-center justify-start p-4 py-8">
    
    <!-- Tela de Carregamento -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="spinner rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600"></div>
        <p class="text-xl font-semibold text-green-700 mt-4">Conectando ao app...</p>
    </div>

    <!-- Card Principal -->
    <div id="mainApp" class="bg-white w-full max-w-lg p-6 sm:p-8 rounded-2xl shadow-xl space-y-6 hidden fade-in">
        
        <!-- Header -->
        <header class="flex justify-between items-center border-b pb-4">
            <h1 class="text-3xl font-bold text-green-600">Fitness-Pro 2.0</h1>
            <button id="shareAppButton" class="text-blue-600 p-2 rounded-full hover:bg-gray-100 transition-colors" title="Compartilhar o App">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-6"></path>
                    <path d="M15 9l-3-3-3 3"></path>
                    <path d="M12 3v12"></path>
                </svg>
            </button>
        </header>

        <!-- Perfil do Usuário -->
        <div id="userProfileDisplay" class="flex items-center space-x-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
            <img id="profileImageDisplay" src="https://placehold.co/64x64/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-16 h-16 rounded-full object-cover shadow-md">
            <div class="flex-grow">
                <span id="userNameDisplay" class="block text-xl font-semibold text-gray-800">Usuário</span>
            </div>
            <button id="editProfileButton" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
                Editar
            </button>
        </div>

        <!-- Minhas Metas -->
        <details id="goalsDetails" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <summary class="text-xl font-semibold text-gray-700 cursor-pointer list-none">
                <div class="flex justify-between items-center text-green-600">
                    <span>Minhas Metas</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </div>
            </summary>
            <div id="profileForm" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4">
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                    <input type="number" id="weight" placeholder="70" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="height" class="block text-sm font-medium text-gray-700">Altura (cm)</label>
                    <input type="number" id="height" placeholder="175" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Idade</label>
                    <input type="number" id="age" placeholder="25" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="col-span-2 sm:col-span-3">
                    <label for="gender" class="block text-sm font-medium text-gray-700">Gênero</label>
                    <select id="gender" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="male">Masculino</option>
                        <option value="female">Feminino</option>
                    </select>
                </div>
                <div class="col-span-2 sm:col-span-3">
                    <label for="activity" class="block text-sm font-medium text-gray-700">Nível de Atividade</label>
                    <select id="activity" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1.2">Sedentário (pouco ou nenhum)</option>
                        <option value="1.375">Leve (1-3 dias/semana)</option>
                        <option value="1.55" selected>Moderado (3-5 dias/semana)</option>
                        <option value="1.725">Ativo (6-7 dias/semana)</option>
                        <option value="1.9">Muito Ativo (trabalho físico + treino)</option>
                    </select>
                </div>
                <div class="col-span-2 sm:col-span-3">
                    <label for="goalType" class="block text-sm font-medium text-gray-700">Meu Objetivo</label>
                    <select id="goalType" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="ganhar">Ganhar Massa (Bulking)</option>
                        <option value="manter">Manter Peso (Manutenção)</option>
                        <option value="perder">Perder Peso (Cutting)</option>
                    </select>
                </div>
                <button id="calculateButton" class="col-span-2 sm:col-span-3 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    Calcular e Salvar Meta
                </button>
            </div>
            <p id="goalText" class="text-center text-lg font-semibold text-green-700 mt-4 hidden"></p>
        </details>

        <!-- Adicionar Alimento -->
        <div id="addFoodSection">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Alimento</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-start">
                <div class="relative sm:col-span-3">
                    <label for="foodSearch" class="block text-sm font-medium text-gray-700 mb-1">1. Pesquisar Alimento</label>
                    <input 
                        type="text" 
                        id="foodSearch" 
                        placeholder="Digite o nome do alimento..."
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                        autocomplete="off"
                    >
                    <div id="searchDropdown" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-48 overflow-y-auto"></div>
                </div>

                <div class="sm:col-span-2">
                    <label for="mealTimeSelect" class="block text-sm font-medium text-gray-700 mb-1">2. Escolher Refeição</label>
                    <select id="mealTimeSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
                        <option value="cafe_da_manha">Café da Manhã</option>
                        <option value="almoco">Almoço</option>
                        <option value="lanche">Lanche</option>
                        <option value="jantar">Jantar</option>
                    </select>
                </div>
                
                <div class="sm:col-span-1">
                    <label for="foodQuantity" class="block text-sm font-medium text-gray-700 mb-1">3. Qtd.</label>
                    <input 
                        type="number" 
                        id="foodQuantity" 
                        placeholder="Qtd."
                        min="0"
                        step="0.1"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                </div>
                
                <div id="mealSuggestion" class="text-sm text-gray-600 mt-1 sm:col-span-3 px-1"></div>

                <button id="addFoodButton" class="sm:col-span-3 w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-3">
                    Adicionar Alimento
                </button>
                
                <button id="shareButton" class="sm:col-span-3 w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors mt-3">
                    Compartilhar Resumo no WhatsApp
                </button>
            </div>
        </div>

        <!-- Lista de Alimentos -->
        <div class="border-t border-b border-gray-200 py-4">
            <h3 class="text-xl font-semibold text-gray-700 mb-3 flex items-center justify-between space-x-2">
                <span>Suas Refeições:</span>
                <span id="goalTag" class="text-xs font-medium text-blue-700 bg-blue-100 py-0.5 px-2 rounded-full flex-shrink-0 hidden"></span>
            </h3>
            <div id="foodList" class="overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-4 bg-gray-50 min-h-48">
                <p id="emptyListText" class="text-gray-400 text-center mt-4">Nenhum alimento adicionado ainda.</p>
            </div>
        </div>

        <!-- Resumo do Dia -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-800 text-center">Resumo do Dia</h2>
            
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-base font-medium text-orange-600">Calorias</span>
                    <span id="totalCalsGoalText" class="text-sm font-medium text-gray-600">0 / 0 kcal</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
                    <div id="calorieProgress" class="bg-orange-500 h-4 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-base font-medium text-emerald-600 mb-1">Proteínas</p>
                    <p id="totalProteins" class="text-3xl font-bold text-emerald-600">0 g</p>
                </div>
                <div>
                    <p class="text-base font-medium text-blue-600 mb-1">Carboidratos</p>
                    <p id="totalCarbs" class="text-3xl font-bold text-blue-600">0 g</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Rodapé -->
    <footer class="mt-8 text-sm text-gray-500">Desenvolvido por Thiago</footer>

    <!-- Modal de Perfil -->
    <div id="profileModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
    <div id="profileModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
        <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 text-center mb-4">Crie seu Perfil</h3>
        <p id="registrationError" class="text-red-600 text-center font-medium text-sm mb-3 hidden"></p>

        <div class="space-y-4">
            <div class="flex flex-col items-center">
                <img id="modalProfileImage" src="https://placehold.co/96x96/E0F2F1/065F46?text=FP" alt="Foto de Perfil" class="w-24 h-24 rounded-full object-cover shadow-lg mb-2 cursor-pointer" onclick="document.getElementById('profilePicInput').click()">
                <button type="button" onclick="document.getElementById('profilePicInput').click()" class="text-sm text-blue-600 hover:underline">
                    Selecionar Foto
                </button>
                <input type="file" id="profilePicInput" class="hidden" accept="image/*">
            </div>

            <div>
                <label for="userNameInput" class="block text-sm font-medium text-gray-700">Nome de Usuário *</label>
                <input type="text" id="userNameInput" placeholder="Seu nome" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div>
                <label for="phoneInput" class="block text-sm font-medium text-gray-700">Telefone (opcional)</label>
                <input type="tel" id="phoneInput" placeholder="(99) 99999-9999" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>

            <button id="saveProfileButton" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors mt-4">
                Começar a Usar
            </button>
        </div>
    </div>

    <!-- Modal de Aviso de Limite -->
    <div id="warningModalOverlay" class="modal-transition fixed inset-0 bg-black bg-opacity-60 z-40 hidden"></div>
    <div id="warningModal" class="modal-transition fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl z-50 hidden scale-90 opacity-0">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
                <svg class="h-10 w-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mt-4">Meta Atingida!</h3>
            <p class="text-base text-gray-600 mt-2">Você ultrapassou sua meta de calorias do dia.</p>
            <p id="modalGoalText" class="text-sm text-gray-500 mt-1"></p>
            <button id="closeWarningModalButton" class="mt-6 w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                Entendi
            </button>
        </div>
    </div>

    <script>
        // ========== CONFIGURAÇÃO DO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyC9WSxM9GA64fq9lkLhsTyvMbD1AlO1MM4",
            authDomain: "assistente-de-treino-668ce.firebaseapp.com",
            projectId: "assistente-de-treino-668ce",
            storageBucket: "assistente-de-treino-668ce.firebasestorage.app",
            messagingSenderId: "878456748339",
            appId: "1:878456748339:web:5b310b5e91a7b23d0ba646",
            measurementId: "G-FCQ5CQT1WY"
        };
        
        let firebaseApp, firebaseAuth, firebaseDb, userId = null;

        // ========== VARIÁVEIS GLOBAIS ==========
        let calorieGoal = 0;
        let selectedFoodKey = null;
        let dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
        const todayString = new Date().toISOString().split('T')[0];
        let goalExceededNotified = false;
        let profilePicBase64 = null;
        let isEditingProfile = false;
        let currentGoalType = 'ganhar';

        const MEAL_KEYS = ['cafe_da_manha', 'almoco', 'lanche', 'jantar'];
        const mealDisplayNames = {
            cafe_da_manha: "☕ Café da Manhã",
            almoco: "🍽️ Almoço",
            lanche: "🍎 Lanche",
            jantar: "🍲 Jantar",
        };
        const goalDisplayNames = {
            ganhar: 'Ganho de Massa',
            manter: 'Manutenção',
            perder: 'Perda de Peso'
        };

        const mealSuggestions = {
            ganhar: {
                cafe_da_manha: "Ex: Ovos, Aveia, Banana, Whey Protein.",
                almoco: "Ex: Arroz, Peito de Frango, Feijão, Batata Doce.",
                lanche: "Ex: Pão Integral, Pasta de Amendoim, Iogurte Grego.",
                jantar: "Ex: Macarrão, Carne Moída, Salada com Azeite.",
            },
            perder: {
                cafe_da_manha: "Ex: Ovos, Morangos, Café Preto, Iogurte Natural.",
                almoco: "Ex: Salada, Tilápia, Brócolis, Pouco Arroz Integral.",
                lanche: "Ex: Maçã, Queijo Minas, Castanhas (pouco).",
                jantar: "Ex: Sopa de legumes, Peito de Frango, Alface.",
            },
            manter: {
                cafe_da_manha: "Refeição balanceada. Ex: Pão Integral, Ovos, Mamão.",
                almoco: "Equilibre prato. Ex: Arroz, Feijão, Bife, Salada.",
                lanche: "Ex: Uvas, Iogurte, Aveia.",
                jantar: "Refeição leve. Ex: Batata Doce, Frango, Brócolis.",
            }
        };

        // ========== BANCO DE DADOS DE ALIMENTOS ==========
        const foodDatabase = {
            'banana': { name: 'Banana', protein: 1.1, carbs: 27, cals: 105, unit: 'unidade', visceralFat: false },
            'maca': { name: 'Maçã', protein: 0.3, carbs: 25, cals: 95, unit: 'unidade', visceralFat: false },
            'abacate': { name: 'Abacate', protein: 2, carbs: 9, cals: 160, unit: '100g', visceralFat: false },
            'mamao': { name: 'Mamão Formosa', protein: 0.5, carbs: 11, cals: 43, unit: '100g', visceralFat: false },
            'melancia': { name: 'Melancia', protein: 0.6, carbs: 8, cals: 30, unit: '100g', visceralFat: false },
            'uva': { name: 'Uva', protein: 0.7, carbs: 18, cals: 69, unit: '100g', visceralFat: false },
            'laranja': { name: 'Laranja', protein: 1, carbs: 12, cals: 47, unit: 'unidade', visceralFat: false },
            'morango': { name: 'Morango', protein: 0.7, carbs: 8, cals: 32, unit: '100g', visceralFat: false },
            'brocolis': { name: 'Brócolis (cozido)', protein: 2.4, carbs: 7, cals: 35, unit: '100g', visceralFat: false },
            'alface': { name: 'Alface Crespa', protein: 1.4, carbs: 2.9, cals: 15, unit: '100g', visceralFat: false },
            'tomate': { name: 'Tomate', protein: 0.9, carbs: 3.9, cals: 18, unit: '100g', visceralFat: false },
            'cenoura': { name: 'Cenoura (crua)', protein: 0.9, carbs: 10, cals: 41, unit: '100g', visceralFat: false },
            'peito_frango': { name: 'Peito de Frango (grelhado)', protein: 31, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
            'ovo': { name: 'Ovo Cozido', protein: 6.3, carbs: 0.6, cals: 77, unit: 'unidade', visceralFat: false },
            'ovo_frito': { name: 'Ovo Frito (em óleo)', protein: 6.2, carbs: 0.6, cals: 95, unit: 'unidade', visceralFat: false },
            'ovos_mexidos': { name: 'Ovos Mexidos (c/ manteiga)', protein: 6.5, carbs: 1.5, cals: 105, unit: 'unidade (1 ovo)', visceralFat: true },
            'whey_protein': { name: 'Whey Protein', protein: 24, carbs: 3, cals: 120, unit: 'scoop 30g', visceralFat: false },
            'carne_moida': { name: 'Carne Moída (patinho, cozida)', protein: 26, carbs: 0, cals: 180, unit: '100g', visceralFat: false },
            'bife_alcatra': { name: 'Bife (Alcatra, grelhado)', protein: 28, carbs: 0, cals: 165, unit: '100g', visceralFat: false },
            'tilapia': { name: 'Tilápia (grelhada)', protein: 26, carbs: 0, cals: 128, unit: '100g', visceralFat: false },
            'salmao': { name: 'Salmão (grelhado)', protein: 20, carbs: 0, cals: 208, unit: '100g', visceralFat: false },
            'atum_lata': { name: 'Atum em Lata (em óleo)', protein: 29, carbs: 0, cals: 186, unit: '100g', visceralFat: false },
            'leite_integral': { name: 'Leite Integral', protein: 3.2, carbs: 5, cals: 61, unit: '100ml', visceralFat: true },
            'leite_desnatado': { name: 'Leite Desnatado', protein: 3.4, carbs: 5, cals: 35, unit: '100ml', visceralFat: false },
            'queijo_mussarela': { name: 'Queijo Mussarela', protein: 22, carbs: 3.1, cals: 300, unit: '100g (fatia 30g)', visceralFat: true },
            'queijo_minas': { name: 'Queijo Minas Frescal', protein: 17, carbs: 3, cals: 264, unit: '100g', visceralFat: false },
            'iogurte_grego': { name: 'Iogurte Grego (natural)', protein: 10, carbs: 3.6, cals: 59, unit: '100g', visceralFat: false },
            'iogurte_natural': { name: 'Iogurte Natural Desnatado', protein: 4.1, carbs: 7, cals: 57, unit: '100g', visceralFat: false },
            'arroz_branco': { name: 'Arroz Branco (cozido)', protein: 2.7, carbs: 28, cals: 130, unit: '100g', visceralFat: false },
            'arroz_integral': { name: 'Arroz Integral (cozido)', protein: 2.6, carbs: 23, cals: 111, unit: '100g', visceralFat: false },
            'pao_forma': { name: 'Pão de Forma (Branco)', protein: 2.5, carbs: 15, cals: 80, unit: 'fatia', visceralFat: true },
            'pao_integral': { name: 'Pão de Forma (Integral)', protein: 3, carbs: 12, cals: 70, unit: 'fatia', visceralFat: false },
            'batata_doce': { name: 'Batata Doce (cozida)', protein: 1.6, carbs: 20, cals: 86, unit: '100g', visceralFat: false },
            'batata_inglesa': { name: 'Batata Inglesa (cozida)', protein: 2, carbs: 20, cals: 87, unit: '100g', visceralFat: false },
            'feijao_preto': { name: 'Feijão Preto (cozido)', protein: 9, carbs: 24, cals: 131, unit: '100g', visceralFat: false },
            'feijao_carioca': { name: 'Feijão Carioca (cozido)', protein: 4.8, carbs: 14, cals: 76, unit: '100g', visceralFat: false },
            'aveia': { name: 'Aveia em Flocos', protein: 17, carbs: 66, cals: 389, unit: '100g', visceralFat: false },
            'macarrao': { name: 'Macarrão (cozido)', protein: 5, carbs: 25, cals: 131, unit: '100g', visceralFat: false },
            'cuscuz': { name: 'Cuscuz (hidratado)', protein: 3.8, carbs: 23, cals: 112, unit: '100g', visceralFat: false },
            'tapioca': { name: 'Tapioca (goma)', protein: 0, carbs: 89, cals: 355, unit: '100g', visceralFat: false },
            'pasta_amendoim': { name: 'Pasta de Amendoim (integral)', protein: 25, carbs: 20, cals: 588, unit: '100g (colher 15g)', visceralFat: false },
            'azeite': { name: 'Azeite de Oliva', protein: 0, carbs: 0, cals: 119, unit: 'colher sopa', visceralFat: false },
            'castanha_caju': { name: 'Castanha de Caju', protein: 18, carbs: 30, cals: 553, unit: '100g', visceralFat: false },
            'amendoim': { name: 'Amendoim', protein: 26, carbs: 16, cals: 567, unit: '100g', visceralFat: false },
            'manteiga': { name: 'Manteiga com sal', protein: 0.9, carbs: 0.1, cals: 717, unit: '100g (colher 5g)', visceralFat: true },
            'refrigerante': { name: 'Refrigerante (Cola)', protein: 0, carbs: 26, cals: 105, unit: 'lata 350ml', visceralFat: true },
            'chocolate_ao_leite': { name: 'Chocolate ao Leite', protein: 8, carbs: 59, cals: 535, unit: '100g (barra 25g)', visceralFat: true },
            'biscoito_recheado': { name: 'Biscoito Recheado (Chocolate)', protein: 5, carbs: 70, cals: 450, unit: '100g (unid 10g)', visceralFat: true },
            'pizza_mussarela': { name: 'Pizza Mussarela', protein: 11, carbs: 33, cals: 271, unit: '100g (1 fatia)', visceralFat: true },
            'mel': { name: 'Mel', protein: 0.3, carbs: 82, cals: 304, unit: '100g', visceralFat: true },
            'cafe_preto': { name: 'Café Preto (sem açúcar)', protein: 0.1, carbs: 0, cals: 2, unit: 'xícara', visceralFat: false }
        };

        // ========== FUNÇÕES AUXILIARES ==========
        function getProfileDocRef() {
            return firebaseDb.collection('users').doc(userId).collection('data').doc('profile');
        }
        
        function getMetasDocRef() {
            return firebaseDb.collection('users').doc(userId).collection('data').doc('metas');
        }
        
        function getMealsDocRef() {
            return firebaseDb.collection('users').doc(userId).collection('data').doc('meals_today');
        }

        function showElement(el) { el.classList.remove('hidden'); }
        function hideElement(el) { el.classList.add('hidden'); }

        function showModal(modal, overlay) {
            showElement(overlay);
            showElement(modal);
            requestAnimationFrame(() => {
                modal.classList.remove('scale-90', 'opacity-0');
                modal.classList.add('scale-100', 'opacity-100');
            });
        }

        function hideModal(modal, overlay) {
            modal.classList.remove('scale-100', 'opacity-100');
            modal.classList.add('scale-90', 'opacity-0');
            setTimeout(() => {
                hideElement(modal);
                hideElement(overlay);
                clearRegistrationError();
            }, 300);
        }

        function showRegistrationError(message) {
            const errorEl = document.getElementById('registrationError');
            errorEl.textContent = message;
            showElement(errorEl);
        }

        function clearRegistrationError() {
            const errorEl = document.getElementById('registrationError');
            errorEl.textContent = '';
            hideElement(errorEl);
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function saveProfilePicLocally() {
            if (profilePicBase64) {
                localStorage.setItem(`profilePic_${userId}`, profilePicBase64);
                document.getElementById('profileImageDisplay').src = profilePicBase64;
                document.getElementById('modalProfileImage').src = profilePicBase64;
            }
        }
        
        function loadProfilePicLocally() {
            const localPic = localStorage.getItem(`profilePic_${userId}`);
            if (localPic) {
                profilePicBase64 = localPic;
                document.getElementById('profileImageDisplay').src = localPic;
                document.getElementById('modalProfileImage').src = localPic;
            }
        }

        // ========== FUNÇÕES DE PERFIL E METAS ==========
        async function loadProfileAndMetas() {
            try {
                const profileSnap = await getProfileDocRef().get();
                if (profileSnap.exists) {
                    const data = profileSnap.data();
                    document.getElementById('userNameDisplay').textContent = data.userName || 'Usuário';
                    document.getElementById('userNameInput').value = data.userName || '';
                    document.getElementById('phoneInput').value = data.phone || '';
                    loadProfilePicLocally();
                } else if (!isEditingProfile) {
                    showModal(document.getElementById('profileModal'), document.getElementById('profileModalOverlay'));
                    return;
                }
                
                const metasSnap = await getMetasDocRef().get();
                if (metasSnap.exists) {
                    const data = metasSnap.data();
                    document.getElementById('weight').value = data.weight || '';
                    document.getElementById('height').value = data.height || '';
                    document.getElementById('age').value = data.age || '';
                    document.getElementById('gender').value = data.gender || 'male';
                    document.getElementById('activity').value = data.activity || '1.55';
                    document.getElementById('goalType').value = data.goalType || 'ganhar';
                    calorieGoal = parseFloat(data.calorieGoal) || 0;
                    currentGoalType = data.goalType || 'ganhar';
                }

                updateGoalDisplay();
                updateMealSuggestion(); 
                
            } catch (error) {
                console.error("Erro ao carregar perfil/metas:", error);
                if (!isEditingProfile) {
                    showModal(document.getElementById('profileModal'), document.getElementById('profileModalOverlay'));
                }
            }
        }

        async function saveProfileData() {
            clearRegistrationError();
            const userName = document.getElementById('userNameInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            
            if (!userName) {
                showRegistrationError("Por favor, insira um nome de usuário.");
                return;
            }

            try {
                await getProfileDocRef().set({
                    userName: userName,
                    phone: phone,
                    userId: userId 
                });
                saveProfilePicLocally();
                
                document.getElementById('userNameDisplay').textContent = userName;
                
                hideModal(document.getElementById('profileModal'), document.getElementById('profileModalOverlay'));
                isEditingProfile = false;
                
                if (calorieGoal === 0) {
                    loadProfileAndMetas(); 
                }

            } catch (error) {
                console.error("Erro ao salvar perfil:", error);
                showRegistrationError("Erro ao salvar perfil. Verifique sua conexão.");
            }
        }

        async function saveMetas() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseFloat(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const activity = parseFloat(document.getElementById('activity').value);
            const goalType = document.getElementById('goalType').value; 
            const goalText = document.getElementById('goalText');

            if (isNaN(weight) || isNaN(height) || isNaN(age) || weight <= 0 || height <= 0 || age <= 0) {
                goalText.textContent = "Por favor, preencha todos os campos corretamente.";
                goalText.classList.remove('hidden', 'text-green-700');
                goalText.classList.add('text-red-600');
                return;
            }

            let bmr;
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            const tdee = bmr * activity;
            let finalGoal;
            switch (goalType) {
                case 'perder':
                    finalGoal = tdee - 400; 
                    break;
                case 'manter':
                    finalGoal = tdee; 
                    break;
                case 'ganhar':
                default:
                    finalGoal = tdee + 400; 
                    break;
            }
            calorieGoal = finalGoal;
            currentGoalType = goalType;

            try {
                await getMetasDocRef().set({
                    weight, height, age, gender, activity, goalType,
                    calorieGoal: finalGoal.toFixed(0)
                });
                
                updateGoalDisplay();
                updateTotals(false);
                updateMealSuggestion();
                renderFoodList();

            } catch (error) {
                console.error("Erro ao salvar metas:", error);
                goalText.textContent = "Erro ao salvar meta. Verifique sua conexão.";
                goalText.classList.remove('hidden', 'text-green-700');
                goalText.classList.add('text-red-600');
            }
        }

        function updateGoalDisplay() {
            const goalText = document.getElementById('goalText');
            if (calorieGoal > 0) {
                const goalType = document.getElementById('goalType').value || 'ganhar';
                const goalName = goalDisplayNames[goalType];
                goalText.textContent = `Sua meta (${goalName}): ${calorieGoal.toFixed(0)} kcal/dia`;
                goalText.classList.remove('hidden', 'text-red-600', 'text-gray-600');
                goalText.classList.add('text-green-700');
                
                document.getElementById('goalTag').textContent = goalName;
                showElement(document.getElementById('goalTag'));

            } else {
                goalText.textContent = "Clique em 'Calcular e Salvar Meta'.";
                goalText.classList.remove('hidden', 'text-green-700', 'text-red-600');
                goalText.classList.add('text-gray-600');
                hideElement(document.getElementById('goalTag'));
            }
        }
        
        function updateMealSuggestion() {
            const mealSuggestion = document.getElementById('mealSuggestion');
            if (calorieGoal === 0) {
                mealSuggestion.innerHTML = 'Preencha e salve suas metas acima para ver sugestões de refeições.';
                return;
            }
            const goalType = document.getElementById('goalType').value || 'ganhar';
            const mealTime = document.getElementById('mealTimeSelect').value || 'cafe_da_manha';
            const suggestionText = mealSuggestions[goalType][mealTime];
            mealSuggestion.innerHTML = `💡 <span class="font-semibold">Sugestão p/ ${goalDisplayNames[goalType]}:</span> ${suggestionText}`;
        }

        // ========== FUNÇÕES DE REFEIÇÕES ==========
        async function loadDailyLog() {
            try {
                const mealsSnap = await getMealsDocRef().get();

                if (mealsSnap.exists) {
                    const data = mealsSnap.data();
                    
                    if (data.date !== todayString) {
                        dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
                        await saveDailyLog();
                    } else {
                        dailyLog = data.meals || { cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
                    }
                } else {
                    dailyLog = { cafe_da_manha: [], almoco: [], lanche: [], jantar: [] };
                    await saveDailyLog();
                }
                
                renderFoodList();
                updateTotals(false);
                
            } catch (error) {
                console.error("Erro ao carregar refeições:", error);
            }
        }

        async function saveDailyLog() {
            try {
                await getMealsDocRef().set({
                    date: todayString,
                    meals: dailyLog
                });
            } catch (error) {
                console.error("Erro ao salvar refeições:", error);
            }
        }

        function addFoodToLog() {
            if (!selectedFoodKey) {
                alert("Por favor, selecione um alimento da lista.");
                return;
            }

            const quantity = parseFloat(document.getElementById('foodQuantity').value);
            const mealTime = document.getElementById('mealTimeSelect').value;

            if (isNaN(quantity) || quantity <= 0) {
                alert("Por favor, insira uma quantidade válida.");
                return;
            }

            const food = foodDatabase[selectedFoodKey];
            const totalProtein = (food.protein * quantity).toFixed(1);
            const totalCarbs = (food.carbs * quantity).toFixed(1);
            const totalCals = (food.cals * quantity).toFixed(0);

            const foodEntry = {
                key: selectedFoodKey,
                name: food.name,
                quantity: quantity,
                unit: food.unit,
                protein: parseFloat(totalProtein),
                carbs: parseFloat(totalCarbs),
                cals: parseFloat(totalCals),
                visceralFat: food.visceralFat,
                id: Date.now()
            };

            dailyLog[mealTime].push(foodEntry);
            saveDailyLog();
            renderFoodList();
            updateTotals(true);

            document.getElementById('foodSearch').value = '';
            document.getElementById('foodQuantity').value = '';
            selectedFoodKey = null;
            hideElement(document.getElementById('searchDropdown'));
        }

        function removeFoodFromLog(mealTime, foodId) {
            dailyLog[mealTime] = dailyLog[mealTime].filter(item => item.id !== foodId);
            saveDailyLog();
            renderFoodList();
            updateTotals(false);
        }

        function renderFoodList() {
            const foodList = document.getElementById('foodList');
            const emptyText = document.getElementById('emptyListText');
            
            let hasFood = false;
            let html = '';

            MEAL_KEYS.forEach(mealKey => {
                const meals = dailyLog[mealKey];
                if (meals && meals.length > 0) {
                    hasFood = true;
                    html += `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-700 mb-2 text-lg">${mealDisplayNames[mealKey]}</h4>
                            <div class="space-y-2">
                                ${meals.map(item => `
                                    <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                                        <div class="flex-grow">
                                            <p class="font-medium text-gray-800">${item.name}</p>
                                            <p class="text-sm text-gray-600">${item.quantity} ${item.unit} • ${item.cals} kcal</p>
                                            <p class="text-xs text-gray-500">P: ${item.protein}g | C: ${item.carbs}g ${item.visceralFat ? '⚠️' : ''}</p>
                                        </div>
                                        <button onclick="removeFoodFromLog('${mealKey}', ${item.id})" class="ml-2 text-red-600 hover:text-red-800 transition-colors">
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            if (hasFood) {
                hideElement(emptyText);
                foodList.innerHTML = html;
            } else {
                showElement(emptyText);
                foodList.innerHTML = '<p id="emptyListText" class="text-gray-400 text-center mt-4">Nenhum alimento adicionado ainda.</p>';
            }
        }

        function updateTotals(checkGoal = true) {
            let totalCals = 0;
            let totalProtein = 0;
            let totalCarbs = 0;

            MEAL_KEYS.forEach(mealKey => {
                dailyLog[mealKey].forEach(item => {
                    totalCals += item.cals;
                    totalProtein += item.protein;
                    totalCarbs += item.carbs;
                });
            });

            document.getElementById('totalProteins').textContent = totalProtein.toFixed(1) + ' g';
            document.getElementById('totalCarbs').textContent = totalCarbs.toFixed(1) + ' g';
            
            if (calorieGoal > 0) {
                document.getElementById('totalCalsGoalText').textContent = `${totalCals.toFixed(0)} / ${calorieGoal.toFixed(0)} kcal`;
                const percentage = Math.min((totalCals / calorieGoal) * 100, 100);
                document.getElementById('calorieProgress').style.width = percentage + '%';
                
                if (checkGoal && !goalExceededNotified && totalCals >= calorieGoal) {
                    goalExceededNotified = true;
                    showGoalExceededModal();
                }
            } else {
                document.getElementById('totalCalsGoalText').textContent = `${totalCals.toFixed(0)} kcal`;
                document.getElementById('calorieProgress').style.width = '0%';
            }
        }

        function showGoalExceededModal() {
            const modalGoalText = document.getElementById('modalGoalText');
            const goalType = document.getElementById('goalType').value || 'ganhar';
            modalGoalText.textContent = `Meta de ${goalDisplayNames[goalType]}: ${calorieGoal.toFixed(0)} kcal atingida!`;
            showModal(document.getElementById('warningModal'), document.getElementById('warningModalOverlay'));
        }

        // ========== FUNÇÕES DE BUSCA ==========
        function searchFood() {
            const query = document.getElementById('foodSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('searchDropdown');
            
            if (query.length < 2) {
                hideElement(dropdown);
                return;
            }

            const results = Object.keys(foodDatabase).filter(key => 
                foodDatabase[key].name.toLowerCase().includes(query) || key.includes(query)
            );

            if (results.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-gray-500 text-sm">Nenhum alimento encontrado</div>';
                showElement(dropdown);
                return;
            }

            const html = results.map(key => {
                const food = foodDatabase[key];
                return `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200" onclick="selectFood('${key}')">
                        <p class="font-medium text-gray-800">${food.name}</p>
                        <p class="text-xs text-gray-600">${food.cals} kcal por ${food.unit}</p>
                    </div>
                `;
            }).join('');

            dropdown.innerHTML = html;
            showElement(dropdown);
        }

        function selectFood(key) {
            selectedFoodKey = key;
            const food = foodDatabase[key];
            document.getElementById('foodSearch').value = food.name;
            hideElement(document.getElementById('searchDropdown'));
        }

        // ========== FUNÇÃO DE COMPARTILHAMENTO ==========
        function shareToWhatsApp() {
            let totalCals = 0;
            let totalProtein = 0;
            let totalCarbs = 0;

            MEAL_KEYS.forEach(mealKey => {
                dailyLog[mealKey].forEach(item => {
                    totalCals += item.cals;
                    totalProtein += item.protein;
                    totalCarbs += item.carbs;
                });
            });

            const userName = document.getElementById('userNameDisplay').textContent;
            const goalType = document.getElementById('goalType').value || 'ganhar';
            const goalName = goalDisplayNames[goalType];
            
            let message = `🏋️ *Fitness-Pro 2.0* - Resumo do Dia\n\n`;
            message += `👤 *${userName}*\n`;
            message += `🎯 *Objetivo:* ${goalName}\n`;
            message += `📊 *Meta:* ${calorieGoal.toFixed(0)} kcal\n\n`;
            message += `*Consumo do Dia:*\n`;
            message += `🔥 Calorias: ${totalCals.toFixed(0)} kcal\n`;
            message += `💪 Proteínas: ${totalProtein.toFixed(1)}g\n`;
            message += `🍞 Carboidratos: ${totalCarbs.toFixed(1)}g\n\n`;

            MEAL_KEYS.forEach(mealKey => {
                const meals = dailyLog[mealKey];
                if (meals && meals.length > 0) {
                    message += `*${mealDisplayNames[mealKey]}*\n`;
                    meals.forEach(item => {
                        message += `• ${item.name} (${item.quantity} ${item.unit}) - ${item.cals} kcal\n`;
                    });
                    message += `\n`;
                }
            });

            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function shareApp() {
            const message = `🏋️ *Fitness-Pro 2.0*\n\nConheça o aplicativo que está me ajudando a alcançar meus objetivos fitness! 💪\n\nAcesse: ${window.location.href}`;
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // ========== INICIALIZAÇÃO ==========
        async function initializeApp() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.firestore();

                await firebaseAuth.signInAnonymously();
                userId = firebaseAuth.currentUser.uid;

                await loadProfileAndMetas();
                await loadDailyLog();

                hideElement(document.getElementById('loadingScreen'));
                showElement(document.getElementById('mainApp'));

            } catch (error) {
                console.error("Erro na inicialização:", error);
                document.getElementById('loadingScreen').innerHTML = `
                    <p class="text-red-600 font-semibold">Erro ao conectar com o servidor</p>
                    <p class="text-gray-600 mt-2">Verifique sua conexão e recarregue a página</p>
                    <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">
                        Tentar Novamente
                    </button>
                `;
            }
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();

            // Perfil
            document.getElementById('editProfileButton').addEventListener('click', () => {
                isEditingProfile = true;
                document.getElementById('modalTitle').textContent = 'Editar Perfil';
                showModal(document.getElementById('profileModal'), document.getElementById('profileModalOverlay'));
            });

            document.getElementById('saveProfileButton').addEventListener('click', saveProfileData);

            document.getElementById('profilePicInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    profilePicBase64 = await fileToBase64(file);
                    document.getElementById('modalProfileImage').src = profilePicBase64;
                }
            });

            // Metas
            document.getElementById('calculateButton').addEventListener('click', saveMetas);
            
            document.getElementById('goalType').addEventListener('change', updateMealSuggestion);
            document.getElementById('mealTimeSelect').addEventListener('change', updateMealSuggestion);

            // Busca de alimentos
            document.getElementById('foodSearch').addEventListener('input', searchFood);
            document.getElementById('addFoodButton').addEventListener('click', addFoodToLog);

            // Compartilhamento
            document.getElementById('shareButton').addEventListener('click', shareToWhatsApp);
            document.getElementById('shareAppButton').addEventListener('click', shareApp);

            // Modal de aviso
            document.getElementById('closeWarningModalButton').addEventListener('click', () => {
                hideModal(document.getElementById('warningModal'), document.getElementById('warningModalOverlay'));
            });

            // Fechar dropdown ao clicar fora
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#foodSearch') && !e.target.closest('#searchDropdown')) {
                    hideElement(document.getElementById('searchDropdown'));
                }
            });
        });
    </script>
</body>
</html>
